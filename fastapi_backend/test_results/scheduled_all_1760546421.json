{
  "id": "scheduled_all_1760546421",
  "timestamp": "2025-10-15T09:41:15.847517",
  "test_type": "all",
  "status": "completed",
  "total_tests": 402,
  "passed_tests": 256,
  "failed_tests": 146,
  "duration": 53.87126898765564,
  "output": "Frontend: \n> frontend@0.1.0 test\n> react-scripts test --watchAll=false --passWithNoTests\n\nPASS src/__tests__/api.test.js\nFAIL src/components/__tests__/Sidebar.test.js\n  \u25cf Test suite failed to run\n\n    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')\n\n      26 | mockAxios.put.mockResolvedValue({ data: {} });\n      27 | mockAxios.delete.mockResolvedValue({ data: {} });\n    > 28 | mockAxios.patch.mockResolvedValue({ data: {} });\n         |                 ^\n      29 | mockAxios.head.mockResolvedValue({ data: {} });\n      30 | mockAxios.options.mockResolvedValue({ data: {} });\n      31 |\n\n      at Object.<anonymous> (src/__mocks__/axios.js:28:17)\n      at Object.<anonymous> (src/api.js:2:1)\n      at Object.<anonymous> (src/components/Sidebar.js:3:1)\n      at Object.<anonymous> (src/components/__tests__/Sidebar.test.js:18:1)\n\nPASS src/components/__tests__/Profile.test.js\n  \u25cf Console\n\n    console.log\n      \u2705 WebSocket listeners initialized for online status\n\n      at OnlineStatusService.initializeWebSocket (src/services/onlineStatusService.js:60:15)\n\n    console.log\n      \ud83d\udccd Profile component loaded for username: testuser\n\n      at Profile (src/components/Profile.js:26:11)\n\n    console.log\n      \ud83d\udcca Fetching KPI stats for: testuser\n\n      at fetchKPIStats (src/components/Profile.js:164:15)\n\n    console.log\n      \ud83d\udcca Views Response: {\n        username: 'testuser',\n        firstName: 'Test',\n        lastName: 'User',\n        contactEmail: 'test@example.com',\n        contactNumber: '555-123-4567',\n        location: 'New York, NY',\n        education: \"Bachelor's Degree\",\n        dob: null,\n        sex: '',\n        height: '',\n        castePreference: '',\n        eatingPreference: '',\n        workingStatus: '',\n        workplace: '',\n        citizenshipStatus: '',\n        familyBackground: '',\n        aboutYou: '',\n        partnerPreference: '',\n        createdAt: null,\n        updatedAt: null,\n        images: []\n      }\n\n      at fetchKPIStats (src/components/Profile.js:172:15)\n\n    console.log\n      \ud83d\udcca Shortlist Response: {\n        username: 'testuser',\n        firstName: 'Test',\n        lastName: 'User',\n        contactEmail: 'test@example.com',\n        contactNumber: '555-123-4567',\n        location: 'New York, NY',\n        education: \"Bachelor's Degree\",\n        dob: null,\n        sex: '',\n        height: '',\n        castePreference: '',\n        eatingPreference: '',\n        workingStatus: '',\n        workplace: '',\n        citizenshipStatus: '',\n        familyBackground: '',\n        aboutYou: '',\n        partnerPreference: '',\n        createdAt: null,\n        updatedAt: null,\n        images: []\n      }\n\n      at fetchKPIStats (src/components/Profile.js:173:15)\n\n    console.log\n      \ud83d\udcca Favorites Response: {\n        username: 'testuser',\n        firstName: 'Test',\n        lastName: 'User',\n        contactEmail: 'test@example.com',\n        contactNumber: '555-123-4567',\n        location: 'New York, NY',\n        education: \"Bachelor's Degree\",\n        dob: null,\n        sex: '',\n        height: '',\n        castePreference: '',\n        eatingPreference: '',\n        workingStatus: '',\n        workplace: '',\n        citizenshipStatus: '',\n        familyBackground: '',\n        aboutYou: '',\n        partnerPreference: '',\n        createdAt: null,\n        updatedAt: null,\n        images: []\n      }\n\n      at fetchKPIStats (src/components/Profile.js:174:15)\n\n    console.log\n      \ud83d\udcca Parsed KPI stats: { profileViews: 0, shortlistedBy: 0, favoritedBy: 0 }\n\n      at fetchKPIStats (src/components/Profile.js:182:15)\n\n    console.log\n      \ud83d\udccd Profile component loaded for username: testuser\n\n      at Profile (src/components/Profile.js:26:11)\n\n    console.log\n      \ud83d\udccd Profile component loaded for username: testuser\n\n      at Profile (src/components/Profile.js:26:11)\n\n    console.log\n      \ud83d\udcca Fetching KPI stats for: testuser\n\n      at fetchKPIStats (src/components/Profile.js:164:15)\n\n    console.log\n      \ud83d\udcca Views Response: null\n\n      at fetchKPIStats (src/components/Profile.js:172:15)\n\n    console.log\n      \ud83d\udcca Shortlist Response: null\n\n      at fetchKPIStats (src/components/Profile.js:173:15)\n\n    console.log\n      \ud83d\udcca Favorites Response: null\n\n      at fetchKPIStats (src/components/Profile.js:174:15)\n\n    console.log\n      \ud83d\udcca Parsed KPI stats: { profileViews: 0, shortlistedBy: 0, favoritedBy: 0 }\n\n      at fetchKPIStats (src/components/Profile.js:182:15)\n\n    console.log\n      \ud83d\udccd Profile component loaded for username: testuser\n\n      at Profile (src/components/Profile.js:26:11)\n\n    console.log\n      \ud83d\udccd Profile component loaded for username: testuser\n\n      at Profile (src/components/Profile.js:26:11)\n\n    console.log\n      \ud83d\udccd Profile component loaded for username: testuser\n\n      at Profile (src/components/Profile.js:26:11)\n\n    console.log\n      \ud83d\udccd Profile component loaded for username: testuser\n\n      at Profile (src/components/Profile.js:26:11)\n\nPASS src/components/__tests__/Login.test.js\nFAIL src/components/__tests__/SearchPage.test.js\n  \u25cf Console\n\n    console.log\n      \u2705 WebSocket listeners initialized for online status\n\n      at OnlineStatusService.initializeWebSocket (src/services/onlineStatusService.js:60:15)\n\n  \u25cf SearchPage Component \u203a renders search form\n\n    TypeError: navigate is not a function\n\n      86 |     const username = localStorage.getItem('username');\n      87 |     if (!username) {\n    > 88 |       navigate('/login');\n         |       ^\n      89 |       return;\n      90 |     }\n      91 |     \n\n      at src/components/SearchPage.js:88:7\n      at Object.react_stack_bottom_frame (node_modules/react-dom/cjs/react-dom-client.development.js:25989:20)\n      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)\n      at commitHookEffectListMount (node_modules/react-dom/cjs/react-dom-client.development.js:13249:29)\n      at commitHookPassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:13336:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15484:13)\n      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15519:11)\n      at flushPassiveEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18432:9)\n      at node_modules/react-dom/cjs/react-dom-client.development.js:17923:15\n      at flushActQueue (node_modules/react/cjs/react.development.js:590:34)\n      at Object.<anonymous>.process.env.NODE_ENV.exports.act (node_modules/react/cjs/react.development.js:884:10)\n      at node_modules/@testing-library/react/dist/act-compat.js:47:25\n      at renderRoot (node_modules/@testing-library/react/dist/pure.js:190:26)\n      at render (node_modules/@testing-library/react/dist/pure.js:292:10)\n      at Object.<anonymous> (src/components/__tests__/SearchPage.test.js:37:11)\n\n  \u25cf SearchPage Component \u203a allows user to type in search input\n\n    TypeError: navigate is not a function\n\n      86 |     const username = localStorage.getItem('username');\n      87 |     if (!username) {\n    > 88 |       navigate('/login');\n         |       ^\n      89 |       return;\n      90 |     }\n      91 |     \n\n      at src/components/SearchPage.js:88:7\n      at Object.react_stack_bottom_frame (node_modules/react-dom/cjs/react-dom-client.development.js:25989:20)\n      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)\n      at commitHookEffectListMount (node_modules/react-dom/cjs/react-dom-client.development.js:13249:29)\n      at commitHookPassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:13336:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15484:13)\n      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15519:11)\n      at flushPassiveEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18432:9)\n      at node_modules/react-dom/cjs/react-dom-client.development.js:17923:15\n      at flushActQueue (node_modules/react/cjs/react.development.js:590:34)\n      at Object.<anonymous>.process.env.NODE_ENV.exports.act (node_modules/react/cjs/react.development.js:884:10)\n      at node_modules/@testing-library/react/dist/act-compat.js:47:25\n      at renderRoot (node_modules/@testing-library/react/dist/pure.js:190:26)\n      at render (node_modules/@testing-library/react/dist/pure.js:292:10)\n      at Object.<anonymous> (src/components/__tests__/SearchPage.test.js:45:11)\n\n  \u25cf SearchPage Component \u203a displays search filters\n\n    TypeError: navigate is not a function\n\n      86 |     const username = localStorage.getItem('username');\n      87 |     if (!username) {\n    > 88 |       navigate('/login');\n         |       ^\n      89 |       return;\n      90 |     }\n      91 |     \n\n      at src/components/SearchPage.js:88:7\n      at Object.react_stack_bottom_frame (node_modules/react-dom/cjs/react-dom-client.development.js:25989:20)\n      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)\n      at commitHookEffectListMount (node_modules/react-dom/cjs/react-dom-client.development.js:13249:29)\n      at commitHookPassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:13336:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15484:13)\n      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15519:11)\n      at flushPassiveEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18432:9)\n      at node_modules/react-dom/cjs/react-dom-client.development.js:17923:15\n      at flushActQueue (node_modules/react/cjs/react.development.js:590:34)\n      at Object.<anonymous>.process.env.NODE_ENV.exports.act (node_modules/react/cjs/react.development.js:884:10)\n      at node_modules/@testing-library/react/dist/act-compat.js:47:25\n      at renderRoot (node_modules/@testing-library/react/dist/pure.js:190:26)\n      at render (node_modules/@testing-library/react/dist/pure.js:292:10)\n      at Object.<anonymous> (src/components/__tests__/SearchPage.test.js:54:11)\n\n  \u25cf SearchPage Component \u203a displays search results section\n\n    TypeError: navigate is not a function\n\n      86 |     const username = localStorage.getItem('username');\n      87 |     if (!username) {\n    > 88 |       navigate('/login');\n         |       ^\n      89 |       return;\n      90 |     }\n      91 |     \n\n      at src/components/SearchPage.js:88:7\n      at Object.react_stack_bottom_frame (node_modules/react-dom/cjs/react-dom-client.development.js:25989:20)\n      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)\n      at commitHookEffectListMount (node_modules/react-dom/cjs/react-dom-client.development.js:13249:29)\n      at commitHookPassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:13336:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15484:13)\n      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15519:11)\n      at flushPassiveEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18432:9)\n      at node_modules/react-dom/cjs/react-dom-client.development.js:17923:15\n      at flushActQueue (node_modules/react/cjs/react.development.js:590:34)\n      at Object.<anonymous>.process.env.NODE_ENV.exports.act (node_modules/react/cjs/react.development.js:884:10)\n      at node_modules/@testing-library/react/dist/act-compat.js:47:25\n      at renderRoot (node_modules/@testing-library/react/dist/pure.js:190:26)\n      at render (node_modules/@testing-library/react/dist/pure.js:292:10)\n      at Object.<anonymous> (src/components/__tests__/SearchPage.test.js:61:11)\n\n  \u25cf SearchPage Component \u203a shows no results message when no users found\n\n    TypeError: navigate is not a function\n\n      86 |     const username = localStorage.getItem('username');\n      87 |     if (!username) {\n    > 88 |       navigate('/login');\n         |       ^\n      89 |       return;\n      90 |     }\n      91 |     \n\n      at src/components/SearchPage.js:88:7\n      at Object.react_stack_bottom_frame (node_modules/react-dom/cjs/react-dom-client.development.js:25989:20)\n      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)\n      at commitHookEffectListMount (node_modules/react-dom/cjs/react-dom-client.development.js:13249:29)\n      at commitHookPassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:13336:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15484:13)\n      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15519:11)\n      at flushPassiveEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18432:9)\n      at node_modules/react-dom/cjs/react-dom-client.development.js:17923:15\n      at flushActQueue (node_modules/react/cjs/react.development.js:590:34)\n      at Object.<anonymous>.process.env.NODE_ENV.exports.act (node_modules/react/cjs/react.development.js:884:10)\n      at node_modules/@testing-library/react/dist/act-compat.js:47:25\n      at renderRoot (node_modules/@testing-library/react/dist/pure.js:190:26)\n      at render (node_modules/@testing-library/react/dist/pure.js:292:10)\n      at Object.<anonymous> (src/components/__tests__/SearchPage.test.js:67:11)\n\n  \u25cf SearchPage Component \u203a displays saved searches section\n\n    TypeError: navigate is not a function\n\n      86 |     const username = localStorage.getItem('username');\n      87 |     if (!username) {\n    > 88 |       navigate('/login');\n         |       ^\n      89 |       return;\n      90 |     }\n      91 |     \n\n      at src/components/SearchPage.js:88:7\n      at Object.react_stack_bottom_frame (node_modules/react-dom/cjs/react-dom-client.development.js:25989:20)\n      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)\n      at commitHookEffectListMount (node_modules/react-dom/cjs/react-dom-client.development.js:13249:29)\n      at commitHookPassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:13336:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15484:13)\n      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)\n      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15519:11)\n      at flushPassiveEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18432:9)\n      at node_modules/react-dom/cjs/react-dom-client.development.js:17923:15\n      at flushActQueue (node_modules/react/cjs/react.development.js:590:34)\n      at Object.<anonymous>.process.env.NODE_ENV.exports.act (node_modules/react/cjs/react.development.js:884:10)\n      at node_modules/@testing-library/react/dist/act-compat.js:47:25\n      at renderRoot (node_modules/@testing-library/react/dist/pure.js:190:26)\n      at render (node_modules/@testing-library/react/dist/pure.js:292:10)\n      at Object.<anonymous> (src/components/__tests__/SearchPage.test.js:74:11)\n\nTest Suites: 2 failed, 3 passed, 5 total\nTests:       6 failed, 10 passed, 16 total\nSnapshots:   0 total\nTime:        3.898 s, estimated 4 s\nRan all test suites.\n\nBackend: ........FFFFFFFF........................................................ [ 17%]\n...................................F....................FFFF.F.......... [ 35%]\n....F.........FF..FFFFFFFFFFFFFFF.FF.FFF..FFFF.FF....................... [ 52%]\n.................................FFFFFFFFFFFFFFFFFFFFFF.FFFFFFFFFFFF.FFF [ 70%]\nFFFF.F..FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF.FFFFFFFF.FFFF.FFFFFFFFFFF.. [ 87%]\n.F.........F.......................sssssssss.......                      [100%]\n=================================== FAILURES ===================================\n_____ TestJWTTokenFunctions.test_create_access_token_with_custom_settings ______\n\nargs = (<test_auth.TestJWTTokenFunctions object at 0x10da083b0>,), keywargs = {}\n\n    @wraps(func)\n    def patched(*args, **keywargs):\n>       with self.decoration_helper(patched,\n                                    args,\n                                    keywargs) as (newargs, newkeywargs):\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1384: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:137: in __enter__\n    return next(self.gen)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1366: in decoration_helper\n    arg = exit_stack.enter_context(patching)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:526: in enter_context\n    result = _enter(cm)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1455: in __enter__\n    original, local = self.get_original()\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <unittest.mock._patch object at 0x10d962930>\n\n    def get_original(self):\n        target = self.getter()\n        name = self.attribute\n    \n        original = DEFAULT\n        local = False\n    \n        try:\n            original = target.__dict__[name]\n        except (AttributeError, KeyError):\n            original = getattr(target, name, DEFAULT)\n        else:\n            local = True\n    \n        if name in _builtins and isinstance(target, ModuleType):\n            self.create = True\n    \n        if not self.create and original is DEFAULT:\n>           raise AttributeError(\n                \"%s does not have the attribute %r\" % (target, name)\n            )\nE           AttributeError: <module 'auth' from '/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/__init__.py'> does not have the attribute 'settings'\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1428: AttributeError\n_____________ TestGetCurrentUser.test_get_current_user_valid_token _____________\n\nself = <Coroutine test_get_current_user_valid_token>\n\n    def runtest(self) -> None:\n        self.obj = wrap_in_sync(\n            # https://github.com/pytest-dev/pytest-asyncio/issues/596\n            self.obj,  # type: ignore[has-type]\n        )\n>       super().runtest()\n\nvenv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:440: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:907: in inner\n    _loop.run_until_complete(task)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:685: in run_until_complete\n    return future.result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1401: in patched\n    with self.decoration_helper(patched,\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:137: in __enter__\n    return next(self.gen)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1366: in decoration_helper\n    arg = exit_stack.enter_context(patching)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:526: in enter_context\n    result = _enter(cm)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1455: in __enter__\n    original, local = self.get_original()\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <unittest.mock._patch object at 0x10d9633e0>\n\n    def get_original(self):\n        target = self.getter()\n        name = self.attribute\n    \n        original = DEFAULT\n        local = False\n    \n        try:\n            original = target.__dict__[name]\n        except (AttributeError, KeyError):\n            original = getattr(target, name, DEFAULT)\n        else:\n            local = True\n    \n        if name in _builtins and isinstance(target, ModuleType):\n            self.create = True\n    \n        if not self.create and original is DEFAULT:\n>           raise AttributeError(\n                \"%s does not have the attribute %r\" % (target, name)\n            )\nE           AttributeError: <module 'auth' from '/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/__init__.py'> does not have the attribute 'settings'\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1428: AttributeError\n____________ TestGetCurrentUser.test_get_current_user_invalid_token ____________\n\nargs = (<test_auth.TestGetCurrentUser object at 0x10da088c0>,), keywargs = {}\n\n    @wraps(func)\n    def patched(*args, **keywargs):\n>       with self.decoration_helper(patched,\n                                    args,\n                                    keywargs) as (newargs, newkeywargs):\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1384: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:137: in __enter__\n    return next(self.gen)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1366: in decoration_helper\n    arg = exit_stack.enter_context(patching)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:526: in enter_context\n    result = _enter(cm)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1455: in __enter__\n    original, local = self.get_original()\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <unittest.mock._patch object at 0x10d963650>\n\n    def get_original(self):\n        target = self.getter()\n        name = self.attribute\n    \n        original = DEFAULT\n        local = False\n    \n        try:\n            original = target.__dict__[name]\n        except (AttributeError, KeyError):\n            original = getattr(target, name, DEFAULT)\n        else:\n            local = True\n    \n        if name in _builtins and isinstance(target, ModuleType):\n            self.create = True\n    \n        if not self.create and original is DEFAULT:\n>           raise AttributeError(\n                \"%s does not have the attribute %r\" % (target, name)\n            )\nE           AttributeError: <module 'auth' from '/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/__init__.py'> does not have the attribute 'settings'\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1428: AttributeError\n____________ TestGetCurrentUser.test_get_current_user_expired_token ____________\n\nargs = (<test_auth.TestGetCurrentUser object at 0x10da08920>,), keywargs = {}\n\n    @wraps(func)\n    def patched(*args, **keywargs):\n>       with self.decoration_helper(patched,\n                                    args,\n                                    keywargs) as (newargs, newkeywargs):\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1384: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:137: in __enter__\n    return next(self.gen)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1366: in decoration_helper\n    arg = exit_stack.enter_context(patching)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:526: in enter_context\n    result = _enter(cm)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1455: in __enter__\n    original, local = self.get_original()\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <unittest.mock._patch object at 0x10d963770>\n\n    def get_original(self):\n        target = self.getter()\n        name = self.attribute\n    \n        original = DEFAULT\n        local = False\n    \n        try:\n            original = target.__dict__[name]\n        except (AttributeError, KeyError):\n            original = getattr(target, name, DEFAULT)\n        else:\n            local = True\n    \n        if name in _builtins and isinstance(target, ModuleType):\n            self.create = True\n    \n        if not self.create and original is DEFAULT:\n>           raise AttributeError(\n                \"%s does not have the attribute %r\" % (target, name)\n            )\nE           AttributeError: <module 'auth' from '/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/__init__.py'> does not have the attribute 'settings'\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1428: AttributeError\n_______________ TestGetCurrentUser.test_get_current_user_no_sub ________________\n\nargs = (<test_auth.TestGetCurrentUser object at 0x10da08a40>,), keywargs = {}\n\n    @wraps(func)\n    def patched(*args, **keywargs):\n>       with self.decoration_helper(patched,\n                                    args,\n                                    keywargs) as (newargs, newkeywargs):\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1384: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:137: in __enter__\n    return next(self.gen)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1366: in decoration_helper\n    arg = exit_stack.enter_context(patching)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:526: in enter_context\n    result = _enter(cm)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1455: in __enter__\n    original, local = self.get_original()\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <unittest.mock._patch object at 0x10d963890>\n\n    def get_original(self):\n        target = self.getter()\n        name = self.attribute\n    \n        original = DEFAULT\n        local = False\n    \n        try:\n            original = target.__dict__[name]\n        except (AttributeError, KeyError):\n            original = getattr(target, name, DEFAULT)\n        else:\n            local = True\n    \n        if name in _builtins and isinstance(target, ModuleType):\n            self.create = True\n    \n        if not self.create and original is DEFAULT:\n>           raise AttributeError(\n                \"%s does not have the attribute %r\" % (target, name)\n            )\nE           AttributeError: <module 'auth' from '/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/__init__.py'> does not have the attribute 'settings'\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1428: AttributeError\n____________ TestGetCurrentUser.test_get_current_user_wrong_secret _____________\n\nargs = (<test_auth.TestGetCurrentUser object at 0x10da08b60>,), keywargs = {}\n\n    @wraps(func)\n    def patched(*args, **keywargs):\n>       with self.decoration_helper(patched,\n                                    args,\n                                    keywargs) as (newargs, newkeywargs):\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1384: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:137: in __enter__\n    return next(self.gen)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1366: in decoration_helper\n    arg = exit_stack.enter_context(patching)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:526: in enter_context\n    result = _enter(cm)\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1455: in __enter__\n    original, local = self.get_original()\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <unittest.mock._patch object at 0x10d9639b0>\n\n    def get_original(self):\n        target = self.getter()\n        name = self.attribute\n    \n        original = DEFAULT\n        local = False\n    \n        try:\n            original = target.__dict__[name]\n        except (AttributeError, KeyError):\n            original = getattr(target, name, DEFAULT)\n        else:\n            local = True\n    \n        if name in _builtins and isinstance(target, ModuleType):\n            self.create = True\n    \n        if not self.create and original is DEFAULT:\n>           raise AttributeError(\n                \"%s does not have the attribute %r\" % (target, name)\n            )\nE           AttributeError: <module 'auth' from '/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/__init__.py'> does not have the attribute 'settings'\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1428: AttributeError\n____________ TestIntegrationScenarios.test_full_authentication_flow ____________\n\nself = <test_auth.TestIntegrationScenarios object at 0x10da08e90>\n\n    def test_full_authentication_flow(self):\n        \"\"\"Test complete authentication flow.\"\"\"\n        # 1. Hash a password\n        password = \"testpassword123\"\n        hashed = PasswordManager.hash_password(password)\n    \n        # 2. Verify the password\n        assert PasswordManager.verify_password(password, hashed) is True\n    \n        # 3. Create a token for the user with mocked settings\n>       with patch('auth.settings') as mock_settings:\n\ntests/test_auth.py:218: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1455: in __enter__\n    original, local = self.get_original()\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <unittest.mock._patch object at 0x10dcca0c0>\n\n    def get_original(self):\n        target = self.getter()\n        name = self.attribute\n    \n        original = DEFAULT\n        local = False\n    \n        try:\n            original = target.__dict__[name]\n        except (AttributeError, KeyError):\n            original = getattr(target, name, DEFAULT)\n        else:\n            local = True\n    \n        if name in _builtins and isinstance(target, ModuleType):\n            self.create = True\n    \n        if not self.create and original is DEFAULT:\n>           raise AttributeError(\n                \"%s does not have the attribute %r\" % (target, name)\n            )\nE           AttributeError: <module 'auth' from '/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/__init__.py'> does not have the attribute 'settings'\n\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1428: AttributeError\n__________ TestIntegrationScenarios.test_password_security_edge_cases __________\n\nself = <test_auth.TestIntegrationScenarios object at 0x10da08b30>\n\n    def test_password_security_edge_cases(self):\n        \"\"\"Test password security edge cases.\"\"\"\n        # Test empty password validation at model level\n        with pytest.raises(Exception):\n            UserCreate(username=\"testuser\", password=\"\")\n    \n        # Test very long password (bcrypt handles up to 72 bytes)\n        very_long_password = \"a\" * 200\n>       hashed = get_password_hash(very_long_password)\nE       NameError: name 'get_password_hash' is not defined\n\ntests/test_auth.py:238: NameError\n_________ TestPasswordPolicyIntegration.test_password_expiry_workflow __________\n\nself = <test_auth_module.TestPasswordPolicyIntegration object at 0x10daace90>\n\n    def test_password_expiry_workflow(self):\n        \"\"\"Test complete password expiry workflow\"\"\"\n        # Create password\n        password = \"SecurePass123!\"\n        hashed = PasswordManager.hash_password(password)\n    \n        # Set expiry\n        changed_at = datetime.utcnow()\n        expires_at = PasswordManager.calculate_password_expiry(changed_at)\n    \n        # Check not expired\n        assert PasswordManager.is_password_expired(expires_at) is False\n    \n        # Check days until expiry\n        days_left = PasswordManager.get_days_until_expiry(expires_at)\n>       assert days_left == security_settings.PASSWORD_EXPIRY_DAYS\nE       AssertionError: assert 89 == 90\nE        +  where 90 = SecuritySettings(JWT_SECRET_KEY='your-secret-key-change-in-production', JWT_ALGORITHM='HS256', JWT_ACCESS_TOKEN_EXPIRE...ED_ATTEMPTS_PER_IP=20, DEFAULT_USER_ROLE='free_user', SYSTEM_ROLES=['admin', 'moderator', 'premium_user', 'free_user']).PASSWORD_EXPIRY_DAYS\n\ntests/test_auth_module.py:391: AssertionError\n___________________________ test_full_user_lifecycle ___________________________\n\ntest_client = <starlette.testclient.TestClient object at 0x10e1e2660>\n\n    def test_full_user_lifecycle(test_client):\n        \"\"\"Test complete user lifecycle: register -> login -> profile -> update -> delete.\"\"\"\n        # 1. Register user\n        user_data = {\n            \"username\": \"lifecycle_user\",\n            \"password\": \"testpass123\",\n            \"firstName\": \"Lifecycle\",\n            \"lastName\": \"Test\",\n            \"contactEmail\": \"lifecycle@example.com\",\n            \"contactNumber\": \"1234567890\",\n            \"dob\": \"1990-01-01\",\n            \"sex\": \"Male\",\n            \"height\": \"5'8\\\"\",\n            \"location\": \"Test City\",\n            \"education\": \"Bachelor's Degree\",\n            \"workingStatus\": \"Employed\",\n            \"citizenshipStatus\": \"Citizen\"\n        }\n    \n        response = test_client.post(\"/api/users/register\", data=user_data)\n>       assert response.status_code == 201\nE       assert 422 == 201\nE        +  where 422 = <Response [422 Unprocessable Entity]>.status_code\n\ntests/test_e2e_api.py:70: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:41,378 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:41,381 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\n2025-10-15 09:40:41,382 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n__________________________ test_pii_masking_workflow ___________________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_e2e_api.py\", line 149, in test_pii_masking_workflow\n    |     profile_response = test_client.get(\"/api/users/profile/pii_user1\",\n    |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    |     user = await db.users.find_one({\"username\": username})\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\ntest_client = <starlette.testclient.TestClient object at 0x10e1d01a0>\n\n    def test_pii_masking_workflow(test_client):\n        \"\"\"Test complete PII masking workflow.\"\"\"\n        # Register two users\n        user1_data = {\n            \"username\": \"pii_user1\",\n            \"password\": \"testpass123\",\n            \"firstName\": \"PII\",\n            \"lastName\": \"User1\",\n            \"contactEmail\": \"pii1@example.com\",\n            \"contactNumber\": \"555-123-4567\",\n            \"location\": \"123 Main St, New York, NY\",\n            \"workplace\": \"Google Inc, Mountain View\"\n        }\n    \n        user2_data = user1_data.copy()\n        user2_data[\"username\"] = \"pii_user2\"\n        user2_data[\"contactEmail\"] = \"pii2@example.com\"\n        user2_data[\"contactNumber\"] = \"555-987-6543\"\n    \n        test_client.post(\"/api/users/register\", data=user1_data)\n        test_client.post(\"/api/users/register\", data=user2_data)\n    \n        # Get user1's profile as user2 (should be masked)\n>       profile_response = test_client.get(\"/api/users/profile/pii_user1\",\n                                           params={\"requester\": \"pii_user2\"})\n\ntests/test_e2e_api.py:149: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'pii_user1', requester = 'pii_user2'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/profile/{username}\")\n    async def get_user_profile(username: str, requester: str = None, db = Depends(get_database)):\n        \"\"\"Get user profile by username with PII masking\"\"\"\n        logger.info(f\"\ud83d\udc64 Profile request for username: {username} (requester: {requester})\")\n    \n        # Find user\n        logger.debug(f\"Fetching profile for user '{username}'...\")\n>       user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:484: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:41,394 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:41,395 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:41,396 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:41,397 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:41,398 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:41,399 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:41,400 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/profile/pii_user1\n2025-10-15 09:40:41,400 - routes - INFO - \ud83d\udc64 Profile request for username: pii_user1 (requester: pii_user2)\n2025-10-15 09:40:41,401 - main - ERROR - \u274c Error processing GET /api/users/profile/pii_user1 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/profile/pii_user1\nINFO     routes:routes.py:480 \ud83d\udc64 Profile request for username: pii_user1 (requester: pii_user2)\nERROR    main:main.py:131 \u274c Error processing GET /api/users/profile/pii_user1 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n__________________________ test_search_and_filtering ___________________________\n\ntest_client = <starlette.testclient.TestClient object at 0x10e2093d0>\n\n    def test_search_and_filtering(test_client):\n        \"\"\"Test search functionality with various filters.\"\"\"\n        # Register multiple users with different attributes\n        users_data = [\n            {\n                \"username\": \"search_user1\",\n                \"password\": \"testpass123\",\n                \"firstName\": \"John\",\n                \"lastName\": \"Doe\",\n                \"sex\": \"Male\",\n                \"location\": \"New York, NY\",\n                \"education\": \"Bachelor's Degree\"\n            },\n            {\n                \"username\": \"search_user2\",\n                \"password\": \"testpass123\",\n                \"firstName\": \"Jane\",\n                \"lastName\": \"Smith\",\n                \"sex\": \"Female\",\n                \"location\": \"Los Angeles, CA\",\n                \"education\": \"Master's Degree\"\n            },\n            {\n                \"username\": \"search_user3\",\n                \"password\": \"testpass123\",\n                \"firstName\": \"Bob\",\n                \"lastName\": \"Johnson\",\n                \"sex\": \"Male\",\n                \"location\": \"New York, NY\",\n                \"education\": \"PhD\"\n            }\n        ]\n    \n        for user_data in users_data:\n            test_client.post(\"/api/users/register\", data=user_data)\n    \n        # Test keyword search\n        keyword_response = test_client.get(\"/api/users/search\", params={\"keyword\": \"John\"})\n>       assert keyword_response.status_code == 200\nE       assert 500 == 200\nE        +  where 500 = <Response [500 Internal Server Error]>.status_code\n\ntests/test_e2e_api.py:228: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:41,736 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:41,737 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:41,739 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:41,740 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:41,741 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:41,742 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:41,743 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:41,744 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:41,745 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:41,746 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/search\n2025-10-15 09:40:41,747 - routes - INFO - \ud83d\udd0d Search request - keyword: 'John', status_filter: '', page: 1, limit: 20\n2025-10-15 09:40:41,747 - routes - INFO - \ud83d\udd0d Executing search with query: {'status.status': {'$regex': '^active$', '$options': 'i'}, '$or': [{'firstName': {'$regex': 'John', '$options': 'i'}}, {'lastName': {'$regex': 'John', '$options': 'i'}}, {'username': {'$regex': 'John', '$options': 'i'}}, {'location': {'$regex': 'John', '$options': 'i'}}, {'education': {'$regex': 'John', '$options': 'i'}}, {'occupation': {'$regex': 'John', '$options': 'i'}}, {'aboutYou': {'$regex': 'John', '$options': 'i'}}, {'bio': {'$regex': 'John', '$options': 'i'}}, {'interests': {'$regex': 'John', '$options': 'i'}}]}\n2025-10-15 09:40:41,748 - routes - ERROR - \u274c Search execution error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1263, in search_users\n    users = await users_cursor.to_list(length=limit)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\n2025-10-15 09:40:41,748 - main - INFO - \u274c GET /api/users/search - Status: 500 - Duration: 0.002s\n2025-10-15 09:40:41,749 - httpx - INFO - HTTP Request: GET http://testserver/api/users/search?keyword=John \"HTTP/1.1 500 Internal Server Error\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/search\nINFO     routes:routes.py:1157 \ud83d\udd0d Search request - keyword: 'John', status_filter: '', page: 1, limit: 20\nINFO     routes:routes.py:1261 \ud83d\udd0d Executing search with query: {'status.status': {'$regex': '^active$', '$options': 'i'}, '$or': [{'firstName': {'$regex': 'John', '$options': 'i'}}, {'lastName': {'$regex': 'John', '$options': 'i'}}, {'username': {'$regex': 'John', '$options': 'i'}}, {'location': {'$regex': 'John', '$options': 'i'}}, {'education': {'$regex': 'John', '$options': 'i'}}, {'occupation': {'$regex': 'John', '$options': 'i'}}, {'aboutYou': {'$regex': 'John', '$options': 'i'}}, {'bio': {'$regex': 'John', '$options': 'i'}}, {'interests': {'$regex': 'John', '$options': 'i'}}]}\nERROR    routes:routes.py:1285 \u274c Search execution error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1263, in search_users\n    users = await users_cursor.to_list(length=limit)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nINFO     main:main.py:122 \u274c GET /api/users/search - Status: 500 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: GET http://testserver/api/users/search?keyword=John \"HTTP/1.1 500 Internal Server Error\"\n___________________________ test_concurrent_requests ___________________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_e2e_api.py\", line 265, in test_concurrent_requests\n    |     response = test_client.get(f\"/api/users/profile/concurrent_user\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    |     user = await db.users.find_one({\"username\": username})\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\ntest_client = <starlette.testclient.TestClient object at 0x10ddeacf0>\n\n    def test_concurrent_requests(test_client):\n        \"\"\"Test handling of concurrent requests.\"\"\"\n        # Register a user first\n        test_client.post(\"/api/users/register\", data={\n            \"username\": \"concurrent_user\",\n            \"password\": \"testpass123\",\n            \"firstName\": \"Concurrent\",\n            \"lastName\": \"Test\"\n        })\n    \n        # Send multiple sequential requests\n        responses = []\n        for i in range(10):\n>           response = test_client.get(f\"/api/users/profile/concurrent_user\")\n\ntests/test_e2e_api.py:265: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'concurrent_user', requester = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/profile/{username}\")\n    async def get_user_profile(username: str, requester: str = None, db = Depends(get_database)):\n        \"\"\"Get user profile by username with PII masking\"\"\"\n        logger.info(f\"\ud83d\udc64 Profile request for username: {username} (requester: {requester})\")\n    \n        # Find user\n        logger.debug(f\"Fetching profile for user '{username}'...\")\n>       user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:484: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:41,761 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:41,762 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:41,763 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:41,764 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/profile/concurrent_user\n2025-10-15 09:40:41,765 - routes - INFO - \ud83d\udc64 Profile request for username: concurrent_user (requester: None)\n2025-10-15 09:40:41,765 - main - ERROR - \u274c Error processing GET /api/users/profile/concurrent_user - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/profile/concurrent_user\nINFO     routes:routes.py:480 \ud83d\udc64 Profile request for username: concurrent_user (requester: None)\nERROR    main:main.py:131 \u274c Error processing GET /api/users/profile/concurrent_user - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n______________________________ test_cors_headers _______________________________\n\ntest_client = <starlette.testclient.TestClient object at 0x10ddcaf90>\n\n    def test_cors_headers(test_client):\n        \"\"\"Test CORS headers are present.\"\"\"\n        response = test_client.options(\"/api/users/profile/test\")\n>       assert response.status_code == 200\nE       assert 405 == 200\nE        +  where 405 = <Response [405 Method Not Allowed]>.status_code\n\ntests/test_e2e_api.py:291: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:42,106 - main - INFO - \ud83d\udce8 Incoming OPTIONS request to /api/users/profile/test\n2025-10-15 09:40:42,107 - main - INFO - \u274c OPTIONS /api/users/profile/test - Status: 405 - Duration: 0.001s\n2025-10-15 09:40:42,108 - httpx - INFO - HTTP Request: OPTIONS http://testserver/api/users/profile/test \"HTTP/1.1 405 Method Not Allowed\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming OPTIONS request to /api/users/profile/test\nINFO     main:main.py:122 \u274c OPTIONS /api/users/profile/test - Status: 405 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: OPTIONS http://testserver/api/users/profile/test \"HTTP/1.1 405 Method Not Allowed\"\n______________ TestTokenRefresh.test_refresh_token_extends_expiry ______________\n\nself = <test_jwt_timezone.TestTokenRefresh object at 0x10dadf2f0>\n\n    def test_refresh_token_extends_expiry(self):\n        \"\"\"Test refreshing token extends expiration\"\"\"\n        # Create token\n        payload = {\"sub\": \"testuser\"}\n        token1 = JWTManager.create_access_token(payload)\n        decoded1 = JWTManager.decode_token(token1)\n        exp1 = decoded1[\"exp\"]\n    \n        # Refresh token (simulate)\n        token2 = JWTManager.create_access_token(payload)\n        decoded2 = JWTManager.decode_token(token2)\n        exp2 = decoded2[\"exp\"]\n    \n        # New token should have later expiration\n>       assert exp2 > exp1\nE       assert 1760550042 > 1760550042\n\ntests/test_jwt_timezone.py:214: AssertionError\n__________________ TestSendMessage.test_send_message_success ___________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 69, in test_send_message_success\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    |     recipient = await db.users.find_one({\"username\": message_data.toUsername})\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestSendMessage object at 0x10db15220>\nclient = <starlette.testclient.TestClient object at 0x10ddcb770>\ntest_users = [{'_id': ObjectId('68efce8a9ecea2e269cb5369'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce8a9ecea2e269cb536c'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\ncleanup_messages = None\n\n    def test_send_message_success(self, client, test_users, cleanup_messages):\n        \"\"\"Test successfully sending a message\"\"\"\n>       response = client.post(\n            \"/api/users/messages/send?username=user1\",\n            json={\n                \"toUsername\": \"user2\",\n                \"content\": \"Hello, how are you?\"\n            }\n        )\n\ntests/test_messages.py:69: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nmessage_data = MessageCreate(toUsername='user2', content='Hello, how are you?')\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/messages/send\")\n    async def send_message_enhanced(\n        message_data: MessageCreate,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Send a message with privacy checks and profanity filtering\"\"\"\n        logger.info(f\"\ud83d\udcac Enhanced message from {username} to {message_data.toUsername}\")\n    \n        # Check for profanity FIRST\n        from profanity_filter import check_message_content\n        content_check = check_message_content(message_data.content)\n    \n        if not content_check[\"is_clean\"]:\n            # Log violation\n            logger.warning(\n                f\"\u26a0\ufe0f Profanity detected from {username}: \"\n                f\"violations={content_check['violations']}, severity={content_check['severity']}\"\n            )\n    \n            # Record violation in database\n            await db.content_violations.insert_one({\n                \"username\": username,\n                \"type\": \"message_profanity\",\n                \"content\": message_data.content,\n                \"violations\": content_check[\"violations\"],\n                \"severity\": content_check[\"severity\"],\n                \"recipient\": message_data.toUsername,\n                \"timestamp\": datetime.utcnow()\n            })\n    \n            # Check user's violation count\n            violation_count = await db.content_violations.count_documents({\n                \"username\": username,\n                \"type\": \"message_profanity\"\n            })\n    \n            # Enforce consequences based on violation count\n            if violation_count >= 3:\n                # 3rd strike - ban user\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"banned\", \"reason\": \"Repeated profanity violations\"}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been banned due to repeated violations of community guidelines.\"\n                )\n            elif violation_count >= 2:\n                # 2nd strike - suspend for 7 days\n                from datetime import timedelta\n                suspend_until = datetime.utcnow() + timedelta(days=7)\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"suspended\", \"until\": suspend_until.isoformat()}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been suspended for 7 days due to inappropriate language. \"\n                           \"This is your second violation. A third violation will result in permanent ban.\"\n                )\n            else:\n                # 1st strike - reject message with warning\n                raise HTTPException(\n                    status_code=400,\n                    detail=\"\u26a0\ufe0f Your message contains inappropriate content. Please maintain professional \"\n                           \"communication. Repeated violations will result in account suspension or ban.\"\n                )\n    \n        # Check if recipient exists\n>       recipient = await db.users.find_one({\"username\": message_data.toUsername})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2357: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:42,329 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/messages/send\n2025-10-15 09:40:42,331 - routes - INFO - \ud83d\udcac Enhanced message from user1 to user2\n2025-10-15 09:40:42,331 - main - ERROR - \u274c Error processing POST /api/users/messages/send - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/messages/send\nINFO     routes:routes.py:2294 \ud83d\udcac Enhanced message from user1 to user2\nERROR    main:main.py:131 \u274c Error processing POST /api/users/messages/send - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n____________ TestSendMessage.test_send_message_to_nonexistent_user _____________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 88, in test_send_message_to_nonexistent_user\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    |     recipient = await db.users.find_one({\"username\": message_data.toUsername})\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestSendMessage object at 0x10db153a0>\nclient = <starlette.testclient.TestClient object at 0x10ddfef30>\ntest_users = [{'_id': ObjectId('68efce8a9ecea2e269cb536e'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce8a9ecea2e269cb5371'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\ncleanup_messages = None\n\n    def test_send_message_to_nonexistent_user(self, client, test_users, cleanup_messages):\n        \"\"\"Test sending message to non-existent user\"\"\"\n>       response = client.post(\n            \"/api/users/messages/send?username=user1\",\n            json={\n                \"toUsername\": \"nonexistent\",\n                \"content\": \"Hello\"\n            }\n        )\n\ntests/test_messages.py:88: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nmessage_data = MessageCreate(toUsername='nonexistent', content='Hello')\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/messages/send\")\n    async def send_message_enhanced(\n        message_data: MessageCreate,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Send a message with privacy checks and profanity filtering\"\"\"\n        logger.info(f\"\ud83d\udcac Enhanced message from {username} to {message_data.toUsername}\")\n    \n        # Check for profanity FIRST\n        from profanity_filter import check_message_content\n        content_check = check_message_content(message_data.content)\n    \n        if not content_check[\"is_clean\"]:\n            # Log violation\n            logger.warning(\n                f\"\u26a0\ufe0f Profanity detected from {username}: \"\n                f\"violations={content_check['violations']}, severity={content_check['severity']}\"\n            )\n    \n            # Record violation in database\n            await db.content_violations.insert_one({\n                \"username\": username,\n                \"type\": \"message_profanity\",\n                \"content\": message_data.content,\n                \"violations\": content_check[\"violations\"],\n                \"severity\": content_check[\"severity\"],\n                \"recipient\": message_data.toUsername,\n                \"timestamp\": datetime.utcnow()\n            })\n    \n            # Check user's violation count\n            violation_count = await db.content_violations.count_documents({\n                \"username\": username,\n                \"type\": \"message_profanity\"\n            })\n    \n            # Enforce consequences based on violation count\n            if violation_count >= 3:\n                # 3rd strike - ban user\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"banned\", \"reason\": \"Repeated profanity violations\"}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been banned due to repeated violations of community guidelines.\"\n                )\n            elif violation_count >= 2:\n                # 2nd strike - suspend for 7 days\n                from datetime import timedelta\n                suspend_until = datetime.utcnow() + timedelta(days=7)\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"suspended\", \"until\": suspend_until.isoformat()}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been suspended for 7 days due to inappropriate language. \"\n                           \"This is your second violation. A third violation will result in permanent ban.\"\n                )\n            else:\n                # 1st strike - reject message with warning\n                raise HTTPException(\n                    status_code=400,\n                    detail=\"\u26a0\ufe0f Your message contains inappropriate content. Please maintain professional \"\n                           \"communication. Repeated violations will result in account suspension or ban.\"\n                )\n    \n        # Check if recipient exists\n>       recipient = await db.users.find_one({\"username\": message_data.toUsername})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2357: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:42,748 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/messages/send\n2025-10-15 09:40:42,749 - routes - INFO - \ud83d\udcac Enhanced message from user1 to nonexistent\n2025-10-15 09:40:42,749 - main - ERROR - \u274c Error processing POST /api/users/messages/send - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/messages/send\nINFO     routes:routes.py:2294 \ud83d\udcac Enhanced message from user1 to nonexistent\nERROR    main:main.py:131 \u274c Error processing POST /api/users/messages/send - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n______________ TestSendMessage.test_send_message_trims_whitespace ______________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 126, in test_send_message_trims_whitespace\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    |     recipient = await db.users.find_one({\"username\": message_data.toUsername})\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestSendMessage object at 0x10db15940>\nclient = <starlette.testclient.TestClient object at 0x10e585ee0>\ntest_users = [{'_id': ObjectId('68efce8b9ecea2e269cb537d'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce8b9ecea2e269cb5380'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\ncleanup_messages = None\n\n    def test_send_message_trims_whitespace(self, client, test_users, cleanup_messages):\n        \"\"\"Test that message content is trimmed\"\"\"\n>       response = client.post(\n            \"/api/users/messages/send?username=user1\",\n            json={\n                \"toUsername\": \"user2\",\n                \"content\": \"  Hello  \"\n            }\n        )\n\ntests/test_messages.py:126: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nmessage_data = MessageCreate(toUsername='user2', content='  Hello  ')\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/messages/send\")\n    async def send_message_enhanced(\n        message_data: MessageCreate,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Send a message with privacy checks and profanity filtering\"\"\"\n        logger.info(f\"\ud83d\udcac Enhanced message from {username} to {message_data.toUsername}\")\n    \n        # Check for profanity FIRST\n        from profanity_filter import check_message_content\n        content_check = check_message_content(message_data.content)\n    \n        if not content_check[\"is_clean\"]:\n            # Log violation\n            logger.warning(\n                f\"\u26a0\ufe0f Profanity detected from {username}: \"\n                f\"violations={content_check['violations']}, severity={content_check['severity']}\"\n            )\n    \n            # Record violation in database\n            await db.content_violations.insert_one({\n                \"username\": username,\n                \"type\": \"message_profanity\",\n                \"content\": message_data.content,\n                \"violations\": content_check[\"violations\"],\n                \"severity\": content_check[\"severity\"],\n                \"recipient\": message_data.toUsername,\n                \"timestamp\": datetime.utcnow()\n            })\n    \n            # Check user's violation count\n            violation_count = await db.content_violations.count_documents({\n                \"username\": username,\n                \"type\": \"message_profanity\"\n            })\n    \n            # Enforce consequences based on violation count\n            if violation_count >= 3:\n                # 3rd strike - ban user\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"banned\", \"reason\": \"Repeated profanity violations\"}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been banned due to repeated violations of community guidelines.\"\n                )\n            elif violation_count >= 2:\n                # 2nd strike - suspend for 7 days\n                from datetime import timedelta\n                suspend_until = datetime.utcnow() + timedelta(days=7)\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"suspended\", \"until\": suspend_until.isoformat()}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been suspended for 7 days due to inappropriate language. \"\n                           \"This is your second violation. A third violation will result in permanent ban.\"\n                )\n            else:\n                # 1st strike - reject message with warning\n                raise HTTPException(\n                    status_code=400,\n                    detail=\"\u26a0\ufe0f Your message contains inappropriate content. Please maintain professional \"\n                           \"communication. Repeated violations will result in account suspension or ban.\"\n                )\n    \n        # Check if recipient exists\n>       recipient = await db.users.find_one({\"username\": message_data.toUsername})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2357: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:43,397 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/messages/send\n2025-10-15 09:40:43,398 - routes - INFO - \ud83d\udcac Enhanced message from user1 to user2\n2025-10-15 09:40:43,399 - main - ERROR - \u274c Error processing POST /api/users/messages/send - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/messages/send\nINFO     routes:routes.py:2294 \ud83d\udcac Enhanced message from user1 to user2\nERROR    main:main.py:131 \u274c Error processing POST /api/users/messages/send - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n____ TestMessagePrivacy.test_send_message_to_blocked_user_marked_invisible _____\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 155, in test_send_message_to_blocked_user_marked_invisible\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    |     recipient = await db.users.find_one({\"username\": message_data.toUsername})\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestMessagePrivacy object at 0x10db15dc0>\nclient = <starlette.testclient.TestClient object at 0x10e5850a0>\ntest_users = [{'_id': ObjectId('68efce8b9ecea2e269cb5382'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce8b9ecea2e269cb5385'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nblocked_users = {'_id': ObjectId('68efce8b9ecea2e269cb5386'), 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 43, 827860), 'excludedUsername': 'blocked_user', 'reason': 'Test exclusion', ...}\ncleanup_messages = None\n\n    def test_send_message_to_blocked_user_marked_invisible(self, client, test_users, blocked_users, cleanup_messages):\n        \"\"\"Test that messages to blocked users are marked as invisible\"\"\"\n>       response = client.post(\n            \"/api/users/messages/send?username=user1\",\n            json={\n                \"toUsername\": \"blocked_user\",\n                \"content\": \"This should be invisible\"\n            }\n        )\n\ntests/test_messages.py:155: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nmessage_data = MessageCreate(toUsername='blocked_user', content='This should be invisible')\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/messages/send\")\n    async def send_message_enhanced(\n        message_data: MessageCreate,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Send a message with privacy checks and profanity filtering\"\"\"\n        logger.info(f\"\ud83d\udcac Enhanced message from {username} to {message_data.toUsername}\")\n    \n        # Check for profanity FIRST\n        from profanity_filter import check_message_content\n        content_check = check_message_content(message_data.content)\n    \n        if not content_check[\"is_clean\"]:\n            # Log violation\n            logger.warning(\n                f\"\u26a0\ufe0f Profanity detected from {username}: \"\n                f\"violations={content_check['violations']}, severity={content_check['severity']}\"\n            )\n    \n            # Record violation in database\n            await db.content_violations.insert_one({\n                \"username\": username,\n                \"type\": \"message_profanity\",\n                \"content\": message_data.content,\n                \"violations\": content_check[\"violations\"],\n                \"severity\": content_check[\"severity\"],\n                \"recipient\": message_data.toUsername,\n                \"timestamp\": datetime.utcnow()\n            })\n    \n            # Check user's violation count\n            violation_count = await db.content_violations.count_documents({\n                \"username\": username,\n                \"type\": \"message_profanity\"\n            })\n    \n            # Enforce consequences based on violation count\n            if violation_count >= 3:\n                # 3rd strike - ban user\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"banned\", \"reason\": \"Repeated profanity violations\"}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been banned due to repeated violations of community guidelines.\"\n                )\n            elif violation_count >= 2:\n                # 2nd strike - suspend for 7 days\n                from datetime import timedelta\n                suspend_until = datetime.utcnow() + timedelta(days=7)\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"suspended\", \"until\": suspend_until.isoformat()}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been suspended for 7 days due to inappropriate language. \"\n                           \"This is your second violation. A third violation will result in permanent ban.\"\n                )\n            else:\n                # 1st strike - reject message with warning\n                raise HTTPException(\n                    status_code=400,\n                    detail=\"\u26a0\ufe0f Your message contains inappropriate content. Please maintain professional \"\n                           \"communication. Repeated violations will result in account suspension or ban.\"\n                )\n    \n        # Check if recipient exists\n>       recipient = await db.users.find_one({\"username\": message_data.toUsername})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2357: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:43,928 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/messages/send\n2025-10-15 09:40:43,929 - routes - INFO - \ud83d\udcac Enhanced message from user1 to blocked_user\n2025-10-15 09:40:43,930 - main - ERROR - \u274c Error processing POST /api/users/messages/send - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/messages/send\nINFO     routes:routes.py:2294 \ud83d\udcac Enhanced message from user1 to blocked_user\nERROR    main:main.py:131 \u274c Error processing POST /api/users/messages/send - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n___ TestMessagePrivacy.test_send_message_from_blocked_user_marked_invisible ____\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 169, in test_send_message_from_blocked_user_marked_invisible\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    |     recipient = await db.users.find_one({\"username\": message_data.toUsername})\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestMessagePrivacy object at 0x10db16000>\nclient = <starlette.testclient.TestClient object at 0x10e57edb0>\ntest_users = [{'_id': ObjectId('68efce8c9ecea2e269cb5388'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce8c9ecea2e269cb538b'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nblocked_users = {'_id': ObjectId('68efce8c9ecea2e269cb538c'), 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 44, 346999), 'excludedUsername': 'blocked_user', 'reason': 'Test exclusion', ...}\ncleanup_messages = None\n\n    def test_send_message_from_blocked_user_marked_invisible(self, client, test_users, blocked_users, cleanup_messages):\n        \"\"\"Test that messages from blocked users are marked as invisible\"\"\"\n>       response = client.post(\n            \"/api/users/messages/send?username=blocked_user\",\n            json={\n                \"toUsername\": \"user1\",\n                \"content\": \"This should also be invisible\"\n            }\n        )\n\ntests/test_messages.py:169: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nmessage_data = MessageCreate(toUsername='user1', content='This should also be invisible')\nusername = 'blocked_user'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/messages/send\")\n    async def send_message_enhanced(\n        message_data: MessageCreate,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Send a message with privacy checks and profanity filtering\"\"\"\n        logger.info(f\"\ud83d\udcac Enhanced message from {username} to {message_data.toUsername}\")\n    \n        # Check for profanity FIRST\n        from profanity_filter import check_message_content\n        content_check = check_message_content(message_data.content)\n    \n        if not content_check[\"is_clean\"]:\n            # Log violation\n            logger.warning(\n                f\"\u26a0\ufe0f Profanity detected from {username}: \"\n                f\"violations={content_check['violations']}, severity={content_check['severity']}\"\n            )\n    \n            # Record violation in database\n            await db.content_violations.insert_one({\n                \"username\": username,\n                \"type\": \"message_profanity\",\n                \"content\": message_data.content,\n                \"violations\": content_check[\"violations\"],\n                \"severity\": content_check[\"severity\"],\n                \"recipient\": message_data.toUsername,\n                \"timestamp\": datetime.utcnow()\n            })\n    \n            # Check user's violation count\n            violation_count = await db.content_violations.count_documents({\n                \"username\": username,\n                \"type\": \"message_profanity\"\n            })\n    \n            # Enforce consequences based on violation count\n            if violation_count >= 3:\n                # 3rd strike - ban user\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"banned\", \"reason\": \"Repeated profanity violations\"}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been banned due to repeated violations of community guidelines.\"\n                )\n            elif violation_count >= 2:\n                # 2nd strike - suspend for 7 days\n                from datetime import timedelta\n                suspend_until = datetime.utcnow() + timedelta(days=7)\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"suspended\", \"until\": suspend_until.isoformat()}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been suspended for 7 days due to inappropriate language. \"\n                           \"This is your second violation. A third violation will result in permanent ban.\"\n                )\n            else:\n                # 1st strike - reject message with warning\n                raise HTTPException(\n                    status_code=400,\n                    detail=\"\u26a0\ufe0f Your message contains inappropriate content. Please maintain professional \"\n                           \"communication. Repeated violations will result in account suspension or ban.\"\n                )\n    \n        # Check if recipient exists\n>       recipient = await db.users.find_one({\"username\": message_data.toUsername})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2357: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:44,448 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/messages/send\n2025-10-15 09:40:44,449 - routes - INFO - \ud83d\udcac Enhanced message from blocked_user to user1\n2025-10-15 09:40:44,450 - main - ERROR - \u274c Error processing POST /api/users/messages/send - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/messages/send\nINFO     routes:routes.py:2294 \ud83d\udcac Enhanced message from blocked_user to user1\nERROR    main:main.py:131 \u274c Error processing POST /api/users/messages/send - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n______________ TestGetConversation.test_get_conversation_success _______________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 219, in test_get_conversation_success\n    |     response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestGetConversation object at 0x10db163c0>\nclient = <starlette.testclient.TestClient object at 0x10e5d9e20>\ntest_users = [{'_id': ObjectId('68efce8c9ecea2e269cb538e'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce8c9ecea2e269cb5391'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nsample_messages = [{'_id': ObjectId('68efce8c9ecea2e269cb5392'), 'content': 'Hello', 'createdAt': datetime.datetime(2025, 10, 15, 16, 35...tent': 'How are you?', 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 44, 877825), 'fromUsername': 'user1', ...}]\ncleanup_messages = None\n\n    def test_get_conversation_success(self, client, test_users, sample_messages, cleanup_messages):\n        \"\"\"Test successfully retrieving a conversation\"\"\"\n>       response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n\ntests/test_messages.py:219: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nother_username = 'user2', username = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversation/{other_username}\")\n    async def get_conversation(\n        other_username: str,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get conversation with specific user (with privacy checks)\"\"\"\n        logger.info(f\"\ud83d\udcad Getting conversation between {username} and {other_username}\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2455: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:44,998 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\n2025-10-15 09:40:44,998 - routes - INFO - \ud83d\udcad Getting conversation between user1 and user2\n2025-10-15 09:40:44,999 - main - ERROR - \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\nINFO     routes:routes.py:2452 \ud83d\udcad Getting conversation between user1 and user2\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______ TestGetConversation.test_get_conversation_sorted_chronologically _______\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 231, in test_get_conversation_sorted_chronologically\n    |     response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestGetConversation object at 0x10db16600>\nclient = <starlette.testclient.TestClient object at 0x10e5dd010>\ntest_users = [{'_id': ObjectId('68efce8d9ecea2e269cb5396'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce8d9ecea2e269cb5399'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nsample_messages = [{'_id': ObjectId('68efce8d9ecea2e269cb539a'), 'content': 'Hello', 'createdAt': datetime.datetime(2025, 10, 15, 16, 35...tent': 'How are you?', 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 45, 577988), 'fromUsername': 'user1', ...}]\ncleanup_messages = None\n\n    def test_get_conversation_sorted_chronologically(self, client, test_users, sample_messages, cleanup_messages):\n        \"\"\"Test that messages are sorted chronologically\"\"\"\n>       response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n\ntests/test_messages.py:231: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nother_username = 'user2', username = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversation/{other_username}\")\n    async def get_conversation(\n        other_username: str,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get conversation with specific user (with privacy checks)\"\"\"\n        logger.info(f\"\ud83d\udcad Getting conversation between {username} and {other_username}\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2455: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:45,678 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\n2025-10-15 09:40:45,679 - routes - INFO - \ud83d\udcad Getting conversation between user1 and user2\n2025-10-15 09:40:45,680 - main - ERROR - \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\nINFO     routes:routes.py:2452 \ud83d\udcad Getting conversation between user1 and user2\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______ TestGetConversation.test_get_conversation_marks_messages_as_read _______\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 244, in test_get_conversation_marks_messages_as_read\n    |     response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestGetConversation object at 0x10db16840>\nclient = <starlette.testclient.TestClient object at 0x10f5e3830>\ntest_users = [{'_id': ObjectId('68efce8e9ecea2e269cb539e'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce8e9ecea2e269cb53a1'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nsample_messages = [{'_id': ObjectId('68efce8e9ecea2e269cb53a2'), 'content': 'Hello', 'createdAt': datetime.datetime(2025, 10, 15, 16, 35...tent': 'How are you?', 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 46, 199396), 'fromUsername': 'user1', ...}]\ncleanup_messages = None\n\n    def test_get_conversation_marks_messages_as_read(self, client, test_users, sample_messages, cleanup_messages):\n        \"\"\"Test that retrieving conversation marks messages as read\"\"\"\n        # Get conversation as user1 (recipient of message from user2)\n>       response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n\ntests/test_messages.py:244: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nother_username = 'user2', username = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversation/{other_username}\")\n    async def get_conversation(\n        other_username: str,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get conversation with specific user (with privacy checks)\"\"\"\n        logger.info(f\"\ud83d\udcad Getting conversation between {username} and {other_username}\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2455: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:46,282 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\n2025-10-15 09:40:46,283 - routes - INFO - \ud83d\udcad Getting conversation between user1 and user2\n2025-10-15 09:40:46,283 - main - ERROR - \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\nINFO     routes:routes.py:2452 \ud83d\udcad Getting conversation between user1 and user2\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n____ TestGetConversation.test_get_conversation_includes_other_user_profile _____\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 251, in test_get_conversation_includes_other_user_profile\n    |     response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestGetConversation object at 0x10db16a80>\nclient = <starlette.testclient.TestClient object at 0x10e5db5c0>\ntest_users = [{'_id': ObjectId('68efce8e9ecea2e269cb53a6'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce8e9ecea2e269cb53a9'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nsample_messages = [{'_id': ObjectId('68efce8e9ecea2e269cb53aa'), 'content': 'Hello', 'createdAt': datetime.datetime(2025, 10, 15, 16, 35...tent': 'How are you?', 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 46, 697586), 'fromUsername': 'user1', ...}]\ncleanup_messages = None\n\n    def test_get_conversation_includes_other_user_profile(self, client, test_users, sample_messages, cleanup_messages):\n        \"\"\"Test that conversation includes other user's profile\"\"\"\n>       response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n\ntests/test_messages.py:251: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nother_username = 'user2', username = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversation/{other_username}\")\n    async def get_conversation(\n        other_username: str,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get conversation with specific user (with privacy checks)\"\"\"\n        logger.info(f\"\ud83d\udcad Getting conversation between {username} and {other_username}\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2455: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:46,798 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\n2025-10-15 09:40:46,798 - routes - INFO - \ud83d\udcad Getting conversation between user1 and user2\n2025-10-15 09:40:46,799 - main - ERROR - \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\nINFO     routes:routes.py:2452 \ud83d\udcad Getting conversation between user1 and user2\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______________ TestGetConversation.test_get_conversation_empty ________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 263, in test_get_conversation_empty\n    |     response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestGetConversation object at 0x10db16c00>\nclient = <starlette.testclient.TestClient object at 0x10dcc9850>\ntest_users = [{'_id': ObjectId('68efce8f9ecea2e269cb53ae'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce8f9ecea2e269cb53b1'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\ncleanup_messages = None\n\n    def test_get_conversation_empty(self, client, test_users, cleanup_messages):\n        \"\"\"Test getting conversation with no messages\"\"\"\n>       response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n\ntests/test_messages.py:263: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nother_username = 'user2', username = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversation/{other_username}\")\n    async def get_conversation(\n        other_username: str,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get conversation with specific user (with privacy checks)\"\"\"\n        logger.info(f\"\ud83d\udcad Getting conversation between {username} and {other_username}\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2455: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:47,228 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\n2025-10-15 09:40:47,229 - routes - INFO - \ud83d\udcad Getting conversation between user1 and user2\n2025-10-15 09:40:47,230 - main - ERROR - \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\nINFO     routes:routes.py:2452 \ud83d\udcad Getting conversation between user1 and user2\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_____________ TestGetConversations.test_get_conversations_success ______________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 308, in test_get_conversations_success\n    |     response = client.get(\"/api/users/messages/conversations?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestGetConversations object at 0x10db159d0>\nclient = <starlette.testclient.TestClient object at 0x10e585880>\ntest_users = [{'_id': ObjectId('68efce8f9ecea2e269cb53b3'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce8f9ecea2e269cb53b6'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nmultiple_conversations = [{'_id': ObjectId('68efce8f9ecea2e269cb53b7'), 'content': 'Hello user2', 'createdAt': datetime.datetime(2025, 10, 15, ...ent': 'Admin message', 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 47, 646697), 'fromUsername': 'admin', ...}]\ncleanup_messages = None\n\n    def test_get_conversations_success(self, client, test_users, multiple_conversations, cleanup_messages):\n        \"\"\"Test successfully retrieving conversations list\"\"\"\n>       response = client.get(\"/api/users/messages/conversations?username=user1\")\n\ntests/test_messages.py:308: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversations\")\n    async def get_conversations_enhanced(\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get list of all conversations with privacy checks\"\"\"\n        logger.info(f\"\ud83d\udcac ========== GET /messages/conversations called for username={username} ==========\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1831: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:47,748 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversations\n2025-10-15 09:40:47,749 - routes - INFO - \ud83d\udcac ========== GET /messages/conversations called for username=user1 ==========\n2025-10-15 09:40:47,749 - main - ERROR - \u274c Error processing GET /api/users/messages/conversations - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversations\nINFO     routes:routes.py:1828 \ud83d\udcac ========== GET /messages/conversations called for username=user1 ==========\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversations - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_________ TestGetConversations.test_get_conversations_sorted_by_recent _________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 317, in test_get_conversations_sorted_by_recent\n    |     response = client.get(\"/api/users/messages/conversations?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestGetConversations object at 0x10db162d0>\nclient = <starlette.testclient.TestClient object at 0x10ddfdb80>\ntest_users = [{'_id': ObjectId('68efce909ecea2e269cb53bb'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce909ecea2e269cb53be'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nmultiple_conversations = [{'_id': ObjectId('68efce909ecea2e269cb53bf'), 'content': 'Hello user2', 'createdAt': datetime.datetime(2025, 10, 15, ...ent': 'Admin message', 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 48, 177829), 'fromUsername': 'admin', ...}]\ncleanup_messages = None\n\n    def test_get_conversations_sorted_by_recent(self, client, test_users, multiple_conversations, cleanup_messages):\n        \"\"\"Test that conversations are sorted by most recent message\"\"\"\n>       response = client.get(\"/api/users/messages/conversations?username=user1\")\n\ntests/test_messages.py:317: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversations\")\n    async def get_conversations_enhanced(\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get list of all conversations with privacy checks\"\"\"\n        logger.info(f\"\ud83d\udcac ========== GET /messages/conversations called for username={username} ==========\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1831: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:48,278 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversations\n2025-10-15 09:40:48,279 - routes - INFO - \ud83d\udcac ========== GET /messages/conversations called for username=user1 ==========\n2025-10-15 09:40:48,280 - main - ERROR - \u274c Error processing GET /api/users/messages/conversations - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversations\nINFO     routes:routes.py:1828 \ud83d\udcac ========== GET /messages/conversations called for username=user1 ==========\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversations - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n______ TestGetConversations.test_get_conversations_includes_unread_count _______\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 328, in test_get_conversations_includes_unread_count\n    |     response = client.get(\"/api/users/messages/conversations?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestGetConversations object at 0x10db17080>\nclient = <starlette.testclient.TestClient object at 0x10f5c7740>\ntest_users = [{'_id': ObjectId('68efce909ecea2e269cb53c3'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce909ecea2e269cb53c6'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nmultiple_conversations = [{'_id': ObjectId('68efce909ecea2e269cb53c7'), 'content': 'Hello user2', 'createdAt': datetime.datetime(2025, 10, 15, ...ent': 'Admin message', 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 48, 697058), 'fromUsername': 'admin', ...}]\ncleanup_messages = None\n\n    def test_get_conversations_includes_unread_count(self, client, test_users, multiple_conversations, cleanup_messages):\n        \"\"\"Test that conversations include unread message count\"\"\"\n>       response = client.get(\"/api/users/messages/conversations?username=user1\")\n\ntests/test_messages.py:328: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversations\")\n    async def get_conversations_enhanced(\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get list of all conversations with privacy checks\"\"\"\n        logger.info(f\"\ud83d\udcac ========== GET /messages/conversations called for username={username} ==========\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1831: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:48,798 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversations\n2025-10-15 09:40:48,798 - routes - INFO - \ud83d\udcac ========== GET /messages/conversations called for username=user1 ==========\n2025-10-15 09:40:48,799 - main - ERROR - \u274c Error processing GET /api/users/messages/conversations - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversations\nINFO     routes:routes.py:1828 \ud83d\udcac ========== GET /messages/conversations called for username=user1 ==========\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversations - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n______ TestGetConversations.test_get_conversations_includes_last_message _______\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 339, in test_get_conversations_includes_last_message\n    |     response = client.get(\"/api/users/messages/conversations?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestGetConversations object at 0x10db172c0>\nclient = <starlette.testclient.TestClient object at 0x10f599d00>\ntest_users = [{'_id': ObjectId('68efce919ecea2e269cb53cb'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce919ecea2e269cb53ce'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nmultiple_conversations = [{'_id': ObjectId('68efce919ecea2e269cb53cf'), 'content': 'Hello user2', 'createdAt': datetime.datetime(2025, 10, 15, ...ent': 'Admin message', 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 49, 198561), 'fromUsername': 'admin', ...}]\ncleanup_messages = None\n\n    def test_get_conversations_includes_last_message(self, client, test_users, multiple_conversations, cleanup_messages):\n        \"\"\"Test that conversations include last message preview\"\"\"\n>       response = client.get(\"/api/users/messages/conversations?username=user1\")\n\ntests/test_messages.py:339: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversations\")\n    async def get_conversations_enhanced(\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get list of all conversations with privacy checks\"\"\"\n        logger.info(f\"\ud83d\udcac ========== GET /messages/conversations called for username={username} ==========\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1831: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:49,299 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversations\n2025-10-15 09:40:49,300 - routes - INFO - \ud83d\udcac ========== GET /messages/conversations called for username=user1 ==========\n2025-10-15 09:40:49,301 - main - ERROR - \u274c Error processing GET /api/users/messages/conversations - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversations\nINFO     routes:routes.py:1828 \ud83d\udcac ========== GET /messages/conversations called for username=user1 ==========\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversations - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n______________ TestGetConversations.test_get_conversations_empty _______________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 351, in test_get_conversations_empty\n    |     response = client.get(\"/api/users/messages/conversations?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestGetConversations object at 0x10db17440>\nclient = <starlette.testclient.TestClient object at 0x10f599850>\ntest_users = [{'_id': ObjectId('68efce919ecea2e269cb53d3'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce919ecea2e269cb53d6'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\ncleanup_messages = None\n\n    def test_get_conversations_empty(self, client, test_users, cleanup_messages):\n        \"\"\"Test getting conversations when none exist\"\"\"\n>       response = client.get(\"/api/users/messages/conversations?username=user1\")\n\ntests/test_messages.py:351: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversations\")\n    async def get_conversations_enhanced(\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get list of all conversations with privacy checks\"\"\"\n        logger.info(f\"\ud83d\udcac ========== GET /messages/conversations called for username={username} ==========\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1831: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:49,800 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversations\n2025-10-15 09:40:49,801 - routes - INFO - \ud83d\udcac ========== GET /messages/conversations called for username=user1 ==========\n2025-10-15 09:40:49,801 - main - ERROR - \u274c Error processing GET /api/users/messages/conversations - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversations\nINFO     routes:routes.py:1828 \ud83d\udcac ========== GET /messages/conversations called for username=user1 ==========\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversations - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1831, in get_conversations_enhanced\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n____________ TestAdminOverride.test_admin_can_see_blocked_messages _____________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 386, in test_admin_can_see_blocked_messages\n    |     response = client.get(\"/api/users/messages/conversation/user2?username=admin\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestAdminOverride object at 0x10db17890>\nclient = <starlette.testclient.TestClient object at 0x10ddd9f40>\ntest_users = [{'_id': ObjectId('68efce929ecea2e269cb53d8'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce929ecea2e269cb53db'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nblocked_messages = {'_id': ObjectId('68efce929ecea2e269cb53dd'), 'content': 'Blocked message', 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 50, 347404), 'fromUsername': 'user1', ...}\ncleanup_messages = None\n\n    def test_admin_can_see_blocked_messages(self, client, test_users, blocked_messages, cleanup_messages):\n        \"\"\"Test that admin can see messages marked as invisible\"\"\"\n>       response = client.get(\"/api/users/messages/conversation/user2?username=admin\")\n\ntests/test_messages.py:386: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nother_username = 'user2', username = 'admin'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversation/{other_username}\")\n    async def get_conversation(\n        other_username: str,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get conversation with specific user (with privacy checks)\"\"\"\n        logger.info(f\"\ud83d\udcad Getting conversation between {username} and {other_username}\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2455: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:50,448 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\n2025-10-15 09:40:50,449 - routes - INFO - \ud83d\udcad Getting conversation between admin and user2\n2025-10-15 09:40:50,449 - main - ERROR - \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\nINFO     routes:routes.py:2452 \ud83d\udcad Getting conversation between admin and user2\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______ TestAdminOverride.test_regular_user_cannot_see_blocked_messages ________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 394, in test_regular_user_cannot_see_blocked_messages\n    |     response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestAdminOverride object at 0x10db17ad0>\nclient = <starlette.testclient.TestClient object at 0x10e5784a0>\ntest_users = [{'_id': ObjectId('68efce929ecea2e269cb53df'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce929ecea2e269cb53e2'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\nblocked_messages = {'_id': ObjectId('68efce929ecea2e269cb53e4'), 'content': 'Blocked message', 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 50, 977739), 'fromUsername': 'user1', ...}\ncleanup_messages = None\n\n    def test_regular_user_cannot_see_blocked_messages(self, client, test_users, blocked_messages, cleanup_messages):\n        \"\"\"Test that regular users cannot see blocked messages\"\"\"\n>       response = client.get(\"/api/users/messages/conversation/user2?username=user1\")\n\ntests/test_messages.py:394: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nother_username = 'user2', username = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversation/{other_username}\")\n    async def get_conversation(\n        other_username: str,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get conversation with specific user (with privacy checks)\"\"\"\n        logger.info(f\"\ud83d\udcad Getting conversation between {username} and {other_username}\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2455: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:51,078 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\n2025-10-15 09:40:51,079 - routes - INFO - \ud83d\udcad Getting conversation between user1 and user2\n2025-10-15 09:40:51,080 - main - ERROR - \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/user2\nINFO     routes:routes.py:2452 \ud83d\udcad Getting conversation between user1 and user2\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversation/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n__________ TestMessageEdgeCases.test_send_message_special_characters ___________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 419, in test_send_message_special_characters\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    |     recipient = await db.users.find_one({\"username\": message_data.toUsername})\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestMessageEdgeCases object at 0x10db4c0e0>\nclient = <starlette.testclient.TestClient object at 0x10e587d10>\ntest_users = [{'_id': ObjectId('68efce939ecea2e269cb53eb'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce939ecea2e269cb53ee'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\ncleanup_messages = None\n\n    def test_send_message_special_characters(self, client, test_users, cleanup_messages):\n        \"\"\"Test sending message with special characters\"\"\"\n>       response = client.post(\n            \"/api/users/messages/send?username=user1\",\n            json={\n                \"toUsername\": \"user2\",\n                \"content\": \"Hello! \ud83d\ude0a <script>alert('xss')</script>\"\n            }\n        )\n\ntests/test_messages.py:419: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nmessage_data = MessageCreate(toUsername='user2', content=\"Hello! \ud83d\ude0a <script>alert('xss')</script>\")\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/messages/send\")\n    async def send_message_enhanced(\n        message_data: MessageCreate,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Send a message with privacy checks and profanity filtering\"\"\"\n        logger.info(f\"\ud83d\udcac Enhanced message from {username} to {message_data.toUsername}\")\n    \n        # Check for profanity FIRST\n        from profanity_filter import check_message_content\n        content_check = check_message_content(message_data.content)\n    \n        if not content_check[\"is_clean\"]:\n            # Log violation\n            logger.warning(\n                f\"\u26a0\ufe0f Profanity detected from {username}: \"\n                f\"violations={content_check['violations']}, severity={content_check['severity']}\"\n            )\n    \n            # Record violation in database\n            await db.content_violations.insert_one({\n                \"username\": username,\n                \"type\": \"message_profanity\",\n                \"content\": message_data.content,\n                \"violations\": content_check[\"violations\"],\n                \"severity\": content_check[\"severity\"],\n                \"recipient\": message_data.toUsername,\n                \"timestamp\": datetime.utcnow()\n            })\n    \n            # Check user's violation count\n            violation_count = await db.content_violations.count_documents({\n                \"username\": username,\n                \"type\": \"message_profanity\"\n            })\n    \n            # Enforce consequences based on violation count\n            if violation_count >= 3:\n                # 3rd strike - ban user\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"banned\", \"reason\": \"Repeated profanity violations\"}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been banned due to repeated violations of community guidelines.\"\n                )\n            elif violation_count >= 2:\n                # 2nd strike - suspend for 7 days\n                from datetime import timedelta\n                suspend_until = datetime.utcnow() + timedelta(days=7)\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"suspended\", \"until\": suspend_until.isoformat()}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been suspended for 7 days due to inappropriate language. \"\n                           \"This is your second violation. A third violation will result in permanent ban.\"\n                )\n            else:\n                # 1st strike - reject message with warning\n                raise HTTPException(\n                    status_code=400,\n                    detail=\"\u26a0\ufe0f Your message contains inappropriate content. Please maintain professional \"\n                           \"communication. Repeated violations will result in account suspension or ban.\"\n                )\n    \n        # Check if recipient exists\n>       recipient = await db.users.find_one({\"username\": message_data.toUsername})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2357: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:51,600 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/messages/send\n2025-10-15 09:40:51,601 - routes - INFO - \ud83d\udcac Enhanced message from user1 to user2\n2025-10-15 09:40:51,602 - main - ERROR - \u274c Error processing POST /api/users/messages/send - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/messages/send\nINFO     routes:routes.py:2294 \ud83d\udcac Enhanced message from user1 to user2\nERROR    main:main.py:131 \u274c Error processing POST /api/users/messages/send - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_________ TestMessageEdgeCases.test_get_conversation_nonexistent_user __________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 432, in test_get_conversation_nonexistent_user\n    |     response = client.get(\"/api/users/messages/conversation/nonexistent?username=user1\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    |     current_user = await db.users.find_one({\"username\": username})\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestMessageEdgeCases object at 0x10db4c1d0>\nclient = <starlette.testclient.TestClient object at 0x10f5e1ac0>\ntest_users = [{'_id': ObjectId('68efce939ecea2e269cb53f0'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce939ecea2e269cb53f3'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\ncleanup_messages = None\n\n    def test_get_conversation_nonexistent_user(self, client, test_users, cleanup_messages):\n        \"\"\"Test getting conversation with non-existent user\"\"\"\n>       response = client.get(\"/api/users/messages/conversation/nonexistent?username=user1\")\n\ntests/test_messages.py:432: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nother_username = 'nonexistent', username = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/messages/conversation/{other_username}\")\n    async def get_conversation(\n        other_username: str,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Get conversation with specific user (with privacy checks)\"\"\"\n        logger.info(f\"\ud83d\udcad Getting conversation between {username} and {other_username}\")\n    \n        # Check if current user is admin\n>       current_user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2455: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:52,029 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/nonexistent\n2025-10-15 09:40:52,029 - routes - INFO - \ud83d\udcad Getting conversation between user1 and nonexistent\n2025-10-15 09:40:52,029 - main - ERROR - \u274c Error processing GET /api/users/messages/conversation/nonexistent - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/messages/conversation/nonexistent\nINFO     routes:routes.py:2452 \ud83d\udcad Getting conversation between user1 and nonexistent\nERROR    main:main.py:131 \u274c Error processing GET /api/users/messages/conversation/nonexistent - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2455, in get_conversation\n    current_user = await db.users.find_one({\"username\": username})\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n____________ TestMessageIntegration.test_full_conversation_workflow ____________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 449, in test_full_conversation_workflow\n    |     send_response1 = client.post(\n    |                      ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    |     recipient = await db.users.find_one({\"username\": message_data.toUsername})\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestMessageIntegration object at 0x10db4c770>\nclient = <starlette.testclient.TestClient object at 0x10ddfe150>\ntest_users = [{'_id': ObjectId('68efce949ecea2e269cb53fa'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce949ecea2e269cb53fd'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\ncleanup_messages = None\n\n    def test_full_conversation_workflow(self, client, test_users, cleanup_messages):\n        \"\"\"Test complete workflow: send messages, retrieve conversation\"\"\"\n        # Send message from user1 to user2\n>       send_response1 = client.post(\n            \"/api/users/messages/send?username=user1\",\n            json={\"toUsername\": \"user2\", \"content\": \"Hello\"}\n        )\n\ntests/test_messages.py:449: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nmessage_data = MessageCreate(toUsername='user2', content='Hello')\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/messages/send\")\n    async def send_message_enhanced(\n        message_data: MessageCreate,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Send a message with privacy checks and profanity filtering\"\"\"\n        logger.info(f\"\ud83d\udcac Enhanced message from {username} to {message_data.toUsername}\")\n    \n        # Check for profanity FIRST\n        from profanity_filter import check_message_content\n        content_check = check_message_content(message_data.content)\n    \n        if not content_check[\"is_clean\"]:\n            # Log violation\n            logger.warning(\n                f\"\u26a0\ufe0f Profanity detected from {username}: \"\n                f\"violations={content_check['violations']}, severity={content_check['severity']}\"\n            )\n    \n            # Record violation in database\n            await db.content_violations.insert_one({\n                \"username\": username,\n                \"type\": \"message_profanity\",\n                \"content\": message_data.content,\n                \"violations\": content_check[\"violations\"],\n                \"severity\": content_check[\"severity\"],\n                \"recipient\": message_data.toUsername,\n                \"timestamp\": datetime.utcnow()\n            })\n    \n            # Check user's violation count\n            violation_count = await db.content_violations.count_documents({\n                \"username\": username,\n                \"type\": \"message_profanity\"\n            })\n    \n            # Enforce consequences based on violation count\n            if violation_count >= 3:\n                # 3rd strike - ban user\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"banned\", \"reason\": \"Repeated profanity violations\"}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been banned due to repeated violations of community guidelines.\"\n                )\n            elif violation_count >= 2:\n                # 2nd strike - suspend for 7 days\n                from datetime import timedelta\n                suspend_until = datetime.utcnow() + timedelta(days=7)\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"suspended\", \"until\": suspend_until.isoformat()}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been suspended for 7 days due to inappropriate language. \"\n                           \"This is your second violation. A third violation will result in permanent ban.\"\n                )\n            else:\n                # 1st strike - reject message with warning\n                raise HTTPException(\n                    status_code=400,\n                    detail=\"\u26a0\ufe0f Your message contains inappropriate content. Please maintain professional \"\n                           \"communication. Repeated violations will result in account suspension or ban.\"\n                )\n    \n        # Check if recipient exists\n>       recipient = await db.users.find_one({\"username\": message_data.toUsername})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2357: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:52,579 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/messages/send\n2025-10-15 09:40:52,580 - routes - INFO - \ud83d\udcac Enhanced message from user1 to user2\n2025-10-15 09:40:52,580 - main - ERROR - \u274c Error processing POST /api/users/messages/send - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/messages/send\nINFO     routes:routes.py:2294 \ud83d\udcac Enhanced message from user1 to user2\nERROR    main:main.py:131 \u274c Error processing POST /api/users/messages/send - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n____________ TestMessageIntegration.test_block_user_hides_messages _____________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py\", line 475, in test_block_user_hides_messages\n    |     client.post(\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    |     recipient = await db.users.find_one({\"username\": message_data.toUsername})\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_messages.TestMessageIntegration object at 0x10db17860>\nclient = <starlette.testclient.TestClient object at 0x10f5fd1c0>\ntest_users = [{'_id': ObjectId('68efce949ecea2e269cb53ff'), 'contactEmail': 'user1@test.com', 'firstName': 'User', 'lastName': 'One...ctId('68efce949ecea2e269cb5402'), 'contactEmail': 'blocked@test.com', 'firstName': 'Blocked', 'lastName': 'User', ...}]\ncleanup_messages = None\n\n    def test_block_user_hides_messages(self, client, test_users, cleanup_messages):\n        \"\"\"Test that blocking a user hides existing messages\"\"\"\n        # Send messages\n>       client.post(\n            \"/api/users/messages/send?username=user1\",\n            json={\"toUsername\": \"user2\", \"content\": \"Before block\"}\n        )\n\ntests/test_messages.py:475: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nmessage_data = MessageCreate(toUsername='user2', content='Before block')\nusername = 'user1'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/messages/send\")\n    async def send_message_enhanced(\n        message_data: MessageCreate,\n        username: str = Query(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Send a message with privacy checks and profanity filtering\"\"\"\n        logger.info(f\"\ud83d\udcac Enhanced message from {username} to {message_data.toUsername}\")\n    \n        # Check for profanity FIRST\n        from profanity_filter import check_message_content\n        content_check = check_message_content(message_data.content)\n    \n        if not content_check[\"is_clean\"]:\n            # Log violation\n            logger.warning(\n                f\"\u26a0\ufe0f Profanity detected from {username}: \"\n                f\"violations={content_check['violations']}, severity={content_check['severity']}\"\n            )\n    \n            # Record violation in database\n            await db.content_violations.insert_one({\n                \"username\": username,\n                \"type\": \"message_profanity\",\n                \"content\": message_data.content,\n                \"violations\": content_check[\"violations\"],\n                \"severity\": content_check[\"severity\"],\n                \"recipient\": message_data.toUsername,\n                \"timestamp\": datetime.utcnow()\n            })\n    \n            # Check user's violation count\n            violation_count = await db.content_violations.count_documents({\n                \"username\": username,\n                \"type\": \"message_profanity\"\n            })\n    \n            # Enforce consequences based on violation count\n            if violation_count >= 3:\n                # 3rd strike - ban user\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"banned\", \"reason\": \"Repeated profanity violations\"}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been banned due to repeated violations of community guidelines.\"\n                )\n            elif violation_count >= 2:\n                # 2nd strike - suspend for 7 days\n                from datetime import timedelta\n                suspend_until = datetime.utcnow() + timedelta(days=7)\n                await db.users.update_one(\n                    {\"username\": username},\n                    {\"$set\": {\"status\": {\"status\": \"suspended\", \"until\": suspend_until.isoformat()}}}\n                )\n                raise HTTPException(\n                    status_code=403,\n                    detail=\"Your account has been suspended for 7 days due to inappropriate language. \"\n                           \"This is your second violation. A third violation will result in permanent ban.\"\n                )\n            else:\n                # 1st strike - reject message with warning\n                raise HTTPException(\n                    status_code=400,\n                    detail=\"\u26a0\ufe0f Your message contains inappropriate content. Please maintain professional \"\n                           \"communication. Repeated violations will result in account suspension or ban.\"\n                )\n    \n        # Check if recipient exists\n>       recipient = await db.users.find_one({\"username\": message_data.toUsername})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2357: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:53,029 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/messages/send\n2025-10-15 09:40:53,029 - routes - INFO - \ud83d\udcac Enhanced message from user1 to user2\n2025-10-15 09:40:53,030 - main - ERROR - \u274c Error processing POST /api/users/messages/send - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/messages/send\nINFO     routes:routes.py:2294 \ud83d\udcac Enhanced message from user1 to user2\nERROR    main:main.py:131 \u274c Error processing POST /api/users/messages/send - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2357, in send_message_enhanced\n    recipient = await db.users.find_one({\"username\": message_data.toUsername})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n__________________ TestUserBase.test_valid_user_base_creation __________________\n\nself = <test_models.TestUserBase object at 0x10db4d640>\n\n    def test_valid_user_base_creation(self):\n        \"\"\"Test creating a valid UserBase instance.\"\"\"\n        user_data = {\n            \"username\": \"testuser\",\n            \"firstName\": \"Test\",\n            \"lastName\": \"User\",\n            \"contactEmail\": \"test@example.com\",\n            \"sex\": \"Male\",\n            \"eatingPreference\": \"Vegetarian\",\n            \"citizenshipStatus\": \"Citizen\"\n        }\n>       user = UserBase(**user_data)\nE       pydantic_core._pydantic_core.ValidationError: 1 validation error for UserBase\nE       state\nE         Field required [type=missing, input_value={'username': 'testuser', ...nshipStatus': 'Citizen'}, input_type=dict]\nE           For further information visit https://errors.pydantic.dev/2.5/v/missing\n\ntests/test_models.py:33: ValidationError\n_______________________ TestUserBase.test_sex_validation _______________________\n\nself = <test_models.TestUserBase object at 0x10db4da30>\n\n    def test_sex_validation(self):\n        \"\"\"Test sex field validation.\"\"\"\n        # Valid values\n>       assert UserBase(username=\"testuser\", sex=\"Male\").sex == \"Male\"\nE       pydantic_core._pydantic_core.ValidationError: 1 validation error for UserBase\nE       state\nE         Field required [type=missing, input_value={'username': 'testuser', 'sex': 'Male'}, input_type=dict]\nE           For further information visit https://errors.pydantic.dev/2.5/v/missing\n\ntests/test_models.py:55: ValidationError\n________________ TestUserBase.test_eating_preference_validation ________________\n\nself = <test_models.TestUserBase object at 0x10db4db80>\n\n    def test_eating_preference_validation(self):\n        \"\"\"Test eating preference validation.\"\"\"\n        valid_preferences = [\"Vegetarian\", \"Eggetarian\", \"Non-Veg\", \"Others\", \"\"]\n    \n        for pref in valid_preferences:\n>           user = UserBase(username=\"testuser\", eatingPreference=pref)\nE           pydantic_core._pydantic_core.ValidationError: 1 validation error for UserBase\nE           state\nE             Field required [type=missing, input_value={'username': 'testuser', ...eference': 'Vegetarian'}, input_type=dict]\nE               For further information visit https://errors.pydantic.dev/2.5/v/missing\n\ntests/test_models.py:68: ValidationError\n_______________ TestUserBase.test_citizenship_status_validation ________________\n\nself = <test_models.TestUserBase object at 0x10db4dcd0>\n\n    def test_citizenship_status_validation(self):\n        \"\"\"Test citizenship status validation.\"\"\"\n        valid_statuses = [\"Citizen\", \"Greencard\", \"\"]\n    \n        for status in valid_statuses:\n>           user = UserBase(username=\"testuser\", citizenshipStatus=status)\nE           pydantic_core._pydantic_core.ValidationError: 1 validation error for UserBase\nE           state\nE             Field required [type=missing, input_value={'username': 'testuser', ...nshipStatus': 'Citizen'}, input_type=dict]\nE               For further information visit https://errors.pydantic.dev/2.5/v/missing\n\ntests/test_models.py:80: ValidationError\n____________________ TestUserCreate.test_valid_user_create _____________________\n\nself = <test_models.TestUserCreate object at 0x10db4dfa0>\n\n    def test_valid_user_create(self):\n        \"\"\"Test creating a valid UserCreate instance.\"\"\"\n        user_data = {\n            \"username\": \"testuser\",\n            \"password\": \"testpass123\",\n            \"firstName\": \"Test\",\n            \"contactEmail\": \"test@example.com\"\n        }\n>       user = UserCreate(**user_data)\nE       pydantic_core._pydantic_core.ValidationError: 1 validation error for UserCreate\nE       state\nE         Field required [type=missing, input_value={'username': 'testuser', ...il': 'test@example.com'}, input_type=dict]\nE           For further information visit https://errors.pydantic.dev/2.5/v/missing\n\ntests/test_models.py:99: ValidationError\n______________________ TestUserInDB.test_valid_user_in_db ______________________\n\nself = <test_models.TestUserInDB object at 0x10db4d910>\n\n    def test_valid_user_in_db(self):\n        \"\"\"Test creating a valid UserInDB instance.\"\"\"\n        user_data = {\n            \"username\": \"testuser\",\n            \"password\": \"hashedpassword\",\n            \"firstName\": \"Test\",\n            \"contactEmail\": \"test@example.com\"\n        }\n>       user = UserInDB(**user_data)\nE       pydantic_core._pydantic_core.ValidationError: 1 validation error for UserInDB\nE       state\nE         Field required [type=missing, input_value={'username': 'testuser', ...il': 'test@example.com'}, input_type=dict]\nE           For further information visit https://errors.pydantic.dev/2.5/v/missing\n\ntests/test_models.py:120: ValidationError\n__________________ TestUserResponse.test_valid_user_response ___________________\n\nself = <test_models.TestUserResponse object at 0x10db4e330>\n\n    def test_valid_user_response(self):\n        \"\"\"Test creating a valid UserResponse instance.\"\"\"\n        user_data = {\n            \"username\": \"testuser\",\n            \"firstName\": \"Test\",\n            \"createdAt\": datetime.utcnow(),\n            \"updatedAt\": datetime.utcnow()\n        }\n>       user = UserResponse(**user_data)\nE       pydantic_core._pydantic_core.ValidationError: 1 validation error for UserResponse\nE       state\nE         Field required [type=missing, input_value={'username': 'testuser', ...15, 16, 40, 53, 489845)}, input_type=dict]\nE           For further information visit https://errors.pydantic.dev/2.5/v/missing\n\ntests/test_models.py:138: ValidationError\n___________ TestProfileViewTracking.test_track_profile_view_success ____________\n\nself = <test_profile_views.TestProfileViewTracking object at 0x10db83830>\ntest_users = [{'_id': ObjectId('68efce959ecea2e269cb5406'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce959ecea2e269cb5408'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_track_profile_view_success(self, test_users, cleanup_profile_views):\n        \"\"\"Test successfully tracking a profile view\"\"\"\n>       response = client.post(\n            \"/api/users/profile-views\",\n            json={\n                \"profileUsername\": \"profile_owner\",\n                \"viewedByUsername\": \"viewer1\"\n            }\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:61: NameError\n_____________ TestProfileViewTracking.test_track_self_view_ignored _____________\n\nself = <test_profile_views.TestProfileViewTracking object at 0x10dbaddc0>\ntest_users = [{'_id': ObjectId('68efce959ecea2e269cb540a'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce959ecea2e269cb540c'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_track_self_view_ignored(self, test_users, cleanup_profile_views):\n        \"\"\"Test that self-views are not tracked\"\"\"\n>       response = client.post(\n            \"/api/users/profile-views\",\n            json={\n                \"profileUsername\": \"viewer1\",\n                \"viewedByUsername\": \"viewer1\"\n            }\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:76: NameError\n_________ TestProfileViewTracking.test_track_view_nonexistent_profile __________\n\nself = <test_profile_views.TestProfileViewTracking object at 0x10dbacb90>\ntest_users = [{'_id': ObjectId('68efce959ecea2e269cb540e'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce959ecea2e269cb5410'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_track_view_nonexistent_profile(self, test_users, cleanup_profile_views):\n        \"\"\"Test tracking view for non-existent profile\"\"\"\n>       response = client.post(\n            \"/api/users/profile-views\",\n            json={\n                \"profileUsername\": \"nonexistent\",\n                \"viewedByUsername\": \"viewer1\"\n            }\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:90: NameError\n__________ TestProfileViewTracking.test_track_view_nonexistent_viewer __________\n\nself = <test_profile_views.TestProfileViewTracking object at 0x10dbac5f0>\ntest_users = [{'_id': ObjectId('68efce959ecea2e269cb5412'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce959ecea2e269cb5414'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_track_view_nonexistent_viewer(self, test_users, cleanup_profile_views):\n        \"\"\"Test tracking view by non-existent viewer\"\"\"\n>       response = client.post(\n            \"/api/users/profile-views\",\n            json={\n                \"profileUsername\": \"profile_owner\",\n                \"viewedByUsername\": \"nonexistent\"\n            }\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:103: NameError\n___ TestProfileViewTracking.test_duplicate_view_within_24h_updates_timestamp ___\n\nself = <test_profile_views.TestProfileViewTracking object at 0x10dbac260>\ntest_users = [{'_id': ObjectId('68efce969ecea2e269cb5416'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce969ecea2e269cb5418'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_duplicate_view_within_24h_updates_timestamp(self, test_users, cleanup_profile_views):\n        \"\"\"Test that duplicate views within 24h update timestamp instead of creating new record\"\"\"\n        # First view\n>       response1 = client.post(\n            \"/api/users/profile-views\",\n            json={\n                \"profileUsername\": \"profile_owner\",\n                \"viewedByUsername\": \"viewer1\"\n            }\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:117: NameError\n_______ TestProfileViewTracking.test_multiple_viewers_tracked_separately _______\n\nself = <test_profile_views.TestProfileViewTracking object at 0x10dbae000>\ntest_users = [{'_id': ObjectId('68efce969ecea2e269cb541a'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce969ecea2e269cb541c'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_multiple_viewers_tracked_separately(self, test_users, cleanup_profile_views):\n        \"\"\"Test that multiple viewers are tracked separately\"\"\"\n        # Viewer 1\n>       response1 = client.post(\n            \"/api/users/profile-views\",\n            json={\n                \"profileUsername\": \"profile_owner\",\n                \"viewedByUsername\": \"viewer1\"\n            }\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:141: NameError\n______________ TestGetProfileViews.test_get_profile_views_success ______________\n\nself = <test_profile_views.TestGetProfileViews object at 0x10dbae390>\ntest_users = [{'_id': ObjectId('68efce969ecea2e269cb541e'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce969ecea2e269cb5420'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\nsample_views = [{'_id': ObjectId('68efce969ecea2e269cb5421'), 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 54, 327879), 'prof...54, 327889), 'profileUsername': 'profile_owner', 'viewedAt': datetime.datetime(2025, 10, 15, 14, 40, 54, 327882), ...}]\ncleanup_profile_views = None\n\n    def test_get_profile_views_success(self, test_users, sample_views, cleanup_profile_views):\n        \"\"\"Test successfully retrieving profile views\"\"\"\n>       response = client.get(\"/api/users/profile-views/profile_owner\")\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:189: NameError\n______ TestGetProfileViews.test_get_profile_views_includes_viewer_details ______\n\nself = <test_profile_views.TestGetProfileViews object at 0x10dbae510>\ntest_users = [{'_id': ObjectId('68efce969ecea2e269cb5424'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce969ecea2e269cb5426'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\nsample_views = [{'_id': ObjectId('68efce969ecea2e269cb5427'), 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 54, 547887), 'prof...54, 547896), 'profileUsername': 'profile_owner', 'viewedAt': datetime.datetime(2025, 10, 15, 14, 40, 54, 547889), ...}]\ncleanup_profile_views = None\n\n    def test_get_profile_views_includes_viewer_details(self, test_users, sample_views, cleanup_profile_views):\n        \"\"\"Test that profile views include viewer profile details\"\"\"\n>       response = client.get(\"/api/users/profile-views/profile_owner\")\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:201: NameError\n_________ TestGetProfileViews.test_get_profile_views_sorted_by_recent __________\n\nself = <test_profile_views.TestGetProfileViews object at 0x10dbae6f0>\ntest_users = [{'_id': ObjectId('68efce969ecea2e269cb542a'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce969ecea2e269cb542c'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\nsample_views = [{'_id': ObjectId('68efce969ecea2e269cb542d'), 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 54, 799164), 'prof...54, 799174), 'profileUsername': 'profile_owner', 'viewedAt': datetime.datetime(2025, 10, 15, 14, 40, 54, 799167), ...}]\ncleanup_profile_views = None\n\n    def test_get_profile_views_sorted_by_recent(self, test_users, sample_views, cleanup_profile_views):\n        \"\"\"Test that profile views are sorted by most recent first\"\"\"\n>       response = client.get(\"/api/users/profile-views/profile_owner\")\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:215: NameError\n____________ TestGetProfileViews.test_get_profile_views_with_limit _____________\n\nself = <test_profile_views.TestGetProfileViews object at 0x10dbae8d0>\ntest_users = [{'_id': ObjectId('68efce969ecea2e269cb5430'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce969ecea2e269cb5432'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\nsample_views = [{'_id': ObjectId('68efce969ecea2e269cb5433'), 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 54, 998416), 'prof...54, 998426), 'profileUsername': 'profile_owner', 'viewedAt': datetime.datetime(2025, 10, 15, 14, 40, 54, 998419), ...}]\ncleanup_profile_views = None\n\n    def test_get_profile_views_with_limit(self, test_users, sample_views, cleanup_profile_views):\n        \"\"\"Test retrieving profile views with limit parameter\"\"\"\n>       response = client.get(\"/api/users/profile-views/profile_owner?limit=1\")\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:226: NameError\n_______________ TestGetProfileViews.test_get_profile_views_empty _______________\n\nself = <test_profile_views.TestGetProfileViews object at 0x10dbaeab0>\ntest_users = [{'_id': ObjectId('68efce979ecea2e269cb5436'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce979ecea2e269cb5438'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_get_profile_views_empty(self, test_users, cleanup_profile_views):\n        \"\"\"Test retrieving profile views when none exist\"\"\"\n>       response = client.get(\"/api/users/profile-views/profile_owner\")\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:235: NameError\n_______________ TestProfileViewCount.test_get_view_count_success _______________\n\nself = <test_profile_views.TestProfileViewCount object at 0x10dbaee70>\ntest_users = [{'_id': ObjectId('68efce979ecea2e269cb543a'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce979ecea2e269cb543c'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\nmultiple_views = [{'_id': ObjectId('68efce979ecea2e269cb543d'), 'createdAt': datetime.datetime(2025, 10, 15, 16, 40, 55, 298371), 'prof...55, 298385), 'profileUsername': 'profile_owner', 'viewedAt': datetime.datetime(2025, 10, 15, 16, 40, 55, 298383), ...}]\ncleanup_profile_views = None\n\n    def test_get_view_count_success(self, test_users, multiple_views, cleanup_profile_views):\n        \"\"\"Test getting profile view count statistics\"\"\"\n>       response = client.get(\"/api/users/profile-views/profile_owner/count\")\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:274: NameError\n______________ TestProfileViewCount.test_get_view_count_no_views _______________\n\nself = <test_profile_views.TestProfileViewCount object at 0x10dbaeff0>\ntest_users = [{'_id': ObjectId('68efce979ecea2e269cb5441'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce979ecea2e269cb5443'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_get_view_count_no_views(self, test_users, cleanup_profile_views):\n        \"\"\"Test getting view count when no views exist\"\"\"\n>       response = client.get(\"/api/users/profile-views/profile_owner/count\")\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:285: NameError\n__________ TestProfileViewIntegration.test_full_profile_view_workflow __________\n\nself = <test_profile_views.TestProfileViewIntegration object at 0x10dbaf350>\ntest_users = [{'_id': ObjectId('68efce979ecea2e269cb5445'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce979ecea2e269cb5447'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_full_profile_view_workflow(self, test_users, cleanup_profile_views):\n        \"\"\"Test complete workflow: track view, retrieve views, get count\"\"\"\n        # Step 1: Track a view\n>       track_response = client.post(\n            \"/api/users/profile-views\",\n            json={\n                \"profileUsername\": \"profile_owner\",\n                \"viewedByUsername\": \"viewer1\"\n            }\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:298: NameError\n__________ TestProfileViewIntegration.test_multiple_profiles_isolated __________\n\nself = <test_profile_views.TestProfileViewIntegration object at 0x10dbaf4a0>\ntest_users = [{'_id': ObjectId('68efce979ecea2e269cb5449'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce979ecea2e269cb544b'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_multiple_profiles_isolated(self, test_users, cleanup_profile_views):\n        \"\"\"Test that views for different profiles are isolated\"\"\"\n        # Track view for profile_owner\n>       client.post(\n            \"/api/users/profile-views\",\n            json={\n                \"profileUsername\": \"profile_owner\",\n                \"viewedByUsername\": \"viewer1\"\n            }\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:321: NameError\n____________ TestProfileViewEdgeCases.test_invalid_username_format _____________\n\nself = <test_profile_views.TestProfileViewEdgeCases object at 0x10dbae420>\ncleanup_profile_views = None\n\n    def test_invalid_username_format(self, cleanup_profile_views):\n        \"\"\"Test handling of invalid username format\"\"\"\n>       response = client.post(\n            \"/api/users/profile-views\",\n            json={\n                \"profileUsername\": \"\",\n                \"viewedByUsername\": \"viewer1\"\n            }\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:351: NameError\n____________ TestProfileViewEdgeCases.test_missing_required_fields _____________\n\nself = <test_profile_views.TestProfileViewEdgeCases object at 0x10dbac560>\ncleanup_profile_views = None\n\n    def test_missing_required_fields(self, cleanup_profile_views):\n        \"\"\"Test handling of missing required fields\"\"\"\n>       response = client.post(\n            \"/api/users/profile-views\",\n            json={\"profileUsername\": \"profile_owner\"}\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:363: NameError\n____________ TestProfileViewEdgeCases.test_get_views_invalid_limit _____________\n\nself = <test_profile_views.TestProfileViewEdgeCases object at 0x10dbaf5f0>\ntest_users = [{'_id': ObjectId('68efce979ecea2e269cb544f'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce979ecea2e269cb5451'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_get_views_invalid_limit(self, test_users, cleanup_profile_views):\n        \"\"\"Test handling of invalid limit parameter\"\"\"\n>       response = client.get(\"/api/users/profile-views/profile_owner?limit=0\")\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:371: NameError\n___________ TestProfileViewEdgeCases.test_get_views_excessive_limit ____________\n\nself = <test_profile_views.TestProfileViewEdgeCases object at 0x10dbaf7a0>\ntest_users = [{'_id': ObjectId('68efce979ecea2e269cb5453'), 'contactEmail': 'viewer1@test.com', 'firstName': 'John', 'lastName': 'V...ectId('68efce979ecea2e269cb5455'), 'contactEmail': 'owner@test.com', 'firstName': 'Profile', 'lastName': 'Owner', ...}]\ncleanup_profile_views = None\n\n    def test_get_views_excessive_limit(self, test_users, cleanup_profile_views):\n        \"\"\"Test handling of excessive limit parameter\"\"\"\n>       response = client.get(\"/api/users/profile-views/profile_owner?limit=1000\")\nE       NameError: name 'client' is not defined\n\ntests/test_profile_views.py:376: NameError\n_______________ TestUserRegistration.test_register_user_success ________________\n\nself = <test_routes_integration.TestUserRegistration object at 0x10dbd4a10>\nclient = <starlette.testclient.TestClient object at 0x10ef6eb10>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_register_user_success(self, client, sample_user_data):\n        \"\"\"Test successful user registration.\"\"\"\n        response = client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n>       assert response.status_code == 201\nE       assert 422 == 201\nE        +  where 422 = <Response [422 Unprocessable Entity]>.status_code\n\ntests/test_routes_integration.py:19: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:56,009 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:56,011 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:56,012 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n__________ TestUserRegistration.test_register_user_duplicate_username __________\n\nself = <test_routes_integration.TestUserRegistration object at 0x10dbd4b60>\nclient = <starlette.testclient.TestClient object at 0x10ef6ed50>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_register_user_duplicate_username(self, client, sample_user_data):\n        \"\"\"Test registration with duplicate username.\"\"\"\n        # Register first user\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        # Try to register again with same username\n        response = client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n>       assert response.status_code == 409\nE       assert 422 == 409\nE        +  where 422 = <Response [422 Unprocessable Entity]>.status_code\n\ntests/test_routes_integration.py:39: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:56,032 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:56,034 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:56,035 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:56,036 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:56,037 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:56,038 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n___________ TestUserRegistration.test_register_user_duplicate_email ____________\n\nself = <test_routes_integration.TestUserRegistration object at 0x10dbd4d10>\nclient = <starlette.testclient.TestClient object at 0x10f154ef0>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_register_user_duplicate_email(self, client, sample_user_data):\n        \"\"\"Test registration with duplicate email.\"\"\"\n        # Register first user\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        # Register second user with same email\n        user_data_2 = sample_user_data.copy()\n        user_data_2[\"username\"] = \"user2\"\n    \n        response = client.post(\n            \"/api/users/register\",\n            data=user_data_2\n        )\n    \n>       assert response.status_code == 409\nE       assert 422 == 409\nE        +  where 422 = <Response [422 Unprocessable Entity]>.status_code\n\ntests/test_routes_integration.py:59: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:56,051 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:56,052 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:56,053 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:56,054 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:56,055 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:56,056 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n___________ TestUserRegistration.test_register_user_too_many_images ____________\n\nself = <test_routes_integration.TestUserRegistration object at 0x10dbaf6e0>\nclient = <starlette.testclient.TestClient object at 0x10f1a1f10>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_register_user_too_many_images(self, client, sample_user_data):\n        \"\"\"Test registration with too many images.\"\"\"\n        # Create 6 mock image files\n        files = []\n        for i in range(6):\n            files.append((\"images\", (f\"test{i}.jpg\", b\"fake image content\", \"image/jpeg\")))\n    \n        response = client.post(\n            \"/api/users/register\",\n            data=sample_user_data,\n            files=files\n        )\n    \n>       assert response.status_code == 400\nE       assert 422 == 400\nE        +  where 422 = <Response [422 Unprocessable Entity]>.status_code\n\ntests/test_routes_integration.py:91: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:56,091 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:56,094 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.003s\n2025-10-15 09:40:56,094 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.003s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n_______________________ TestUserLogin.test_login_success _______________________\n\nself = <test_routes_integration.TestUserLogin object at 0x10dbd4800>\nclient = <starlette.testclient.TestClient object at 0x10f1a04a0>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\nsample_login_data = {'password': 'testpass123', 'username': 'testuser'}\n\n    def test_login_success(self, client, sample_user_data, sample_login_data):\n        \"\"\"Test successful user login.\"\"\"\n        # Register user first\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        # Login\n        response = client.post(\"/api/users/login\", data=sample_login_data)\n    \n>       assert response.status_code == 200\nE       assert 422 == 200\nE        +  where 422 = <Response [422 Unprocessable Entity]>.status_code\n\ntests/test_routes_integration.py:109: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:56,109 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:56,110 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:56,111 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:56,112 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/login\n2025-10-15 09:40:56,113 - main - INFO - \u274c POST /api/users/login - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:56,114 - httpx - INFO - HTTP Request: POST http://testserver/api/users/login \"HTTP/1.1 422 Unprocessable Entity\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/login\nINFO     main:main.py:122 \u274c POST /api/users/login - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/login \"HTTP/1.1 422 Unprocessable Entity\"\n_________________ TestUserLogin.test_login_invalid_credentials _________________\n\nself = <test_routes_integration.TestUserLogin object at 0x10dbd49e0>\nclient = <starlette.testclient.TestClient object at 0x10efd2f60>\n\n    def test_login_invalid_credentials(self, client):\n        \"\"\"Test login with invalid credentials.\"\"\"\n        login_data = {\n            \"username\": \"nonexistent\",\n            \"password\": \"wrongpassword\"\n        }\n    \n        response = client.post(\"/api/users/login\", data=login_data)\n    \n>       assert response.status_code == 400\nE       assert 422 == 400\nE        +  where 422 = <Response [422 Unprocessable Entity]>.status_code\n\ntests/test_routes_integration.py:124: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:56,132 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/login\n2025-10-15 09:40:56,133 - main - INFO - \u274c POST /api/users/login - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:56,134 - httpx - INFO - HTTP Request: POST http://testserver/api/users/login \"HTTP/1.1 422 Unprocessable Entity\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/login\nINFO     main:main.py:122 \u274c POST /api/users/login - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/login \"HTTP/1.1 422 Unprocessable Entity\"\n____________________ TestUserLogin.test_login_admin_success ____________________\n\nself = <test_routes_integration.TestUserLogin object at 0x10dbd4da0>\nclient = <starlette.testclient.TestClient object at 0x10efcb800>\n\n    def test_login_admin_success(self, client):\n        \"\"\"Test admin login with hardcoded credentials.\"\"\"\n        login_data = {\n            \"username\": \"admin\",\n            \"password\": \"admin\"\n        }\n    \n        response = client.post(\"/api/users/login\", data=login_data)\n    \n>       assert response.status_code == 200\nE       assert 422 == 200\nE        +  where 422 = <Response [422 Unprocessable Entity]>.status_code\n\ntests/test_routes_integration.py:136: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:56,148 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/login\n2025-10-15 09:40:56,151 - main - INFO - \u274c POST /api/users/login - Status: 422 - Duration: 0.003s\n2025-10-15 09:40:56,152 - httpx - INFO - HTTP Request: POST http://testserver/api/users/login \"HTTP/1.1 422 Unprocessable Entity\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/login\nINFO     main:main.py:122 \u274c POST /api/users/login - Status: 422 - Duration: 0.003s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/login \"HTTP/1.1 422 Unprocessable Entity\"\n__________________ TestUserProfile.test_get_user_profile_own ___________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 155, in test_get_user_profile_own\n    |     response = client.get(f\"/api/users/profile/{sample_user_data['username']}\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    |     user = await db.users.find_one({\"username\": username})\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestUserProfile object at 0x10dbd5550>\nclient = <starlette.testclient.TestClient object at 0x10efc8ad0>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_get_user_profile_own(self, client, sample_user_data):\n        \"\"\"Test getting own profile.\"\"\"\n        # Register user\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        # Get profile as self\n>       response = client.get(f\"/api/users/profile/{sample_user_data['username']}\")\n\ntests/test_routes_integration.py:155: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'testuser', requester = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/profile/{username}\")\n    async def get_user_profile(username: str, requester: str = None, db = Depends(get_database)):\n        \"\"\"Get user profile by username with PII masking\"\"\"\n        logger.info(f\"\ud83d\udc64 Profile request for username: {username} (requester: {requester})\")\n    \n        # Find user\n        logger.debug(f\"Fetching profile for user '{username}'...\")\n>       user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:484: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:56,183 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:56,184 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\n2025-10-15 09:40:56,185 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:56,186 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/profile/testuser\n2025-10-15 09:40:56,187 - routes - INFO - \ud83d\udc64 Profile request for username: testuser (requester: None)\n2025-10-15 09:40:56,187 - main - ERROR - \u274c Error processing GET /api/users/profile/testuser - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/profile/testuser\nINFO     routes:routes.py:480 \ud83d\udc64 Profile request for username: testuser (requester: None)\nERROR    main:main.py:131 \u274c Error processing GET /api/users/profile/testuser - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______________ TestUserProfile.test_get_user_profile_other_user _______________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 180, in test_get_user_profile_other_user\n    |     response = client.get(\n    |                ^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    |     user = await db.users.find_one({\"username\": username})\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestUserProfile object at 0x10dbd56a0>\nclient = <starlette.testclient.TestClient object at 0x10f1759d0>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_get_user_profile_other_user(self, client, sample_user_data):\n        \"\"\"Test getting another user's profile (should be masked).\"\"\"\n        # Register two users\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        user_data_2 = sample_user_data.copy()\n        user_data_2[\"username\"] = \"user2\"\n        user_data_2[\"contactEmail\"] = \"user2@example.com\"\n    \n        client.post(\n            \"/api/users/register\",\n            data=user_data_2\n        )\n    \n        # Get first user's profile as second user (should be masked)\n>       response = client.get(\n            f\"/api/users/profile/{sample_user_data['username']}\",\n            params={\"requester\": \"user2\"}\n        )\n\ntests/test_routes_integration.py:180: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'testuser', requester = 'user2'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/profile/{username}\")\n    async def get_user_profile(username: str, requester: str = None, db = Depends(get_database)):\n        \"\"\"Get user profile by username with PII masking\"\"\"\n        logger.info(f\"\ud83d\udc64 Profile request for username: {username} (requester: {requester})\")\n    \n        # Find user\n        logger.debug(f\"Fetching profile for user '{username}'...\")\n>       user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:484: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:56,530 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:56,532 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\n2025-10-15 09:40:56,533 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:56,534 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:56,536 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\n2025-10-15 09:40:56,537 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:56,538 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/profile/testuser\n2025-10-15 09:40:56,538 - routes - INFO - \ud83d\udc64 Profile request for username: testuser (requester: user2)\n2025-10-15 09:40:56,538 - main - ERROR - \u274c Error processing GET /api/users/profile/testuser - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/profile/testuser\nINFO     routes:routes.py:480 \ud83d\udc64 Profile request for username: testuser (requester: user2)\nERROR    main:main.py:131 \u274c Error processing GET /api/users/profile/testuser - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______________ TestUserProfile.test_get_user_profile_not_found ________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 193, in test_get_user_profile_not_found\n    |     response = client.get(\"/api/users/profile/nonexistent\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 502, in get\n    |     return super().get(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1055, in get\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    |     user = await db.users.find_one({\"username\": username})\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestUserProfile object at 0x10dbd5850>\nclient = <starlette.testclient.TestClient object at 0x10efcbc80>\n\n    def test_get_user_profile_not_found(self, client):\n        \"\"\"Test getting non-existent user profile.\"\"\"\n>       response = client.get(\"/api/users/profile/nonexistent\")\n\ntests/test_routes_integration.py:193: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:502: in get\n    return super().get(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1055: in get\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'nonexistent', requester = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.get(\"/profile/{username}\")\n    async def get_user_profile(username: str, requester: str = None, db = Depends(get_database)):\n        \"\"\"Get user profile by username with PII masking\"\"\"\n        logger.info(f\"\ud83d\udc64 Profile request for username: {username} (requester: {requester})\")\n    \n        # Find user\n        logger.debug(f\"Fetching profile for user '{username}'...\")\n>       user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:484: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:56,883 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/profile/nonexistent\n2025-10-15 09:40:56,883 - routes - INFO - \ud83d\udc64 Profile request for username: nonexistent (requester: None)\n2025-10-15 09:40:56,884 - main - ERROR - \u274c Error processing GET /api/users/profile/nonexistent - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/profile/nonexistent\nINFO     routes:routes.py:480 \ud83d\udc64 Profile request for username: nonexistent (requester: None)\nERROR    main:main.py:131 \u274c Error processing GET /api/users/profile/nonexistent - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 484, in get_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n___________________ TestUserProfile.test_update_user_profile ___________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 212, in test_update_user_profile\n    |     response = client.put(f\"/api/users/profile/{sample_user_data['username']}\", data=update_data)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 630, in put\n    |     return super().put(\n    |            ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1183, in put\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 575, in update_user_profile\n    |     user = await db.users.find_one({\"username\": username})\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestUserProfile object at 0x10dbd59d0>\nclient = <starlette.testclient.TestClient object at 0x10efd36e0>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_update_user_profile(self, client, sample_user_data):\n        \"\"\"Test updating user profile.\"\"\"\n        # Register user\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        # Update profile\n        update_data = {\n            \"firstName\": \"Updated\",\n            \"lastName\": \"Name\"\n        }\n    \n>       response = client.put(f\"/api/users/profile/{sample_user_data['username']}\", data=update_data)\n\ntests/test_routes_integration.py:212: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:630: in put\n    return super().put(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1183: in put\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'testuser', firstName = 'Updated', lastName = 'Name'\ncontactNumber = None, contactEmail = None, dob = None, dateOfBirth = None\nsex = None, gender = None, height = None, religion = None\nlanguagesSpoken = None, countryOfOrigin = None, countryOfResidence = None\nstate = None, caste = None, motherTongue = None, familyType = None\nfamilyValues = None, castePreference = None, eatingPreference = None\nlocation = None, education = None, educationHistory = None\nworkExperience = None, workLocation = None, linkedinUrl = None\nworkingStatus = None, workplace = None, citizenshipStatus = None\nrelationshipStatus = None, lookingFor = None, bodyType = None, drinking = None\nsmoking = None, hasChildren = None, wantsChildren = None, pets = None\ninterests = None, languages = None, familyBackground = None, aboutYou = None\naboutMe = None, partnerPreference = None, partnerCriteria = None, images = []\nimagesToDelete = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.put(\"/profile/{username}\")\n    async def update_user_profile(\n        username: str,\n        firstName: Optional[str] = Form(None),\n        lastName: Optional[str] = Form(None),\n        contactNumber: Optional[str] = Form(None),\n        contactEmail: Optional[str] = Form(None),\n        dob: Optional[str] = Form(None),\n        dateOfBirth: Optional[str] = Form(None),  # NEW: consistent naming\n        sex: Optional[str] = Form(None),\n        gender: Optional[str] = Form(None),  # NEW: consistent naming\n        height: Optional[str] = Form(None),\n        # Regional/Cultural fields\n        religion: Optional[str] = Form(None),  # NEW\n        languagesSpoken: Optional[str] = Form(None),  # NEW: JSON array\n        countryOfOrigin: Optional[str] = Form(None),  # NEW\n        countryOfResidence: Optional[str] = Form(None),  # NEW\n        state: Optional[str] = Form(None),  # NEW\n        caste: Optional[str] = Form(None),  # NEW: India-specific\n        motherTongue: Optional[str] = Form(None),  # NEW: India-specific\n        familyType: Optional[str] = Form(None),  # NEW\n        familyValues: Optional[str] = Form(None),  # NEW\n        castePreference: Optional[str] = Form(None),\n        eatingPreference: Optional[str] = Form(None),\n        location: Optional[str] = Form(None),\n        # Education & Work\n        education: Optional[str] = Form(None),\n        educationHistory: Optional[str] = Form(None),  # JSON string\n        workExperience: Optional[str] = Form(None),  # JSON string\n        workLocation: Optional[str] = Form(None),  # NEW\n        linkedinUrl: Optional[str] = Form(None),\n        workingStatus: Optional[str] = Form(None),\n        workplace: Optional[str] = Form(None),\n        citizenshipStatus: Optional[str] = Form(None),\n        # Personal/Lifestyle fields\n        relationshipStatus: Optional[str] = Form(None),  # NEW\n        lookingFor: Optional[str] = Form(None),  # NEW\n        bodyType: Optional[str] = Form(None),  # NEW\n        drinking: Optional[str] = Form(None),  # NEW\n        smoking: Optional[str] = Form(None),  # NEW\n        hasChildren: Optional[str] = Form(None),  # NEW\n        wantsChildren: Optional[str] = Form(None),  # NEW\n        pets: Optional[str] = Form(None),  # NEW\n        interests: Optional[str] = Form(None),  # NEW: comma-separated text\n        languages: Optional[str] = Form(None),  # NEW: comma-separated text (different from languagesSpoken)\n        # Background & About\n        familyBackground: Optional[str] = Form(None),\n        aboutYou: Optional[str] = Form(None),\n        aboutMe: Optional[str] = Form(None),  # NEW: consistent naming\n        partnerPreference: Optional[str] = Form(None),\n        partnerCriteria: Optional[str] = Form(None),  # NEW: JSON object with all criteria\n        images: List[UploadFile] = File(default=[]),\n        imagesToDelete: Optional[str] = Form(None),\n        db = Depends(get_database)\n    ):\n        \"\"\"Update user profile\"\"\"\n        logger.info(f\"\ud83d\udcdd Update request for user '{username}'\")\n    \n        # Find user\n        logger.debug(f\"Looking up user '{username}' for update...\")\n>       user = await db.users.find_one({\"username\": username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:575: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:57,233 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:57,234 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:57,235 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:57,236 - main - INFO - \ud83d\udce8 Incoming PUT request to /api/users/profile/testuser\n2025-10-15 09:40:57,237 - routes - INFO - \ud83d\udcdd Update request for user 'testuser'\n2025-10-15 09:40:57,238 - main - ERROR - \u274c Error processing PUT /api/users/profile/testuser - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 575, in update_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming PUT request to /api/users/profile/testuser\nINFO     routes:routes.py:571 \ud83d\udcdd Update request for user 'testuser'\nERROR    main:main.py:131 \u274c Error processing PUT /api/users/profile/testuser - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 575, in update_user_profile\n    user = await db.users.find_one({\"username\": username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n______________________ TestSearch.test_search_users_basic ______________________\n\nself = <test_routes_integration.TestSearch object at 0x10dbd5d60>\nclient = <starlette.testclient.TestClient object at 0x10efd18b0>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_search_users_basic(self, client, sample_user_data):\n        \"\"\"Test basic user search.\"\"\"\n        # Register test user\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        # Search for user\n        response = client.get(\n            \"/api/users/search\",\n            params={\"keyword\": sample_user_data[\"firstName\"]}\n        )\n    \n>       assert response.status_code == 200\nE       assert 500 == 200\nE        +  where 500 = <Response [500 Internal Server Error]>.status_code\n\ntests/test_routes_integration.py:238: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:57,683 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:57,684 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\n2025-10-15 09:40:57,685 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:57,686 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/search\n2025-10-15 09:40:57,687 - routes - INFO - \ud83d\udd0d Search request - keyword: 'Test', status_filter: '', page: 1, limit: 20\n2025-10-15 09:40:57,687 - routes - INFO - \ud83d\udd0d Executing search with query: {'status.status': {'$regex': '^active$', '$options': 'i'}, '$or': [{'firstName': {'$regex': 'Test', '$options': 'i'}}, {'lastName': {'$regex': 'Test', '$options': 'i'}}, {'username': {'$regex': 'Test', '$options': 'i'}}, {'location': {'$regex': 'Test', '$options': 'i'}}, {'education': {'$regex': 'Test', '$options': 'i'}}, {'occupation': {'$regex': 'Test', '$options': 'i'}}, {'aboutYou': {'$regex': 'Test', '$options': 'i'}}, {'bio': {'$regex': 'Test', '$options': 'i'}}, {'interests': {'$regex': 'Test', '$options': 'i'}}]}\n2025-10-15 09:40:57,688 - routes - ERROR - \u274c Search execution error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1263, in search_users\n    users = await users_cursor.to_list(length=limit)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\n2025-10-15 09:40:57,688 - main - INFO - \u274c GET /api/users/search - Status: 500 - Duration: 0.002s\n2025-10-15 09:40:57,690 - httpx - INFO - HTTP Request: GET http://testserver/api/users/search?keyword=Test \"HTTP/1.1 500 Internal Server Error\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/search\nINFO     routes:routes.py:1157 \ud83d\udd0d Search request - keyword: 'Test', status_filter: '', page: 1, limit: 20\nINFO     routes:routes.py:1261 \ud83d\udd0d Executing search with query: {'status.status': {'$regex': '^active$', '$options': 'i'}, '$or': [{'firstName': {'$regex': 'Test', '$options': 'i'}}, {'lastName': {'$regex': 'Test', '$options': 'i'}}, {'username': {'$regex': 'Test', '$options': 'i'}}, {'location': {'$regex': 'Test', '$options': 'i'}}, {'education': {'$regex': 'Test', '$options': 'i'}}, {'occupation': {'$regex': 'Test', '$options': 'i'}}, {'aboutYou': {'$regex': 'Test', '$options': 'i'}}, {'bio': {'$regex': 'Test', '$options': 'i'}}, {'interests': {'$regex': 'Test', '$options': 'i'}}]}\nERROR    routes:routes.py:1285 \u274c Search execution error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1263, in search_users\n    users = await users_cursor.to_list(length=limit)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nINFO     main:main.py:122 \u274c GET /api/users/search - Status: 500 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: GET http://testserver/api/users/search?keyword=Test \"HTTP/1.1 500 Internal Server Error\"\n__________________ TestSearch.test_search_users_with_filters ___________________\n\nself = <test_routes_integration.TestSearch object at 0x10dbd5d90>\nclient = <starlette.testclient.TestClient object at 0x10f2230b0>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_search_users_with_filters(self, client, sample_user_data):\n        \"\"\"Test search with filters.\"\"\"\n        # Register test user\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        # Search with gender filter\n        response = client.get(\n            \"/api/users/search\",\n            params={\n                \"gender\": sample_user_data[\"sex\"],\n                \"location\": sample_user_data[\"location\"]\n            }\n        )\n    \n>       assert response.status_code == 200\nE       assert 500 == 200\nE        +  where 500 = <Response [500 Internal Server Error]>.status_code\n\ntests/test_routes_integration.py:261: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:57,705 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:57,707 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\n2025-10-15 09:40:57,708 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:57,709 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/search\n2025-10-15 09:40:57,709 - routes - INFO - \ud83d\udd0d Search request - keyword: '', status_filter: '', page: 1, limit: 20\n2025-10-15 09:40:57,710 - routes - INFO - \ud83d\udd0d Executing search with query: {'status.status': {'$regex': '^active$', '$options': 'i'}, 'gender': {'$regex': '^Male$', '$options': 'i'}, 'location': {'$regex': 'Test City', '$options': 'i'}}\n2025-10-15 09:40:57,710 - routes - ERROR - \u274c Search execution error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1263, in search_users\n    users = await users_cursor.to_list(length=limit)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\n2025-10-15 09:40:57,711 - main - INFO - \u274c GET /api/users/search - Status: 500 - Duration: 0.002s\n2025-10-15 09:40:57,711 - httpx - INFO - HTTP Request: GET http://testserver/api/users/search?gender=Male&location=Test%20City \"HTTP/1.1 500 Internal Server Error\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/search\nINFO     routes:routes.py:1157 \ud83d\udd0d Search request - keyword: '', status_filter: '', page: 1, limit: 20\nINFO     routes:routes.py:1261 \ud83d\udd0d Executing search with query: {'status.status': {'$regex': '^active$', '$options': 'i'}, 'gender': {'$regex': '^Male$', '$options': 'i'}, 'location': {'$regex': 'Test City', '$options': 'i'}}\nERROR    routes:routes.py:1285 \u274c Search execution error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1263, in search_users\n    users = await users_cursor.to_list(length=limit)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nINFO     main:main.py:122 \u274c GET /api/users/search - Status: 500 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: GET http://testserver/api/users/search?gender=Male&location=Test%20City \"HTTP/1.1 500 Internal Server Error\"\n___________________ TestSearch.test_search_users_pagination ____________________\n\nself = <test_routes_integration.TestSearch object at 0x10dbd6060>\nclient = <starlette.testclient.TestClient object at 0x10f223a10>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_search_users_pagination(self, client, sample_user_data):\n        \"\"\"Test search pagination.\"\"\"\n        # Register test user\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        # Search with pagination\n        response = client.get(\n            \"/api/users/search\",\n            params={\"page\": 1, \"limit\": 10}\n        )\n    \n>       assert response.status_code == 200\nE       assert 500 == 200\nE        +  where 500 = <Response [500 Internal Server Error]>.status_code\n\ntests/test_routes_integration.py:279: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:57,733 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:57,735 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\n2025-10-15 09:40:57,736 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:57,737 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/search\n2025-10-15 09:40:57,738 - routes - INFO - \ud83d\udd0d Search request - keyword: '', status_filter: '', page: 1, limit: 10\n2025-10-15 09:40:57,738 - routes - INFO - \ud83d\udd0d Executing search with query: {'status.status': {'$regex': '^active$', '$options': 'i'}}\n2025-10-15 09:40:57,738 - routes - ERROR - \u274c Search execution error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1263, in search_users\n    users = await users_cursor.to_list(length=limit)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\n2025-10-15 09:40:57,739 - main - INFO - \u274c GET /api/users/search - Status: 500 - Duration: 0.002s\n2025-10-15 09:40:57,740 - httpx - INFO - HTTP Request: GET http://testserver/api/users/search?page=1&limit=10 \"HTTP/1.1 500 Internal Server Error\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/search\nINFO     routes:routes.py:1157 \ud83d\udd0d Search request - keyword: '', status_filter: '', page: 1, limit: 10\nINFO     routes:routes.py:1261 \ud83d\udd0d Executing search with query: {'status.status': {'$regex': '^active$', '$options': 'i'}}\nERROR    routes:routes.py:1285 \u274c Search execution error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1263, in search_users\n    users = await users_cursor.to_list(length=limit)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nINFO     main:main.py:122 \u274c GET /api/users/search - Status: 500 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: GET http://testserver/api/users/search?page=1&limit=10 \"HTTP/1.1 500 Internal Server Error\"\n_________________ TestAdminEndpoints.test_get_all_users_admin __________________\n\nself = <test_routes_integration.TestAdminEndpoints object at 0x10dbd63c0>\nclient = <starlette.testclient.TestClient object at 0x10f5d17c0>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_get_all_users_admin(self, client, sample_user_data):\n        \"\"\"Test getting all users as admin.\"\"\"\n        # Login as admin\n        admin_login = client.post(\"/api/users/login\", data={\n            \"username\": \"admin\",\n            \"password\": \"admin\"\n        })\n>       admin_token = admin_login.json()[\"access_token\"]\nE       KeyError: 'access_token'\n\ntests/test_routes_integration.py:296: KeyError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:57,754 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/login\n2025-10-15 09:40:57,756 - main - INFO - \u274c POST /api/users/login - Status: 422 - Duration: 0.002s\n2025-10-15 09:40:57,757 - httpx - INFO - HTTP Request: POST http://testserver/api/users/login \"HTTP/1.1 422 Unprocessable Entity\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/login\nINFO     main:main.py:122 \u274c POST /api/users/login - Status: 422 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/login \"HTTP/1.1 422 Unprocessable Entity\"\n________________ TestAccessRequests.test_create_access_request _________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 348, in test_create_access_request\n    |     response = client.post(\"/api/users/access-request\", data={\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1031, in create_pii_access_request\n    |     result = await create_access_request(db, requester, requested_user, message)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py\", line 173, in create_access_request\n    |     existing = await db.access_requests.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestAccessRequests object at 0x10dbd5a60>\nclient = <starlette.testclient.TestClient object at 0x10f54f350>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_create_access_request(self, client, sample_user_data):\n        \"\"\"Test creating PII access request.\"\"\"\n        # Register two users\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        user_data_2 = sample_user_data.copy()\n        user_data_2[\"username\"] = \"user2\"\n        client.post(\n            \"/api/users/register\",\n            data=user_data_2\n        )\n    \n        # Create access request\n>       response = client.post(\"/api/users/access-request\", data={\n            \"requester\": \"user2\",\n            \"requested_user\": sample_user_data[\"username\"],\n            \"message\": \"Please grant access\"\n        })\n\ntests/test_routes_integration.py:348: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\nroutes.py:1031: in create_pii_access_request\n    result = await create_access_request(db, requester, requested_user, message)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\nrequester_id = 'user2', requested_user_id = 'testuser'\nmessage = 'Please grant access'\n\n    async def create_access_request(db, requester_id, requested_user_id, message=None):\n        \"\"\"\n        Create a new PII access request\n    \n        Args:\n            db: Database connection\n            requester_id: Username of requester\n            requested_user_id: Username of profile owner\n            message: Optional message from requester\n    \n        Returns:\n            Created request document\n        \"\"\"\n        from datetime import datetime\n    \n        # Check if request already exists\n>       existing = await db.access_requests.find_one({\n            'requesterId': requester_id,\n            'requestedUserId': requested_user_id\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\npii_security.py:173: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:57,791 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:57,792 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\n2025-10-15 09:40:57,793 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:57,794 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:57,795 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:57,796 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:57,797 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/access-request\n2025-10-15 09:40:57,798 - routes - INFO - \ud83d\udd10 Access request: user2 \u2192 testuser\n2025-10-15 09:40:57,798 - main - ERROR - \u274c Error processing POST /api/users/access-request - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1031, in create_pii_access_request\n    result = await create_access_request(db, requester, requested_user, message)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py\", line 173, in create_access_request\n    existing = await db.access_requests.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/access-request\nINFO     routes:routes.py:1028 \ud83d\udd10 Access request: user2 \u2192 testuser\nERROR    main:main.py:131 \u274c Error processing POST /api/users/access-request - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1031, in create_pii_access_request\n    result = await create_access_request(db, requester, requested_user, message)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py\", line 173, in create_access_request\n    existing = await db.access_requests.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n___________ TestAccessRequests.test_create_duplicate_access_request ____________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 374, in test_create_duplicate_access_request\n    |     client.post(\"/api/users/access-request\", data={\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1031, in create_pii_access_request\n    |     result = await create_access_request(db, requester, requested_user, message)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py\", line 173, in create_access_request\n    |     existing = await db.access_requests.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestAccessRequests object at 0x10dbd5280>\nclient = <starlette.testclient.TestClient object at 0x10f54edb0>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_create_duplicate_access_request(self, client, sample_user_data):\n        \"\"\"Test creating duplicate access request.\"\"\"\n        # Register two users\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        user_data_2 = sample_user_data.copy()\n        user_data_2[\"username\"] = \"user2\"\n        client.post(\n            \"/api/users/register\",\n            data=user_data_2\n        )\n    \n        # Create first request\n>       client.post(\"/api/users/access-request\", data={\n            \"requester\": \"user2\",\n            \"requested_user\": sample_user_data[\"username\"]\n        })\n\ntests/test_routes_integration.py:374: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\nroutes.py:1031: in create_pii_access_request\n    result = await create_access_request(db, requester, requested_user, message)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\nrequester_id = 'user2', requested_user_id = 'testuser', message = None\n\n    async def create_access_request(db, requester_id, requested_user_id, message=None):\n        \"\"\"\n        Create a new PII access request\n    \n        Args:\n            db: Database connection\n            requester_id: Username of requester\n            requested_user_id: Username of profile owner\n            message: Optional message from requester\n    \n        Returns:\n            Created request document\n        \"\"\"\n        from datetime import datetime\n    \n        # Check if request already exists\n>       existing = await db.access_requests.find_one({\n            'requesterId': requester_id,\n            'requestedUserId': requested_user_id\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\npii_security.py:173: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:58,133 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:58,134 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:58,135 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:58,136 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:58,138 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:58,139 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:58,140 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/access-request\n2025-10-15 09:40:58,141 - routes - INFO - \ud83d\udd10 Access request: user2 \u2192 testuser\n2025-10-15 09:40:58,141 - main - ERROR - \u274c Error processing POST /api/users/access-request - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1031, in create_pii_access_request\n    result = await create_access_request(db, requester, requested_user, message)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py\", line 173, in create_access_request\n    existing = await db.access_requests.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/access-request\nINFO     routes:routes.py:1028 \ud83d\udd10 Access request: user2 \u2192 testuser\nERROR    main:main.py:131 \u274c Error processing POST /api/users/access-request - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1031, in create_pii_access_request\n    result = await create_access_request(db, requester, requested_user, message)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py\", line 173, in create_access_request\n    existing = await db.access_requests.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_________________ TestAccessRequests.test_get_access_requests __________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 403, in test_get_access_requests\n    |     client.post(\"/api/users/access-request\", data={\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1031, in create_pii_access_request\n    |     result = await create_access_request(db, requester, requested_user, message)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py\", line 173, in create_access_request\n    |     existing = await db.access_requests.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestAccessRequests object at 0x10dbd6720>\nclient = <starlette.testclient.TestClient object at 0x10efc88f0>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_get_access_requests(self, client, sample_user_data):\n        \"\"\"Test getting access requests.\"\"\"\n        # Register two users and create request\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        user_data_2 = sample_user_data.copy()\n        user_data_2[\"username\"] = \"user2\"\n        client.post(\n            \"/api/users/register\",\n            data=user_data_2\n        )\n    \n>       client.post(\"/api/users/access-request\", data={\n            \"requester\": \"user2\",\n            \"requested_user\": sample_user_data[\"username\"]\n        })\n\ntests/test_routes_integration.py:403: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\nroutes.py:1031: in create_pii_access_request\n    result = await create_access_request(db, requester, requested_user, message)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\nrequester_id = 'user2', requested_user_id = 'testuser', message = None\n\n    async def create_access_request(db, requester_id, requested_user_id, message=None):\n        \"\"\"\n        Create a new PII access request\n    \n        Args:\n            db: Database connection\n            requester_id: Username of requester\n            requested_user_id: Username of profile owner\n            message: Optional message from requester\n    \n        Returns:\n            Created request document\n        \"\"\"\n        from datetime import datetime\n    \n        # Check if request already exists\n>       existing = await db.access_requests.find_one({\n            'requesterId': requester_id,\n            'requestedUserId': requested_user_id\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\npii_security.py:173: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:58,483 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:58,484 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:58,485 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:58,486 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:58,487 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:58,489 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:58,490 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/access-request\n2025-10-15 09:40:58,490 - routes - INFO - \ud83d\udd10 Access request: user2 \u2192 testuser\n2025-10-15 09:40:58,491 - main - ERROR - \u274c Error processing POST /api/users/access-request - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1031, in create_pii_access_request\n    result = await create_access_request(db, requester, requested_user, message)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py\", line 173, in create_access_request\n    existing = await db.access_requests.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/access-request\nINFO     routes:routes.py:1028 \ud83d\udd10 Access request: user2 \u2192 testuser\nERROR    main:main.py:131 \u274c Error processing POST /api/users/access-request - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1031, in create_pii_access_request\n    result = await create_access_request(db, requester, requested_user, message)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py\", line 173, in create_access_request\n    existing = await db.access_requests.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_____________________ TestFavorites.test_add_to_favorites ______________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 436, in test_add_to_favorites\n    |     response = client.post(f\"/api/users/favorites/user2\",\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestFavorites object at 0x10dbd6a80>\nclient = <starlette.testclient.TestClient object at 0x10f54e870>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_add_to_favorites(self, client, sample_user_data):\n        \"\"\"Test adding user to favorites.\"\"\"\n        # Register two users\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        user_data_2 = sample_user_data.copy()\n        user_data_2[\"username\"] = \"user2\"\n        client.post(\n            \"/api/users/register\",\n            data=user_data_2\n        )\n    \n        # Add to favorites\n>       response = client.post(f\"/api/users/favorites/user2\",\n                                    params={\"username\": sample_user_data[\"username\"]})\n\ntests/test_routes_integration.py:436: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'testuser', target_username = 'user2'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:58,809 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:58,811 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:58,812 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:58,813 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:58,814 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:58,815 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:58,816 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user2\n2025-10-15 09:40:58,817 - routes - INFO - \u2b50 Adding user2 to testuser's favorites\n2025-10-15 09:40:58,817 - main - ERROR - \u274c Error processing POST /api/users/favorites/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user2\nINFO     routes:routes.py:1479 \u2b50 Adding user2 to testuser's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n________________ TestFavorites.test_add_duplicate_to_favorites _________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 458, in test_add_duplicate_to_favorites\n    |     client.post(f\"/api/users/favorites/user2\",\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestFavorites object at 0x10dbd6bd0>\nclient = <starlette.testclient.TestClient object at 0x10f155b50>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_add_duplicate_to_favorites(self, client, sample_user_data):\n        \"\"\"Test adding same user to favorites twice.\"\"\"\n        # Register two users\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        user_data_2 = sample_user_data.copy()\n        user_data_2[\"username\"] = \"user2\"\n        client.post(\n            \"/api/users/register\",\n            data=user_data_2\n        )\n    \n        # Add to favorites first time\n>       client.post(f\"/api/users/favorites/user2\",\n                         params={\"username\": sample_user_data[\"username\"]})\n\ntests/test_routes_integration.py:458: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'testuser', target_username = 'user2'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:59,138 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:59,140 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:59,141 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:59,142 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:59,143 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:59,144 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:59,145 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user2\n2025-10-15 09:40:59,145 - routes - INFO - \u2b50 Adding user2 to testuser's favorites\n2025-10-15 09:40:59,146 - main - ERROR - \u274c Error processing POST /api/users/favorites/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user2\nINFO     routes:routes.py:1479 \u2b50 Adding user2 to testuser's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______________________ TestFavorites.test_get_favorites _______________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 483, in test_get_favorites\n    |     client.post(f\"/api/users/favorites/user2\",\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestFavorites object at 0x10dbd6d80>\nclient = <starlette.testclient.TestClient object at 0x10efbe6c0>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_get_favorites(self, client, sample_user_data):\n        \"\"\"Test getting user's favorites.\"\"\"\n        # Register two users and add to favorites\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        user_data_2 = sample_user_data.copy()\n        user_data_2[\"username\"] = \"user2\"\n        client.post(\n            \"/api/users/register\",\n            data=user_data_2\n        )\n    \n>       client.post(f\"/api/users/favorites/user2\",\n                         params={\"username\": sample_user_data[\"username\"]})\n\ntests/test_routes_integration.py:483: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'testuser', target_username = 'user2'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:59,480 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:59,482 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:59,483 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:59,484 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:59,485 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:59,486 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:59,487 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user2\n2025-10-15 09:40:59,488 - routes - INFO - \u2b50 Adding user2 to testuser's favorites\n2025-10-15 09:40:59,488 - main - ERROR - \u274c Error processing POST /api/users/favorites/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user2\nINFO     routes:routes.py:1479 \u2b50 Adding user2 to testuser's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user2 - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______________________ TestMessaging.test_send_message ________________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 514, in test_send_message\n    |     response = client.post(\"/api/users/messages\", data={\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2024, in send_message\n    |     recipient = await db.users.find_one({\"username\": to_username})\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestMessaging object at 0x10dbd70e0>\nclient = <starlette.testclient.TestClient object at 0x10efbed80>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_send_message(self, client, sample_user_data):\n        \"\"\"Test sending a message.\"\"\"\n        # Register two users\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        user_data_2 = sample_user_data.copy()\n        user_data_2[\"username\"] = \"user2\"\n        client.post(\n            \"/api/users/register\",\n            data=user_data_2\n        )\n    \n        # Send message\n>       response = client.post(\"/api/users/messages\", data={\n            \"from_username\": sample_user_data[\"username\"],\n            \"to_username\": \"user2\",\n            \"content\": \"Hello, this is a test message!\"\n        })\n\ntests/test_routes_integration.py:514: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nfrom_username = 'testuser', to_username = 'user2'\ncontent = 'Hello, this is a test message!'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/messages\")\n    async def send_message(\n        from_username: str = Form(...),\n        to_username: str = Form(...),\n        content: str = Form(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Send a message to another user\"\"\"\n        logger.info(f\"\ud83d\udcac Message from {from_username} to {to_username}\")\n    \n        if len(content.strip()) == 0:\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=\"Message content cannot be empty\"\n            )\n    \n        if len(content) > 1000:\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=\"Message too long (max 1000 characters)\"\n            )\n    \n        # Check if recipient exists\n>       recipient = await db.users.find_one({\"username\": to_username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2024: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:40:59,907 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:59,909 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\n2025-10-15 09:40:59,910 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:59,911 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:40:59,912 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:40:59,913 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:40:59,914 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/messages\n2025-10-15 09:40:59,915 - routes - INFO - \ud83d\udcac Message from testuser to user2\n2025-10-15 09:40:59,916 - main - ERROR - \u274c Error processing POST /api/users/messages - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2024, in send_message\n    recipient = await db.users.find_one({\"username\": to_username})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/messages\nINFO     routes:routes.py:2009 \ud83d\udcac Message from testuser to user2\nERROR    main:main.py:131 \u274c Error processing POST /api/users/messages - Duration: 0.002s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2024, in send_message\n    recipient = await db.users.find_one({\"username\": to_username})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______________________ TestMessaging.test_get_messages ________________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_routes_integration.py\", line 563, in test_get_messages\n    |     client.post(\"/api/users/messages\", data={\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2024, in send_message\n    |     recipient = await db.users.find_one({\"username\": to_username})\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_routes_integration.TestMessaging object at 0x10dbd73e0>\nclient = <starlette.testclient.TestClient object at 0x10f228560>\nsample_user_data = {'citizenshipStatus': 'Citizen', 'contactEmail': 'test@example.com', 'contactNumber': '1234567890', 'dob': '1990-01-01', ...}\n\n    def test_get_messages(self, client, sample_user_data):\n        \"\"\"Test getting messages for user.\"\"\"\n        # Register two users and send message\n        client.post(\n            \"/api/users/register\",\n            data=sample_user_data\n        )\n    \n        user_data_2 = sample_user_data.copy()\n        user_data_2[\"username\"] = \"user2\"\n        client.post(\n            \"/api/users/register\",\n            data=user_data_2\n        )\n    \n>       client.post(\"/api/users/messages\", data={\n            \"from_username\": sample_user_data[\"username\"],\n            \"to_username\": \"user2\",\n            \"content\": \"Test message\"\n        })\n\ntests/test_routes_integration.py:563: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nfrom_username = 'testuser', to_username = 'user2', content = 'Test message'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/messages\")\n    async def send_message(\n        from_username: str = Form(...),\n        to_username: str = Form(...),\n        content: str = Form(...),\n        db = Depends(get_database)\n    ):\n        \"\"\"Send a message to another user\"\"\"\n        logger.info(f\"\ud83d\udcac Message from {from_username} to {to_username}\")\n    \n        if len(content.strip()) == 0:\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=\"Message content cannot be empty\"\n            )\n    \n        if len(content) > 1000:\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=\"Message too long (max 1000 characters)\"\n            )\n    \n        # Check if recipient exists\n>       recipient = await db.users.find_one({\"username\": to_username})\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:2024: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:00,279 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:41:00,281 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\n2025-10-15 09:41:00,282 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:41:00,283 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/register\n2025-10-15 09:41:00,284 - main - INFO - \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\n2025-10-15 09:41:00,285 - httpx - INFO - HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\n2025-10-15 09:41:00,286 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/messages\n2025-10-15 09:41:00,287 - routes - INFO - \ud83d\udcac Message from testuser to user2\n2025-10-15 09:41:00,287 - main - ERROR - \u274c Error processing POST /api/users/messages - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2024, in send_message\n    recipient = await db.users.find_one({\"username\": to_username})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/register\nINFO     main:main.py:122 \u274c POST /api/users/register - Status: 422 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/register \"HTTP/1.1 422 Unprocessable Entity\"\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/messages\nINFO     routes:routes.py:2009 \ud83d\udcac Message from testuser to user2\nERROR    main:main.py:131 \u274c Error processing POST /api/users/messages - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2024, in send_message\n    recipient = await db.users.find_one({\"username\": to_username})\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_________________ TestKeywordSearch.test_search_by_first_name __________________\n\nself = <test_search.TestKeywordSearch object at 0x10dc051f0>\nsearch_test_users = [{'_id': ObjectId('68efce9c9ecea2e269cb5473'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9c9ecea2e269cb5477'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_first_name(self, search_test_users):\n        \"\"\"Test searching by first name\"\"\"\n>       response = client.get(\"/api/users/search?keyword=John\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:111: NameError\n__________________ TestKeywordSearch.test_search_by_last_name __________________\n\nself = <test_search.TestKeywordSearch object at 0x10dc05310>\nsearch_test_users = [{'_id': ObjectId('68efce9c9ecea2e269cb5479'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9c9ecea2e269cb547d'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_last_name(self, search_test_users):\n        \"\"\"Test searching by last name\"\"\"\n>       response = client.get(\"/api/users/search?keyword=Smith\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:123: NameError\n__________________ TestKeywordSearch.test_search_by_location ___________________\n\nself = <test_search.TestKeywordSearch object at 0x10dc05610>\nsearch_test_users = [{'_id': ObjectId('68efce9c9ecea2e269cb547f'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9c9ecea2e269cb5483'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_location(self, search_test_users):\n        \"\"\"Test searching by location\"\"\"\n>       response = client.get(\"/api/users/search?keyword=New York\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:133: NameError\n________________ TestKeywordSearch.test_search_case_insensitive ________________\n\nself = <test_search.TestKeywordSearch object at 0x10dc057c0>\nsearch_test_users = [{'_id': ObjectId('68efce9c9ecea2e269cb5485'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9c9ecea2e269cb5489'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_case_insensitive(self, search_test_users):\n        \"\"\"Test that search is case-insensitive\"\"\"\n>       response1 = client.get(\"/api/users/search?keyword=john\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:141: NameError\n_________________ TestKeywordSearch.test_search_partial_match __________________\n\nself = <test_search.TestKeywordSearch object at 0x10dc05970>\nsearch_test_users = [{'_id': ObjectId('68efce9d9ecea2e269cb548b'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9d9ecea2e269cb548f'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_partial_match(self, search_test_users):\n        \"\"\"Test partial keyword matching\"\"\"\n>       response = client.get(\"/api/users/search?keyword=Jo\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:155: NameError\n_________________ TestAgeRangeSearch.test_search_by_age_range __________________\n\nself = <test_search.TestAgeRangeSearch object at 0x10dc05be0>\nsearch_test_users = [{'_id': ObjectId('68efce9d9ecea2e269cb5491'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9d9ecea2e269cb5495'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_age_range(self, search_test_users):\n        \"\"\"Test searching within age range\"\"\"\n        # Search for users aged 30-35\n>       response = client.get(\"/api/users/search?ageMin=30&ageMax=35\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:167: NameError\n________________ TestAgeRangeSearch.test_search_by_min_age_only ________________\n\nself = <test_search.TestAgeRangeSearch object at 0x10dc05d00>\nsearch_test_users = [{'_id': ObjectId('68efce9d9ecea2e269cb5497'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9d9ecea2e269cb549b'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_min_age_only(self, search_test_users):\n        \"\"\"Test searching with only minimum age\"\"\"\n>       response = client.get(\"/api/users/search?ageMin=30\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:179: NameError\n________________ TestAgeRangeSearch.test_search_by_max_age_only ________________\n\nself = <test_search.TestAgeRangeSearch object at 0x10dc06000>\nsearch_test_users = [{'_id': ObjectId('68efce9d9ecea2e269cb549d'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9d9ecea2e269cb54a1'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_max_age_only(self, search_test_users):\n        \"\"\"Test searching with only maximum age\"\"\"\n>       response = client.get(\"/api/users/search?ageMax=35\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:190: NameError\n_______________ TestAgeRangeSearch.test_search_invalid_age_range _______________\n\nself = <test_search.TestAgeRangeSearch object at 0x10dc061b0>\nsearch_test_users = [{'_id': ObjectId('68efce9d9ecea2e269cb54a3'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9d9ecea2e269cb54a7'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_invalid_age_range(self, search_test_users):\n        \"\"\"Test searching with invalid age range (min > max)\"\"\"\n>       response = client.get(\"/api/users/search?ageMin=40&ageMax=30\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:201: NameError\n______________ TestHeightRangeSearch.test_search_by_height_range _______________\n\nself = <test_search.TestHeightRangeSearch object at 0x10dc05730>\nsearch_test_users = [{'_id': ObjectId('68efce9d9ecea2e269cb54a9'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9d9ecea2e269cb54ad'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_height_range(self, search_test_users):\n        \"\"\"Test searching within height range\"\"\"\n>       response = client.get(\"/api/users/search?heightMin=66&heightMax=72\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:211: NameError\n_____________ TestHeightRangeSearch.test_search_by_min_height_only _____________\n\nself = <test_search.TestHeightRangeSearch object at 0x10dc05280>\nsearch_test_users = [{'_id': ObjectId('68efce9d9ecea2e269cb54af'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9d9ecea2e269cb54b3'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_min_height_only(self, search_test_users):\n        \"\"\"Test searching with only minimum height\"\"\"\n>       response = client.get(\"/api/users/search?heightMin=70\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:218: NameError\n_____________ TestHeightRangeSearch.test_search_by_max_height_only _____________\n\nself = <test_search.TestHeightRangeSearch object at 0x10dc06510>\nsearch_test_users = [{'_id': ObjectId('68efce9d9ecea2e269cb54b5'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9d9ecea2e269cb54b9'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_max_height_only(self, search_test_users):\n        \"\"\"Test searching with only maximum height\"\"\"\n>       response = client.get(\"/api/users/search?heightMax=68\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:225: NameError\n_________________ TestGenderSearch.test_search_by_gender_male __________________\n\nself = <test_search.TestGenderSearch object at 0x10dc06780>\nsearch_test_users = [{'_id': ObjectId('68efce9d9ecea2e269cb54bb'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9d9ecea2e269cb54bf'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_gender_male(self, search_test_users):\n        \"\"\"Test searching for male users\"\"\"\n>       response = client.get(\"/api/users/search?gender=Male\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:235: NameError\n________________ TestGenderSearch.test_search_by_gender_female _________________\n\nself = <test_search.TestGenderSearch object at 0x10dc068a0>\nsearch_test_users = [{'_id': ObjectId('68efce9e9ecea2e269cb54c1'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9e9ecea2e269cb54c5'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_gender_female(self, search_test_users):\n        \"\"\"Test searching for female users\"\"\"\n>       response = client.get(\"/api/users/search?gender=Female\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:246: NameError\n_______________ TestLocationSearch.test_search_by_exact_location _______________\n\nself = <test_search.TestLocationSearch object at 0x10dc06c60>\nsearch_test_users = [{'_id': ObjectId('68efce9e9ecea2e269cb54c7'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9e9ecea2e269cb54cb'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_exact_location(self, search_test_users):\n        \"\"\"Test searching by exact location\"\"\"\n>       response = client.get(\"/api/users/search?location=New York, USA\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:260: NameError\n_________________ TestLocationSearch.test_search_by_city_only __________________\n\nself = <test_search.TestLocationSearch object at 0x10dc06d80>\nsearch_test_users = [{'_id': ObjectId('68efce9e9ecea2e269cb54cd'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9e9ecea2e269cb54d1'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_city_only(self, search_test_users):\n        \"\"\"Test searching by city name only\"\"\"\n>       response = client.get(\"/api/users/search?location=Chicago\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:268: NameError\n____________ TestEducationOccupationSearch.test_search_by_education ____________\n\nself = <test_search.TestEducationOccupationSearch object at 0x10dc07110>\nsearch_test_users = [{'_id': ObjectId('68efce9e9ecea2e269cb54d3'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9e9ecea2e269cb54d7'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_education(self, search_test_users):\n        \"\"\"Test searching by education level\"\"\"\n>       response = client.get(\"/api/users/search?education=Master's\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:279: NameError\n___________ TestEducationOccupationSearch.test_search_by_occupation ____________\n\nself = <test_search.TestEducationOccupationSearch object at 0x10dc07230>\nsearch_test_users = [{'_id': ObjectId('68efce9e9ecea2e269cb54d9'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9e9ecea2e269cb54dd'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_occupation(self, search_test_users):\n        \"\"\"Test searching by occupation\"\"\"\n>       response = client.get(\"/api/users/search?occupation=Engineer\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:290: NameError\n_____________ TestReligionEatingPreference.test_search_by_religion _____________\n\nself = <test_search.TestReligionEatingPreference object at 0x10dc075c0>\nsearch_test_users = [{'_id': ObjectId('68efce9e9ecea2e269cb54df'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9e9ecea2e269cb54e3'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_religion(self, search_test_users):\n        \"\"\"Test searching by religion\"\"\"\n>       response = client.get(\"/api/users/search?religion=Hindu\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:303: NameError\n________ TestReligionEatingPreference.test_search_by_eating_preference _________\n\nself = <test_search.TestReligionEatingPreference object at 0x10dc076e0>\nsearch_test_users = [{'_id': ObjectId('68efce9e9ecea2e269cb54e5'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9e9ecea2e269cb54e9'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_by_eating_preference(self, search_test_users):\n        \"\"\"Test searching by eating preference\"\"\"\n>       response = client.get(\"/api/users/search?eatingPreference=Vegetarian\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:311: NameError\n____________ TestMultipleFilters.test_search_with_multiple_filters _____________\n\nself = <test_search.TestMultipleFilters object at 0x10dc07740>\nsearch_test_users = [{'_id': ObjectId('68efce9e9ecea2e269cb54eb'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9e9ecea2e269cb54ef'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_with_multiple_filters(self, search_test_users):\n        \"\"\"Test searching with multiple filters combined\"\"\"\n>       response = client.get(\n            \"/api/users/search?gender=Male&location=New York&ageMin=30&ageMax=40\"\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:322: NameError\n_____________ TestMultipleFilters.test_search_keyword_with_filters _____________\n\nself = <test_search.TestMultipleFilters object at 0x10dc07860>\nsearch_test_users = [{'_id': ObjectId('68efce9e9ecea2e269cb54f1'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9e9ecea2e269cb54f5'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_keyword_with_filters(self, search_test_users):\n        \"\"\"Test combining keyword search with filters\"\"\"\n>       response = client.get(\"/api/users/search?keyword=John&gender=Male\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:338: NameError\n_____________ TestMultipleFilters.test_search_all_filters_combined _____________\n\nself = <test_search.TestMultipleFilters object at 0x10dc07b60>\nsearch_test_users = [{'_id': ObjectId('68efce9f9ecea2e269cb54f7'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9f9ecea2e269cb54fb'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_all_filters_combined(self, search_test_users):\n        \"\"\"Test using all available filters together\"\"\"\n>       response = client.get(\n            \"/api/users/search?\"\n            \"keyword=Engineer&\"\n            \"gender=Male&\"\n            \"ageMin=25&ageMax=40&\"\n            \"heightMin=66&heightMax=72&\"\n            \"location=New York&\"\n            \"education=Bachelor's&\"\n            \"religion=Christian\"\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:348: NameError\n__________________ TestPagination.test_search_with_pagination __________________\n\nself = <test_search.TestPagination object at 0x10dc07dd0>\nsearch_test_users = [{'_id': ObjectId('68efce9f9ecea2e269cb54fd'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9f9ecea2e269cb5501'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_with_pagination(self, search_test_users):\n        \"\"\"Test paginated search results\"\"\"\n>       response = client.get(\"/api/users/search?page=1&limit=2\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:367: NameError\n______________________ TestPagination.test_search_page_2 _______________________\n\nself = <test_search.TestPagination object at 0x10dc3c0b0>\nsearch_test_users = [{'_id': ObjectId('68efce9f9ecea2e269cb5503'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9f9ecea2e269cb5507'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_page_2(self, search_test_users):\n        \"\"\"Test retrieving second page of results\"\"\"\n>       response = client.get(\"/api/users/search?page=2&limit=2\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:376: NameError\n_______________ TestPagination.test_search_different_page_sizes ________________\n\nself = <test_search.TestPagination object at 0x10dc3c230>\nsearch_test_users = [{'_id': ObjectId('68efce9f9ecea2e269cb5509'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9f9ecea2e269cb550d'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_different_page_sizes(self, search_test_users):\n        \"\"\"Test different page sizes\"\"\"\n>       response1 = client.get(\"/api/users/search?limit=1\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:384: NameError\n________________ TestPagination.test_search_invalid_page_number ________________\n\nself = <test_search.TestPagination object at 0x10dc3c3e0>\nsearch_test_users = [{'_id': ObjectId('68efce9f9ecea2e269cb550f'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9f9ecea2e269cb5513'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_invalid_page_number(self, search_test_users):\n        \"\"\"Test invalid page number\"\"\"\n>       response = client.get(\"/api/users/search?page=0\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:395: NameError\n___________________ TestEmptyResults.test_search_no_matches ____________________\n\nself = <test_search.TestEmptyResults object at 0x10dc3c650>\nsearch_test_users = [{'_id': ObjectId('68efce9f9ecea2e269cb5515'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9f9ecea2e269cb5519'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_no_matches(self, search_test_users):\n        \"\"\"Test search that returns no results\"\"\"\n>       response = client.get(\"/api/users/search?keyword=NonexistentName\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:405: NameError\n_______________ TestEmptyResults.test_search_impossible_filters ________________\n\nself = <test_search.TestEmptyResults object at 0x10dc3c770>\nsearch_test_users = [{'_id': ObjectId('68efce9f9ecea2e269cb551b'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9f9ecea2e269cb551f'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_impossible_filters(self, search_test_users):\n        \"\"\"Test search with impossible filter combination\"\"\"\n>       response = client.get(\n            \"/api/users/search?gender=Male&occupation=NonexistentJob\"\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:414: NameError\n_____________ TestSearchPerformance.test_search_with_many_results ______________\n\nself = <test_search.TestSearchPerformance object at 0x10dc3cb30>\nsearch_test_users = [{'_id': ObjectId('68efce9f9ecea2e269cb5521'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9f9ecea2e269cb5525'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    @pytest.mark.slow\n    def test_search_with_many_results(self, search_test_users):\n        \"\"\"Test search performance with many results\"\"\"\n>       response = client.get(\"/api/users/search?limit=200\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:428: NameError\n____________ TestSearchPerformance.test_complex_search_performance _____________\n\nself = <test_search.TestSearchPerformance object at 0x10dc3cc50>\nsearch_test_users = [{'_id': ObjectId('68efce9f9ecea2e269cb5527'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efce9f9ecea2e269cb552b'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    @pytest.mark.slow\n    def test_complex_search_performance(self, search_test_users):\n        \"\"\"Test performance of complex multi-filter search\"\"\"\n>       response = client.get(\n            \"/api/users/search?\"\n            \"keyword=test&\"\n            \"gender=Male&\"\n            \"ageMin=25&ageMax=45&\"\n            \"location=USA\"\n        )\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:436: NameError\n___________ TestSearchEdgeCases.test_search_with_special_characters ____________\n\nself = <test_search.TestSearchEdgeCases object at 0x10dc3caa0>\nsearch_test_users = [{'_id': ObjectId('68efcea09ecea2e269cb552d'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efcea09ecea2e269cb5531'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_with_special_characters(self, search_test_users):\n        \"\"\"Test search with special characters in keyword\"\"\"\n>       response = client.get(\"/api/users/search?keyword=<script>alert('xss')</script>\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:452: NameError\n____________ TestSearchEdgeCases.test_search_with_very_long_keyword ____________\n\nself = <test_search.TestSearchEdgeCases object at 0x10dc3cb60>\nsearch_test_users = [{'_id': ObjectId('68efcea09ecea2e269cb5533'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efcea09ecea2e269cb5537'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_with_very_long_keyword(self, search_test_users):\n        \"\"\"Test search with extremely long keyword\"\"\"\n        long_keyword = \"a\" * 1000\n>       response = client.get(f\"/api/users/search?keyword={long_keyword}\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:460: NameError\n__________ TestSearchEdgeCases.test_search_with_sql_injection_attempt __________\n\nself = <test_search.TestSearchEdgeCases object at 0x10dc3cfe0>\nsearch_test_users = [{'_id': ObjectId('68efcea09ecea2e269cb5539'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efcea09ecea2e269cb553d'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_with_sql_injection_attempt(self, search_test_users):\n        \"\"\"Test search with SQL injection attempt\"\"\"\n>       response = client.get(\"/api/users/search?keyword=' OR '1'='1\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:467: NameError\n____________ TestSearchEdgeCases.test_search_with_empty_parameters _____________\n\nself = <test_search.TestSearchEdgeCases object at 0x10dc3d190>\nsearch_test_users = [{'_id': ObjectId('68efcea09ecea2e269cb553f'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efcea09ecea2e269cb5543'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_with_empty_parameters(self, search_test_users):\n        \"\"\"Test search with empty parameter values\"\"\"\n>       response = client.get(\"/api/users/search?keyword=&gender=\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:474: NameError\n__________ TestSearchIntegration.test_search_to_profile_view_workflow __________\n\nself = <test_search.TestSearchIntegration object at 0x10dc3d400>\nsearch_test_users = [{'_id': ObjectId('68efcea09ecea2e269cb5545'), 'dob': '1990-01-15', 'eatingPreference': 'Non-Veg', 'education': \"Bache...ctId('68efcea09ecea2e269cb5549'), 'dob': '1985-12-05', 'eatingPreference': 'Eggetarian', 'education': \"Master's\", ...}]\n\n    def test_search_to_profile_view_workflow(self, search_test_users):\n        \"\"\"Test complete workflow from search to profile view\"\"\"\n        # Search for user\n>       search_response = client.get(\"/api/users/search?keyword=John\")\nE       NameError: name 'client' is not defined\n\ntests/test_search.py:485: NameError\n_________________ TestFavorites.test_add_to_favorites_success __________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 66, in test_add_to_favorites_success\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestFavorites object at 0x10dc3ec00>\nclient = <starlette.testclient.TestClient object at 0x10e299f10>\ninteraction_users = [{'_id': ObjectId('68efcea09ecea2e269cb5551'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea09ecea2e269cb5553'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_add_to_favorites_success(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test successfully adding user to favorites\"\"\"\n>       response = client.post(\n            \"/api/users/favorites/user_b?username=user_a\"\n        )\n\ntests/test_user_interactions.py:66: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:04,930 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\n2025-10-15 09:41:04,931 - routes - INFO - \u2b50 Adding user_b to user_a's favorites\n2025-10-15 09:41:04,931 - main - ERROR - \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\nINFO     routes:routes.py:1479 \u2b50 Adding user_b to user_a's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_____________ TestFavorites.test_add_to_favorites_nonexistent_user _____________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 76, in test_add_to_favorites_nonexistent_user\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestFavorites object at 0x10dc3ed80>\nclient = <starlette.testclient.TestClient object at 0x10f221130>\ninteraction_users = [{'_id': ObjectId('68efcea19ecea2e269cb5555'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea19ecea2e269cb5557'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_add_to_favorites_nonexistent_user(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test adding non-existent user to favorites\"\"\"\n>       response = client.post(\n            \"/api/users/favorites/nonexistent?username=user_a\"\n        )\n\ntests/test_user_interactions.py:76: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'nonexistent'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:05,378 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/nonexistent\n2025-10-15 09:41:05,379 - routes - INFO - \u2b50 Adding nonexistent to user_a's favorites\n2025-10-15 09:41:05,379 - main - ERROR - \u274c Error processing POST /api/users/favorites/nonexistent - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/nonexistent\nINFO     routes:routes.py:1479 \u2b50 Adding nonexistent to user_a's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/nonexistent - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n___________________ TestFavorites.test_add_self_to_favorites ___________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 84, in test_add_self_to_favorites\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestFavorites object at 0x10dc3c350>\nclient = <starlette.testclient.TestClient object at 0x10f03b800>\ninteraction_users = [{'_id': ObjectId('68efcea19ecea2e269cb5559'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea19ecea2e269cb555b'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_add_self_to_favorites(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test that user cannot favorite themselves\"\"\"\n>       response = client.post(\n            \"/api/users/favorites/user_a?username=user_a\"\n        )\n\ntests/test_user_interactions.py:84: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_a'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:05,829 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user_a\n2025-10-15 09:41:05,829 - routes - INFO - \u2b50 Adding user_a to user_a's favorites\n2025-10-15 09:41:05,829 - main - ERROR - \u274c Error processing POST /api/users/favorites/user_a - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user_a\nINFO     routes:routes.py:1479 \u2b50 Adding user_a to user_a's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user_a - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n____________________ TestFavorites.test_duplicate_favorite _____________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 94, in test_duplicate_favorite\n    |     response1 = client.post(\n    |                 ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestFavorites object at 0x10dc3ef00>\nclient = <starlette.testclient.TestClient object at 0x10f1a1f10>\ninteraction_users = [{'_id': ObjectId('68efcea29ecea2e269cb555d'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea29ecea2e269cb555f'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_duplicate_favorite(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test adding same user to favorites twice\"\"\"\n        # First add\n>       response1 = client.post(\n            \"/api/users/favorites/user_b?username=user_a\"\n        )\n\ntests/test_user_interactions.py:94: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:06,379 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\n2025-10-15 09:41:06,379 - routes - INFO - \u2b50 Adding user_b to user_a's favorites\n2025-10-15 09:41:06,380 - main - ERROR - \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\nINFO     routes:routes.py:1479 \u2b50 Adding user_b to user_a's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______________ TestFavorites.test_remove_from_favorites_success _______________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 110, in test_remove_from_favorites_success\n    |     client.post(\"/api/users/favorites/user_b?username=user_a\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestFavorites object at 0x10dc3f0e0>\nclient = <starlette.testclient.TestClient object at 0x10f220080>\ninteraction_users = [{'_id': ObjectId('68efcea29ecea2e269cb5561'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea29ecea2e269cb5563'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_remove_from_favorites_success(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test successfully removing user from favorites\"\"\"\n        # First add\n>       client.post(\"/api/users/favorites/user_b?username=user_a\")\n\ntests/test_user_interactions.py:110: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:06,799 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\n2025-10-15 09:41:06,799 - routes - INFO - \u2b50 Adding user_b to user_a's favorites\n2025-10-15 09:41:06,800 - main - ERROR - \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\nINFO     routes:routes.py:1479 \u2b50 Adding user_b to user_a's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n________________ TestFavorites.test_remove_nonexistent_favorite ________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 120, in test_remove_nonexistent_favorite\n    |     response = client.delete(\"/api/users/favorites/user_b?username=user_a\")\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 700, in delete\n    |     return super().delete(\n    |            ^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1253, in delete\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1519, in remove_from_favorites\n    |     result = await db.favorites.delete_one({\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestFavorites object at 0x10dc3f2c0>\nclient = <starlette.testclient.TestClient object at 0x10e33a4b0>\ninteraction_users = [{'_id': ObjectId('68efcea39ecea2e269cb5565'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea39ecea2e269cb5567'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_remove_nonexistent_favorite(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test removing user that's not in favorites\"\"\"\n>       response = client.delete(\"/api/users/favorites/user_b?username=user_a\")\n\ntests/test_user_interactions.py:120: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:700: in delete\n    return super().delete(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1253: in delete\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\ntarget_username = 'user_b', username = 'user_a'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.delete(\"/favorites/{target_username}\")\n    async def remove_from_favorites(target_username: str, username: str = Query(...), db = Depends(get_database)):\n        \"\"\"Remove user from favorites\"\"\"\n        logger.info(f\"\u2b50 Removing {target_username} from {username}'s favorites\")\n    \n>       result = await db.favorites.delete_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1519: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:07,228 - main - INFO - \ud83d\udce8 Incoming DELETE request to /api/users/favorites/user_b\n2025-10-15 09:41:07,229 - routes - INFO - \u2b50 Removing user_b from user_a's favorites\n2025-10-15 09:41:07,229 - main - ERROR - \u274c Error processing DELETE /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1519, in remove_from_favorites\n    result = await db.favorites.delete_one({\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming DELETE request to /api/users/favorites/user_b\nINFO     routes:routes.py:1517 \u2b50 Removing user_b from user_a's favorites\nERROR    main:main.py:131 \u274c Error processing DELETE /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1519, in remove_from_favorites\n    result = await db.favorites.delete_one({\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n____________________ TestFavorites.test_get_favorites_list _____________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 128, in test_get_favorites_list\n    |     client.post(\"/api/users/favorites/user_b?username=user_a\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestFavorites object at 0x10dc3f4a0>\nclient = <starlette.testclient.TestClient object at 0x10f1565a0>\ninteraction_users = [{'_id': ObjectId('68efcea39ecea2e269cb5569'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea39ecea2e269cb556b'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_get_favorites_list(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test retrieving list of favorites\"\"\"\n        # Add multiple favorites\n>       client.post(\"/api/users/favorites/user_b?username=user_a\")\n\ntests/test_user_interactions.py:128: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:07,647 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\n2025-10-15 09:41:07,648 - routes - INFO - \u2b50 Adding user_b to user_a's favorites\n2025-10-15 09:41:07,648 - main - ERROR - \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\nINFO     routes:routes.py:1479 \u2b50 Adding user_b to user_a's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_________________ TestShortlist.test_add_to_shortlist_success __________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 144, in test_add_to_shortlist_success\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    |     existing = await db.shortlists.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestShortlist object at 0x10dc3f860>\nclient = <starlette.testclient.TestClient object at 0x10efbe6f0>\ninteraction_users = [{'_id': ObjectId('68efcea39ecea2e269cb556d'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea39ecea2e269cb556f'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_add_to_shortlist_success(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test successfully adding user to shortlist\"\"\"\n>       response = client.post(\n            \"/api/users/shortlist/user_b?username=user_a\"\n        )\n\ntests/test_user_interactions.py:144: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b', notes = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/shortlist/{target_username}\")\n    async def add_to_shortlist(\n        username: str,\n        target_username: str,\n        notes: Optional[str] = Form(None),\n        db = Depends(get_database)\n    ):\n        \"\"\"Add user to shortlist\"\"\"\n        logger.info(f\"\ud83d\udcdd Adding {target_username} to {username}'s shortlist\")\n    \n        # Check if already in shortlist\n>       existing = await db.shortlists.find_one({\n            \"userUsername\": username,\n            \"shortlistedUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1592: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:08,079 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/shortlist/user_b\n2025-10-15 09:41:08,079 - routes - INFO - \ud83d\udcdd Adding user_b to user_a's shortlist\n2025-10-15 09:41:08,080 - main - ERROR - \u274c Error processing POST /api/users/shortlist/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    existing = await db.shortlists.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/shortlist/user_b\nINFO     routes:routes.py:1589 \ud83d\udcdd Adding user_b to user_a's shortlist\nERROR    main:main.py:131 \u274c Error processing POST /api/users/shortlist/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    existing = await db.shortlists.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______________ TestShortlist.test_remove_from_shortlist_success _______________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 159, in test_remove_from_shortlist_success\n    |     client.post(\"/api/users/shortlist/user_b?username=user_a\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    |     existing = await db.shortlists.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestShortlist object at 0x10dc3fbc0>\nclient = <starlette.testclient.TestClient object at 0x10f54e7b0>\ninteraction_users = [{'_id': ObjectId('68efcea49ecea2e269cb5575'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea49ecea2e269cb5577'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_remove_from_shortlist_success(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test successfully removing user from shortlist\"\"\"\n        # First add\n>       client.post(\"/api/users/shortlist/user_b?username=user_a\")\n\ntests/test_user_interactions.py:159: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b', notes = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/shortlist/{target_username}\")\n    async def add_to_shortlist(\n        username: str,\n        target_username: str,\n        notes: Optional[str] = Form(None),\n        db = Depends(get_database)\n    ):\n        \"\"\"Add user to shortlist\"\"\"\n        logger.info(f\"\ud83d\udcdd Adding {target_username} to {username}'s shortlist\")\n    \n        # Check if already in shortlist\n>       existing = await db.shortlists.find_one({\n            \"userUsername\": username,\n            \"shortlistedUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1592: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:08,599 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/shortlist/user_b\n2025-10-15 09:41:08,599 - routes - INFO - \ud83d\udcdd Adding user_b to user_a's shortlist\n2025-10-15 09:41:08,600 - main - ERROR - \u274c Error processing POST /api/users/shortlist/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    existing = await db.shortlists.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/shortlist/user_b\nINFO     routes:routes.py:1589 \ud83d\udcdd Adding user_b to user_a's shortlist\nERROR    main:main.py:131 \u274c Error processing POST /api/users/shortlist/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    existing = await db.shortlists.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_______________________ TestShortlist.test_get_shortlist _______________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 169, in test_get_shortlist\n    |     client.post(\"/api/users/shortlist/user_b?username=user_a\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    |     existing = await db.shortlists.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestShortlist object at 0x10dc3fda0>\nclient = <starlette.testclient.TestClient object at 0x10e268590>\ninteraction_users = [{'_id': ObjectId('68efcea49ecea2e269cb5579'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea49ecea2e269cb557b'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_get_shortlist(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test retrieving shortlist\"\"\"\n        # Add users to shortlist\n>       client.post(\"/api/users/shortlist/user_b?username=user_a\")\n\ntests/test_user_interactions.py:169: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b', notes = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/shortlist/{target_username}\")\n    async def add_to_shortlist(\n        username: str,\n        target_username: str,\n        notes: Optional[str] = Form(None),\n        db = Depends(get_database)\n    ):\n        \"\"\"Add user to shortlist\"\"\"\n        logger.info(f\"\ud83d\udcdd Adding {target_username} to {username}'s shortlist\")\n    \n        # Check if already in shortlist\n>       existing = await db.shortlists.find_one({\n            \"userUsername\": username,\n            \"shortlistedUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1592: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:09,028 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/shortlist/user_b\n2025-10-15 09:41:09,029 - routes - INFO - \ud83d\udcdd Adding user_b to user_a's shortlist\n2025-10-15 09:41:09,029 - main - ERROR - \u274c Error processing POST /api/users/shortlist/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    existing = await db.shortlists.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/shortlist/user_b\nINFO     routes:routes.py:1589 \ud83d\udcdd Adding user_b to user_a's shortlist\nERROR    main:main.py:131 \u274c Error processing POST /api/users/shortlist/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    existing = await db.shortlists.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n____________________ TestShortlist.test_duplicate_shortlist ____________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 182, in test_duplicate_shortlist\n    |     response1 = client.post(\"/api/users/shortlist/user_b?username=user_a\")\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    |     existing = await db.shortlists.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestShortlist object at 0x10dc6c0b0>\nclient = <starlette.testclient.TestClient object at 0x10e2ec980>\ninteraction_users = [{'_id': ObjectId('68efcea59ecea2e269cb557d'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea59ecea2e269cb557f'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_duplicate_shortlist(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test adding same user to shortlist twice\"\"\"\n>       response1 = client.post(\"/api/users/shortlist/user_b?username=user_a\")\n\ntests/test_user_interactions.py:182: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b', notes = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/shortlist/{target_username}\")\n    async def add_to_shortlist(\n        username: str,\n        target_username: str,\n        notes: Optional[str] = Form(None),\n        db = Depends(get_database)\n    ):\n        \"\"\"Add user to shortlist\"\"\"\n        logger.info(f\"\ud83d\udcdd Adding {target_username} to {username}'s shortlist\")\n    \n        # Check if already in shortlist\n>       existing = await db.shortlists.find_one({\n            \"userUsername\": username,\n            \"shortlistedUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1592: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:09,548 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/shortlist/user_b\n2025-10-15 09:41:09,549 - routes - INFO - \ud83d\udcdd Adding user_b to user_a's shortlist\n2025-10-15 09:41:09,549 - main - ERROR - \u274c Error processing POST /api/users/shortlist/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    existing = await db.shortlists.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/shortlist/user_b\nINFO     routes:routes.py:1589 \ud83d\udcdd Adding user_b to user_a's shortlist\nERROR    main:main.py:131 \u274c Error processing POST /api/users/shortlist/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1592, in add_to_shortlist\n    existing = await db.shortlists.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n________________ TestExclusions.test_add_to_exclusions_success _________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 193, in test_add_to_exclusions_success\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    |     existing = await db.exclusions.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestExclusions object at 0x10dc6c320>\nclient = <starlette.testclient.TestClient object at 0x10efbd400>\ninteraction_users = [{'_id': ObjectId('68efcea59ecea2e269cb5581'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea59ecea2e269cb5583'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_add_to_exclusions_success(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test successfully adding user to exclusions\"\"\"\n>       response = client.post(\n            \"/api/users/exclusions/user_b?username=user_a\"\n        )\n\ntests/test_user_interactions.py:193: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b', reason = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/exclusions/{target_username}\")\n    async def add_to_exclusions(\n        username: str,\n        target_username: str,\n        reason: Optional[str] = Form(None),\n        db = Depends(get_database)\n    ):\n        \"\"\"Add user to exclusions\"\"\"\n        logger.info(f\"\u274c Adding {target_username} to {username}'s exclusions\")\n    \n        # Check if already excluded\n>       existing = await db.exclusions.find_one({\n            \"userUsername\": username,\n            \"excludedUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1688: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:09,979 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/exclusions/user_b\n2025-10-15 09:41:09,979 - routes - INFO - \u274c Adding user_b to user_a's exclusions\n2025-10-15 09:41:09,979 - main - ERROR - \u274c Error processing POST /api/users/exclusions/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    existing = await db.exclusions.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/exclusions/user_b\nINFO     routes:routes.py:1685 \u274c Adding user_b to user_a's exclusions\nERROR    main:main.py:131 \u274c Error processing POST /api/users/exclusions/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    existing = await db.exclusions.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n______________ TestExclusions.test_remove_from_exclusions_success ______________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 207, in test_remove_from_exclusions_success\n    |     client.post(\"/api/users/exclusions/user_b?username=user_a\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    |     existing = await db.exclusions.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestExclusions object at 0x10dc6c680>\nclient = <starlette.testclient.TestClient object at 0x10f1775f0>\ninteraction_users = [{'_id': ObjectId('68efcea69ecea2e269cb5589'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea69ecea2e269cb558b'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_remove_from_exclusions_success(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test successfully removing user from exclusions (unblock)\"\"\"\n        # First add\n>       client.post(\"/api/users/exclusions/user_b?username=user_a\")\n\ntests/test_user_interactions.py:207: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b', reason = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/exclusions/{target_username}\")\n    async def add_to_exclusions(\n        username: str,\n        target_username: str,\n        reason: Optional[str] = Form(None),\n        db = Depends(get_database)\n    ):\n        \"\"\"Add user to exclusions\"\"\"\n        logger.info(f\"\u274c Adding {target_username} to {username}'s exclusions\")\n    \n        # Check if already excluded\n>       existing = await db.exclusions.find_one({\n            \"userUsername\": username,\n            \"excludedUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1688: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:10,529 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/exclusions/user_b\n2025-10-15 09:41:10,529 - routes - INFO - \u274c Adding user_b to user_a's exclusions\n2025-10-15 09:41:10,530 - main - ERROR - \u274c Error processing POST /api/users/exclusions/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    existing = await db.exclusions.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/exclusions/user_b\nINFO     routes:routes.py:1685 \u274c Adding user_b to user_a's exclusions\nERROR    main:main.py:131 \u274c Error processing POST /api/users/exclusions/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    existing = await db.exclusions.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n___________________ TestExclusions.test_get_exclusions_list ____________________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 217, in test_get_exclusions_list\n    |     client.post(\"/api/users/exclusions/user_b?username=user_a\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    |     existing = await db.exclusions.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestExclusions object at 0x10dc3f890>\nclient = <starlette.testclient.TestClient object at 0x10f228f50>\ninteraction_users = [{'_id': ObjectId('68efcea69ecea2e269cb558d'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea69ecea2e269cb558f'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_get_exclusions_list(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test retrieving exclusions list\"\"\"\n        # Add exclusions\n>       client.post(\"/api/users/exclusions/user_b?username=user_a\")\n\ntests/test_user_interactions.py:217: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b', reason = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/exclusions/{target_username}\")\n    async def add_to_exclusions(\n        username: str,\n        target_username: str,\n        reason: Optional[str] = Form(None),\n        db = Depends(get_database)\n    ):\n        \"\"\"Add user to exclusions\"\"\"\n        logger.info(f\"\u274c Adding {target_username} to {username}'s exclusions\")\n    \n        # Check if already excluded\n>       existing = await db.exclusions.find_one({\n            \"userUsername\": username,\n            \"excludedUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1688: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:10,997 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/exclusions/user_b\n2025-10-15 09:41:10,998 - routes - INFO - \u274c Adding user_b to user_a's exclusions\n2025-10-15 09:41:10,998 - main - ERROR - \u274c Error processing POST /api/users/exclusions/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    existing = await db.exclusions.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/exclusions/user_b\nINFO     routes:routes.py:1685 \u274c Adding user_b to user_a's exclusions\nERROR    main:main.py:131 \u274c Error processing POST /api/users/exclusions/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    existing = await db.exclusions.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n_____________ TestExclusions.test_exclusion_affects_search_results _____________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 231, in test_exclusion_affects_search_results\n    |     client.post(\"/api/users/exclusions/user_b?username=user_a\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    |     existing = await db.exclusions.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestExclusions object at 0x10dc6c260>\nclient = <starlette.testclient.TestClient object at 0x10e2998b0>\ninteraction_users = [{'_id': ObjectId('68efcea79ecea2e269cb5591'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea79ecea2e269cb5593'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_exclusion_affects_search_results(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test that excluded users don't appear in search results\"\"\"\n        # Add exclusion\n>       client.post(\"/api/users/exclusions/user_b?username=user_a\")\n\ntests/test_user_interactions.py:231: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b', reason = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/exclusions/{target_username}\")\n    async def add_to_exclusions(\n        username: str,\n        target_username: str,\n        reason: Optional[str] = Form(None),\n        db = Depends(get_database)\n    ):\n        \"\"\"Add user to exclusions\"\"\"\n        logger.info(f\"\u274c Adding {target_username} to {username}'s exclusions\")\n    \n        # Check if already excluded\n>       existing = await db.exclusions.find_one({\n            \"userUsername\": username,\n            \"excludedUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1688: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:11,428 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/exclusions/user_b\n2025-10-15 09:41:11,429 - routes - INFO - \u274c Adding user_b to user_a's exclusions\n2025-10-15 09:41:11,429 - main - ERROR - \u274c Error processing POST /api/users/exclusions/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    existing = await db.exclusions.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/exclusions/user_b\nINFO     routes:routes.py:1685 \u274c Adding user_b to user_a's exclusions\nERROR    main:main.py:131 \u274c Error processing POST /api/users/exclusions/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    existing = await db.exclusions.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n________________ TestGetTheirFavorites.test_get_their_favorites ________________\n\nself = <test_user_interactions.TestGetTheirFavorites object at 0x10dc6c980>\nclient = <starlette.testclient.TestClient object at 0x10e262150>\ninteraction_users = [{'_id': ObjectId('68efcea79ecea2e269cb5595'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea79ecea2e269cb5597'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\nsetup_their_favorites = [{'_id': ObjectId('68efcea79ecea2e269cb5598'), 'createdAt': datetime.datetime(2025, 10, 15, 16, 41, 11, 848943), 'favo...eatedAt': datetime.datetime(2025, 10, 15, 16, 41, 11, 848949), 'favoriteUsername': 'user_a', 'userUsername': 'user_c'}]\ncleanup_interactions = None\n\n    def test_get_their_favorites(self, client, interaction_users, setup_their_favorites, cleanup_interactions):\n        \"\"\"Test getting list of users who favorited you\"\"\"\n        response = client.get(\"/api/users/their-favorites/user_a\")\n    \n>       assert response.status_code == 200\nE       assert 500 == 200\nE        +  where 500 = <Response [500 Internal Server Error]>.status_code\n\ntests/test_user_interactions.py:268: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:11,979 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/their-favorites/user_a\n2025-10-15 09:41:11,979 - routes - INFO - \ud83d\udc96 Getting users who favorited user_a\n2025-10-15 09:41:11,980 - routes - ERROR - \u274c Error getting users who favorited: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2636, in get_users_who_favorited_me\n    favorites = await db.favorites.find(\n                ^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\n2025-10-15 09:41:11,980 - main - INFO - \u274c GET /api/users/their-favorites/user_a - Status: 500 - Duration: 0.001s\n2025-10-15 09:41:11,981 - httpx - INFO - HTTP Request: GET http://testserver/api/users/their-favorites/user_a \"HTTP/1.1 500 Internal Server Error\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/their-favorites/user_a\nINFO     routes:routes.py:2632 \ud83d\udc96 Getting users who favorited user_a\nERROR    routes:routes.py:2665 \u274c Error getting users who favorited: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2636, in get_users_who_favorited_me\n    favorites = await db.favorites.find(\n                ^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nINFO     main:main.py:122 \u274c GET /api/users/their-favorites/user_a - Status: 500 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: GET http://testserver/api/users/their-favorites/user_a \"HTTP/1.1 500 Internal Server Error\"\n_______________ TestGetTheirShortlists.test_get_their_shortlists _______________\n\nself = <test_user_interactions.TestGetTheirShortlists object at 0x10dc6cd70>\nclient = <starlette.testclient.TestClient object at 0x10e27b710>\ninteraction_users = [{'_id': ObjectId('68efcea79ecea2e269cb559b'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea79ecea2e269cb559d'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\nsetup_their_shortlists = [{'_id': ObjectId('68efcea89ecea2e269cb559e'), 'createdAt': datetime.datetime(2025, 10, 15, 16, 41, 12, 97720), 'notes': 'Interesting profile', 'shortlistedUsername': 'user_a', ...}]\ncleanup_interactions = None\n\n    def test_get_their_shortlists(self, client, interaction_users, setup_their_shortlists, cleanup_interactions):\n        \"\"\"Test getting list of users who shortlisted you\"\"\"\n        response = client.get(\"/api/users/their-shortlists/user_a\")\n    \n>       assert response.status_code == 200\nE       assert 500 == 200\nE        +  where 500 = <Response [500 Internal Server Error]>.status_code\n\ntests/test_user_interactions.py:299: AssertionError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:12,198 - main - INFO - \ud83d\udce8 Incoming GET request to /api/users/their-shortlists/user_a\n2025-10-15 09:41:12,199 - routes - INFO - \ud83d\udcdd Getting users who shortlisted user_a\n2025-10-15 09:41:12,199 - routes - ERROR - \u274c Error getting users who shortlisted: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2675, in get_users_who_shortlisted_me\n    shortlists = await db.shortlists.find(\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\n2025-10-15 09:41:12,200 - main - INFO - \u274c GET /api/users/their-shortlists/user_a - Status: 500 - Duration: 0.001s\n2025-10-15 09:41:12,201 - httpx - INFO - HTTP Request: GET http://testserver/api/users/their-shortlists/user_a \"HTTP/1.1 500 Internal Server Error\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming GET request to /api/users/their-shortlists/user_a\nINFO     routes:routes.py:2671 \ud83d\udcdd Getting users who shortlisted user_a\nERROR    routes:routes.py:2704 \u274c Error getting users who shortlisted: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 2675, in get_users_who_shortlisted_me\n    shortlists = await db.shortlists.find(\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending> attached to a different loop\nINFO     main:main.py:122 \u274c GET /api/users/their-shortlists/user_a - Status: 500 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: GET http://testserver/api/users/their-shortlists/user_a \"HTTP/1.1 500 Internal Server Error\"\n______ TestCrossFeatureInteractions.test_favorite_and_shortlist_same_user ______\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 310, in test_favorite_and_shortlist_same_user\n    |     fav_response = client.post(\"/api/users/favorites/user_b?username=user_a\")\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestCrossFeatureInteractions object at 0x10dc6d010>\nclient = <starlette.testclient.TestClient object at 0x10ec57800>\ninteraction_users = [{'_id': ObjectId('68efcea89ecea2e269cb55a0'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea89ecea2e269cb55a2'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_favorite_and_shortlist_same_user(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test that user can be both favorited and shortlisted\"\"\"\n        # Add to favorites\n>       fav_response = client.post(\"/api/users/favorites/user_b?username=user_a\")\n\ntests/test_user_interactions.py:310: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:12,328 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\n2025-10-15 09:41:12,329 - routes - INFO - \u2b50 Adding user_b to user_a's favorites\n2025-10-15 09:41:12,330 - main - ERROR - \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\nINFO     routes:routes.py:1479 \u2b50 Adding user_b to user_a's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n___________ TestCrossFeatureInteractions.test_favorite_then_exclude ____________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 322, in test_favorite_then_exclude\n    |     client.post(\"/api/users/favorites/user_b?username=user_a\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestCrossFeatureInteractions object at 0x10dc6d190>\nclient = <starlette.testclient.TestClient object at 0x10ec55bb0>\ninteraction_users = [{'_id': ObjectId('68efcea89ecea2e269cb55a4'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea89ecea2e269cb55a6'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_favorite_then_exclude(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test favoriting then excluding same user\"\"\"\n        # Add to favorites\n>       client.post(\"/api/users/favorites/user_b?username=user_a\")\n\ntests/test_user_interactions.py:322: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:12,779 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\n2025-10-15 09:41:12,779 - routes - INFO - \u2b50 Adding user_b to user_a's favorites\n2025-10-15 09:41:12,779 - main - ERROR - \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\nINFO     routes:routes.py:1479 \u2b50 Adding user_b to user_a's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n________ TestCrossFeatureInteractions.test_exclude_removes_from_search _________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 333, in test_exclude_removes_from_search\n    |     client.post(\"/api/users/exclusions/user_b?username=user_a\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    |     existing = await db.exclusions.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestCrossFeatureInteractions object at 0x10dc6d370>\nclient = <starlette.testclient.TestClient object at 0x10e27a9f0>\ninteraction_users = [{'_id': ObjectId('68efcea99ecea2e269cb55a8'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea99ecea2e269cb55aa'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_exclude_removes_from_search(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test that excluding user removes them from search results\"\"\"\n        # Exclude user_b\n>       client.post(\"/api/users/exclusions/user_b?username=user_a\")\n\ntests/test_user_interactions.py:333: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b', reason = None\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/exclusions/{target_username}\")\n    async def add_to_exclusions(\n        username: str,\n        target_username: str,\n        reason: Optional[str] = Form(None),\n        db = Depends(get_database)\n    ):\n        \"\"\"Add user to exclusions\"\"\"\n        logger.info(f\"\u274c Adding {target_username} to {username}'s exclusions\")\n    \n        # Check if already excluded\n>       existing = await db.exclusions.find_one({\n            \"userUsername\": username,\n            \"excludedUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1688: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:13,298 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/exclusions/user_b\n2025-10-15 09:41:13,299 - routes - INFO - \u274c Adding user_b to user_a's exclusions\n2025-10-15 09:41:13,300 - main - ERROR - \u274c Error processing POST /api/users/exclusions/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    existing = await db.exclusions.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/exclusions/user_b\nINFO     routes:routes.py:1685 \u274c Adding user_b to user_a's exclusions\nERROR    main:main.py:131 \u274c Error processing POST /api/users/exclusions/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1688, in add_to_exclusions\n    existing = await db.exclusions.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n______ TestInteractionEdgeCases.test_multiple_users_favorite_same_profile ______\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 347, in test_multiple_users_favorite_same_profile\n    |     response1 = client.post(\"/api/users/favorites/user_c?username=user_a\")\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestInteractionEdgeCases object at 0x10dc6d730>\nclient = <starlette.testclient.TestClient object at 0x10ef6d850>\ninteraction_users = [{'_id': ObjectId('68efcea99ecea2e269cb55ac'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efcea99ecea2e269cb55ae'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_multiple_users_favorite_same_profile(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test multiple users can favorite the same profile\"\"\"\n>       response1 = client.post(\"/api/users/favorites/user_c?username=user_a\")\n\ntests/test_user_interactions.py:347: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_c'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:13,728 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user_c\n2025-10-15 09:41:13,729 - routes - INFO - \u2b50 Adding user_c to user_a's favorites\n2025-10-15 09:41:13,729 - main - ERROR - \u274c Error processing POST /api/users/favorites/user_c - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user_c\nINFO     routes:routes.py:1479 \u2b50 Adding user_c to user_a's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user_c - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n____________ TestInteractionEdgeCases.test_bidirectional_favorites _____________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 359, in test_bidirectional_favorites\n    |     response1 = client.post(\"/api/users/favorites/user_b?username=user_a\")\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestInteractionEdgeCases object at 0x10dc6d8b0>\nclient = <starlette.testclient.TestClient object at 0x10e263e60>\ninteraction_users = [{'_id': ObjectId('68efceaa9ecea2e269cb55b0'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efceaa9ecea2e269cb55b2'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_bidirectional_favorites(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test that both users can favorite each other\"\"\"\n>       response1 = client.post(\"/api/users/favorites/user_b?username=user_a\")\n\ntests/test_user_interactions.py:359: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:14,149 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\n2025-10-15 09:41:14,150 - routes - INFO - \u2b50 Adding user_b to user_a's favorites\n2025-10-15 09:41:14,150 - main - ERROR - \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\nINFO     routes:routes.py:1479 \u2b50 Adding user_b to user_a's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n____________ TestInteractionEdgeCases.test_remove_all_interactions _____________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py\", line 368, in test_remove_all_interactions\n    |     client.post(\"/api/users/favorites/user_b?username=user_a\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    |     existing = await db.favorites.find_one({\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_interactions.TestInteractionEdgeCases object at 0x10dc6da90>\nclient = <starlette.testclient.TestClient object at 0x10e33b890>\ninteraction_users = [{'_id': ObjectId('68efceaa9ecea2e269cb55b4'), 'contactEmail': 'usera@test.com', 'firstName': 'User', 'lastName': 'A',...d': ObjectId('68efceaa9ecea2e269cb55b6'), 'contactEmail': 'userc@test.com', 'firstName': 'User', 'lastName': 'C', ...}]\ncleanup_interactions = None\n\n    def test_remove_all_interactions(self, client, interaction_users, cleanup_interactions):\n        \"\"\"Test removing all interactions with a user\"\"\"\n        # Add to all lists\n>       client.post(\"/api/users/favorites/user_b?username=user_a\")\n\ntests/test_user_interactions.py:368: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nusername = 'user_a', target_username = 'user_b'\ndb = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.5.1', platform='asyncio')), 'test_profiledata'))\n\n    @router.post(\"/favorites/{target_username}\")\n    async def add_to_favorites(username: str, target_username: str, db = Depends(get_database)):\n        \"\"\"Add user to favorites\"\"\"\n        logger.info(f\"\u2b50 Adding {target_username} to {username}'s favorites\")\n    \n        # Check if already in favorites\n>       existing = await db.favorites.find_one({\n            \"userUsername\": username,\n            \"favoriteUsername\": target_username\n        })\nE       RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n\nroutes.py:1482: RuntimeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:14,579 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\n2025-10-15 09:41:14,579 - routes - INFO - \u2b50 Adding user_b to user_a's favorites\n2025-10-15 09:41:14,579 - main - ERROR - \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/favorites/user_b\nINFO     routes:routes.py:1479 \u2b50 Adding user_b to user_a's favorites\nERROR    main:main.py:131 \u274c Error processing POST /api/users/favorites/user_b - Duration: 0.001s - Error: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 1482, in add_to_favorites\n    existing = await db.favorites.find_one({\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py:151> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:803]> got Future <Future pending cb=[_chain_future.<locals>._call_check_cancel() at /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/futures.py:387]> attached to a different loop\n___________ TestUserActivation.test_admin_can_activate_pending_user ____________\n\nself = <test_user_status.TestUserActivation object at 0x10dc6f980>\nmock_get_db = <MagicMock name='get_database' id='4546446304'>\nclient = <starlette.testclient.TestClient object at 0x10ec5fad0>\nmock_db = <MagicMock name='get_database()' id='4542812272'>\nmock_pending_user = {'_id': 'test_id_1', 'email': 'test@example.com', 'password': '$2b$12$hashedpassword', 'role_name': 'free_user', ...}\nadmin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImV4cCI6MTc2MDU0ODI3NCwiaWF0IjoxNzYwNTQ2NDc0LCJ0eXBlIjoiYWNjZXNzIn0.9lAxHjR-YzPr5mHiv13lwRm_HiOTmKVO_THEh83r5hk'\n\n    @patch('database.get_database')\n    def test_admin_can_activate_pending_user(self, mock_get_db, client, mock_db, mock_pending_user, admin_token):\n        \"\"\"Test admin successfully activates a pending user\"\"\"\n        mock_get_db.return_value = mock_db\n        mock_db.users.find_one = AsyncMock(return_value=mock_pending_user)\n        mock_db.users.update_one = AsyncMock(return_value=MagicMock(modified_count=1))\n    \n        response = client.post(\n            f\"/api/admin/users/{mock_pending_user['username']}/activate\",\n            headers={\"Authorization\": f\"Bearer {admin_token}\"},\n            json={\"reason\": \"Profile complete\"}\n        )\n    \n>       assert response.status_code == 200\nE       assert 404 == 200\nE        +  where 404 = <Response [404 Not Found]>.status_code\n\ntests/test_user_status.py:119: AssertionError\n---------------------------- Captured stderr setup -----------------------------\n2025-10-15 09:41:14,914 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/login\n2025-10-15 09:41:14,916 - routes - INFO - \ud83d\udd11 Login attempt for username: admin\n2025-10-15 09:41:14,916 - routes - INFO - \ud83d\udd10 Admin login attempt detected\n2025-10-15 09:41:14,916 - routes - INFO - \u2705 Admin login successful (hardcoded credentials)\n2025-10-15 09:41:14,916 - main - INFO - \u2705 POST /api/users/login - Status: 200 - Duration: 0.002s\n2025-10-15 09:41:14,917 - httpx - INFO - HTTP Request: POST http://testserver/api/users/login \"HTTP/1.1 200 OK\"\n------------------------------ Captured log setup ------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/login\nINFO     routes:routes.py:392 \ud83d\udd11 Login attempt for username: admin\nINFO     routes:routes.py:396 \ud83d\udd10 Admin login attempt detected\nINFO     routes:routes.py:403 \u2705 Admin login successful (hardcoded credentials)\nINFO     main:main.py:122 \u2705 POST /api/users/login - Status: 200 - Duration: 0.002s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/users/login \"HTTP/1.1 200 OK\"\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:14,919 - main - INFO - \ud83d\udce8 Incoming POST request to /api/admin/users/testuser/activate\n2025-10-15 09:41:14,921 - main - INFO - \u274c POST /api/admin/users/testuser/activate - Status: 404 - Duration: 0.001s\n2025-10-15 09:41:14,922 - httpx - INFO - HTTP Request: POST http://testserver/api/admin/users/testuser/activate \"HTTP/1.1 404 Not Found\"\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/admin/users/testuser/activate\nINFO     main:main.py:122 \u274c POST /api/admin/users/testuser/activate - Status: 404 - Duration: 0.001s\nINFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/api/admin/users/testuser/activate \"HTTP/1.1 404 Not Found\"\n_________ TestMenuAccessControl.test_pending_user_login_returns_status _________\n  + Exception Group Traceback (most recent call last):\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n  |     yield\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 190, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py\", line 781, in __aexit__\n  |     raise BaseExceptionGroup(\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 345, in from_call\n    |     result: Optional[TResult] = func()\n    |                                 ^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 266, in <lambda>\n    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 87, in pytest_runtest_call\n    |     yield from thread_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py\", line 63, in thread_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 90, in pytest_runtest_call\n    |     yield from unraisable_exception_runtest_hook()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/unraisableexception.py\", line 65, in unraisable_exception_runtest_hook\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 839, in pytest_runtest_call\n    |     yield from self._runtest_for(item, \"call\")\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/logging.py\", line 822, in _runtest_for\n    |     yield\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/capture.py\", line 882, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/skipping.py\", line 257, in pytest_runtest_call\n    |     return (yield)\n    |             ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 181, in pytest_runtest_call\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/runner.py\", line 173, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 1836, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |           ^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py\", line 193, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_status.py\", line 183, in test_pending_user_login_returns_status\n    |     response = client.post(\n    |                ^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 593, in post\n    |     return super().post(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1146, in post\n    |     return self.request(\n    |            ^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 468, in request\n    |     return super().request(\n    |            ^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 828, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 915, in send\n    |     response = self._send_handling_auth(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 943, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 980, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_client.py\", line 1016, in _send_single_request\n    |     response = transport.handle_request(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 344, in handle_request\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/testclient.py\", line 341, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 321, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 456, in result\n    |     return self.__get_result()\n    |            ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\n    |     raise self._exception\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/from_thread.py\", line 252, in _call_func\n    |     retval = await retval_or_awaitable\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/applications.py\", line 1054, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/applications.py\", line 123, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 189, in __call__\n    |     with collapse_excgroups():\n    |   File \"/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py\", line 158, in __exit__\n    |     self.gen.throw(value)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_utils.py\", line 91, in collapse_excgroups\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    |     raise app_exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    |     raise exc\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    |     response = await func(request)\n    |                ^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    |     raise e\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 435, in login_user\n    |     user = await db.users.find_one({\"username\": login_data.username})\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    | TypeError: object MagicMock can't be used in 'await' expression\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nself = <test_user_status.TestMenuAccessControl object at 0x10dca88c0>\nclient = <starlette.testclient.TestClient object at 0x10ed2b980>\nmock_db = <MagicMock id='4543652080'>\nmock_pending_user = {'_id': 'test_id_1', 'email': 'test@example.com', 'password': '$2b$12$hashedpassword', 'role_name': 'free_user', ...}\n\n    def test_pending_user_login_returns_status(self, client, mock_db, mock_pending_user):\n        \"\"\"Test login response includes user status\"\"\"\n        with patch('database.get_database', return_value=mock_db):\n            mock_db.users.find_one = AsyncMock(return_value=mock_pending_user)\n    \n>           response = client.post(\n                \"/api/users/login\",\n                json={\"username\": \"testuser\", \"password\": \"password\"}\n            )\n\ntests/test_user_status.py:183: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.12/site-packages/starlette/testclient.py:593: in post\n    return super().post(\nvenv/lib/python3.12/site-packages/httpx/_client.py:1146: in post\n    return self.request(\nvenv/lib/python3.12/site-packages/starlette/testclient.py:468: in request\n    return super().request(\nvenv/lib/python3.12/site-packages/httpx/_client.py:828: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\nvenv/lib/python3.12/site-packages/httpx/_client.py:915: in send\n    response = self._send_handling_auth(\nvenv/lib/python3.12/site-packages/httpx/_client.py:943: in _send_handling_auth\n    response = self._send_handling_redirects(\nvenv/lib/python3.12/site-packages/httpx/_client.py:980: in _send_handling_redirects\n    response = self._send_single_request(request)\nvenv/lib/python3.12/site-packages/httpx/_client.py:1016: in _send_single_request\n    response = transport.handle_request(request)\nvenv/lib/python3.12/site-packages/starlette/testclient.py:344: in handle_request\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/testclient.py:341: in handle_request\n    portal.call(self.app, scope, receive, send)\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:321: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result\n    return self.__get_result()\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result\n    raise self._exception\nvenv/lib/python3.12/site-packages/anyio/from_thread.py:252: in _call_func\n    retval = await retval_or_awaitable\nvenv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__\n    await super().__call__(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:189: in __call__\n    with collapse_excgroups():\n/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__\n    self.gen.throw(value)\nvenv/lib/python3.12/site-packages/starlette/_utils.py:91: in collapse_excgroups\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__\n    response = await self.dispatch_func(request, call_next)\nmain.py:116: in log_requests\n    response = await call_next(request)\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:165: in call_next\n    raise app_exc\nvenv/lib/python3.12/site-packages/starlette/middleware/base.py:151: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\nvenv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:762: in __call__\n    await self.middleware_stack(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:782: in app\n    await route.handle(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:297: in handle\n    await self.app(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/routing.py:77: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app\n    raise exc\nvenv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    await app(scope, receive, sender)\nvenv/lib/python3.12/site-packages/starlette/routing.py:72: in app\n    response = await func(request)\nvenv/lib/python3.12/site-packages/fastapi/routing.py:299: in app\n    raise e\nvenv/lib/python3.12/site-packages/fastapi/routing.py:294: in app\n    raw_response = await run_endpoint_function(\nvenv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function\n    return await dependant.call(**values)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nlogin_data = LoginRequest(username='testuser', password='password')\ndb = <MagicMock name='mock.__getitem__()' id='4531750576'>\n\n    @router.post(\"/login\")\n    async def login_user(login_data: LoginRequest, db = Depends(get_database)):\n        \"\"\"Login user and return access token\"\"\"\n        logger.info(f\"\ud83d\udd11 Login attempt for username: {login_data.username}\")\n    \n        # Special handling for hardcoded admin account\n        if login_data.username == \"admin\":\n            logger.info(\"\ud83d\udd10 Admin login attempt detected\")\n    \n            # Check hardcoded admin password\n            # In production, this should be stored securely in environment variables\n            ADMIN_PASSWORD = \"admin\"  # Hardcoded admin password\n    \n            if login_data.password == ADMIN_PASSWORD:\n                logger.info(\"\u2705 Admin login successful (hardcoded credentials)\")\n    \n                # Create access token\n                access_token_expires = timedelta(minutes=settings.access_token_expire_minutes)\n                access_token = create_access_token(\n                    data={\"sub\": \"admin\"}, expires_delta=access_token_expires\n                )\n    \n                # Return admin user data\n                return {\n                    \"message\": \"Admin login successful\",\n                    \"user\": {\n                        \"username\": \"admin\",\n                        \"firstName\": \"Admin\",\n                        \"lastName\": \"User\",\n                        \"contactEmail\": \"admin@system.com\",\n                        \"role\": \"admin\"\n                    },\n                    \"access_token\": access_token,\n                    \"token_type\": \"bearer\"\n                }\n            else:\n                logger.warning(\"\u26a0\ufe0f Admin login failed: Invalid password\")\n                raise HTTPException(\n                    status_code=status.HTTP_400_BAD_REQUEST,\n                    detail=\"Invalid credentials\"\n                )\n    \n        # Regular user login)\n    \n        # Find user\n        logger.debug(f\"Looking up user '{login_data.username}' in database...\")\n>       user = await db.users.find_one({\"username\": login_data.username})\nE       TypeError: object MagicMock can't be used in 'await' expression\n\nroutes.py:435: TypeError\n----------------------------- Captured stderr call -----------------------------\n2025-10-15 09:41:14,982 - main - INFO - \ud83d\udce8 Incoming POST request to /api/users/login\n2025-10-15 09:41:14,983 - routes - INFO - \ud83d\udd11 Login attempt for username: testuser\n2025-10-15 09:41:14,984 - main - ERROR - \u274c Error processing POST /api/users/login - Duration: 0.002s - Error: object MagicMock can't be used in 'await' expression\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 435, in login_user\n    user = await db.users.find_one({\"username\": login_data.username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nTypeError: object MagicMock can't be used in 'await' expression\n------------------------------ Captured log call -------------------------------\nINFO     main:main.py:112 \ud83d\udce8 Incoming POST request to /api/users/login\nINFO     routes:routes.py:392 \ud83d\udd11 Login attempt for username: testuser\nERROR    main:main.py:131 \u274c Error processing POST /api/users/login - Duration: 0.002s - Error: object MagicMock can't be used in 'await' expression\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/anyio/streams/memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/main.py\", line 116, in log_requests\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 165, in call_next\n    raise app_exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py\", line 151, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 62, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 762, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 782, in app\n    await route.handle(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 297, in handle\n    await self.app(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 77, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 64, in wrapped_app\n    raise exc\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py\", line 72, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 299, in app\n    raise e\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 294, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/fastapi/routing.py\", line 191, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/routes.py\", line 435, in login_user\n    user = await db.users.find_one({\"username\": login_data.username})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nTypeError: object MagicMock can't be used in 'await' expression\n=============================== warnings summary ===============================\nvenv/lib/python3.12/site-packages/pydantic/_internal/_config.py:271: 13 warnings\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:271: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)\n\nmodels.py:104\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/models.py:104: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('username')\n\nmodels.py:110\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/models.py:110: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('gender')\n\nmodels.py:116\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/models.py:116: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('countryOfOrigin', 'countryOfResidence')\n\nmodels.py:122\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/models.py:122: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('height')\n\nmodels.py:136\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/models.py:136: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('religion')\n\nmodels.py:146\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/models.py:146: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('languagesSpoken')\n\nmodels.py:152\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/models.py:152: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('eatingPreference')\n\nmodels.py:158\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/models.py:158: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('citizenshipStatus')\n\nmodels.py:164\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/models.py:164: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('themePreference')\n\nvenv/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:252: 10 warnings\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:252: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.5/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    warnings.warn(\n\nmodels.py:363\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/models.py:363: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('themePreference')\n\nauth/security_models.py:157\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/security_models.py:157: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('confirm_password')\n\nauth/security_models.py:163\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/security_models.py:163: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('password')\n\nauth/security_models.py:216\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/security_models.py:216: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('confirm_password')\n\nauth/security_models.py:222\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/security_models.py:222: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('new_password')\n\nauth/security_models.py:238\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/security_models.py:238: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/\n    @validator('confirm_password')\n\nvenv/lib/python3.12/site-packages/passlib/utils/__init__.py:854\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13\n    from crypt import crypt as _crypt\n\nvenv/lib/python3.12/site-packages/starlette/routing.py:661\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/starlette/routing.py:661: DeprecationWarning: async generator function lifespans are deprecated, use an @contextlib.asynccontextmanager function instead\n    warnings.warn(\n\ntests/test_search.py:425\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_search.py:425: PytestUnknownMarkWarning: Unknown pytest.mark.slow - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html\n    @pytest.mark.slow\n\ntests/test_search.py:433\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_search.py:433: PytestUnknownMarkWarning: Unknown pytest.mark.slow - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html\n    @pytest.mark.slow\n\ntests/test_auth.py: 2 warnings\ntests/test_auth_module.py: 4 warnings\ntests/test_jwt_timezone.py: 107 warnings\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/jwt_auth.py:28: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    expire = datetime.utcnow() + timedelta(minutes=security_settings.JWT_ACCESS_TOKEN_EXPIRE_MINUTES)\n\ntests/test_auth.py: 3 warnings\ntests/test_auth_module.py: 4 warnings\ntests/test_jwt_timezone.py: 108 warnings\ntests/test_user_status.py: 10 warnings\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/jwt_auth.py:32: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"iat\": datetime.utcnow(),\n\ntests/test_auth.py: 1 warning\ntests/test_jwt_timezone.py: 1 warning\ntests/test_user_status.py: 10 warnings\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/jwt_auth.py:26: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    expire = datetime.utcnow() + expires_delta\n\ntests/test_auth_module.py::TestPasswordManager::test_check_password_in_history\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_auth_module.py:104: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    history = [{\"password_hash\": hashed, \"changed_at\": datetime.utcnow()}]\n\ntests/test_auth_module.py::TestPasswordManager::test_calculate_password_expiry\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_auth_module.py:111: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    now = datetime.utcnow()\n\ntests/test_auth_module.py::TestPasswordManager::test_is_password_expired\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_auth_module.py:119: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    past_date = datetime.utcnow() - timedelta(days=1)\n\ntests/test_auth_module.py::TestPasswordManager::test_is_password_expired\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_auth_module.py:120: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    future_date = datetime.utcnow() + timedelta(days=1)\n\ntests/test_auth_module.py::TestPasswordManager::test_is_password_expired\ntests/test_auth_module.py::TestPasswordManager::test_is_password_expired\ntests/test_auth_module.py::TestPasswordPolicyIntegration::test_password_expiry_workflow\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/password_utils.py:53: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    return datetime.utcnow() >= expires_at\n\ntests/test_auth_module.py::TestAccountLockoutManager::test_calculate_lockout_until\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_auth_module.py:146: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    now = datetime.utcnow()\n\ntests/test_auth_module.py::TestAccountLockoutManager::test_calculate_lockout_until\ntests/test_auth_module.py::TestAccountLockoutIntegration::test_failed_login_workflow\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/password_utils.py:130: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    return datetime.utcnow() + timedelta(minutes=security_settings.ACCOUNT_LOCKOUT_DURATION_MINUTES)\n\ntests/test_auth_module.py::TestAccountLockoutManager::test_is_account_locked\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_auth_module.py:154: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    past_date = datetime.utcnow() - timedelta(minutes=1)\n\ntests/test_auth_module.py::TestAccountLockoutManager::test_is_account_locked\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_auth_module.py:155: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    future_date = datetime.utcnow() + timedelta(minutes=30)\n\ntests/test_auth_module.py::TestAccountLockoutManager::test_is_account_locked\ntests/test_auth_module.py::TestAccountLockoutManager::test_is_account_locked\ntests/test_auth_module.py::TestAccountLockoutIntegration::test_failed_login_workflow\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/password_utils.py:137: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    return datetime.utcnow() < locked_until\n\ntests/test_auth_module.py::TestTokenManager::test_calculate_token_expiry\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_auth_module.py:182: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    now = datetime.utcnow()\n\ntests/test_auth_module.py::TestTokenManager::test_calculate_token_expiry\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/password_utils.py:165: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    return datetime.utcnow() + timedelta(hours=hours)\n\ntests/test_auth_module.py::TestTokenManager::test_is_token_expired\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_auth_module.py:190: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    past_date = datetime.utcnow() - timedelta(hours=1)\n\ntests/test_auth_module.py::TestTokenManager::test_is_token_expired\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_auth_module.py:191: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    future_date = datetime.utcnow() + timedelta(hours=24)\n\ntests/test_auth_module.py::TestTokenManager::test_is_token_expired\ntests/test_auth_module.py::TestTokenManager::test_is_token_expired\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/password_utils.py:170: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    return datetime.utcnow() >= expires_at\n\ntests/test_auth_module.py::TestJWTManager::test_create_refresh_token\ntests/test_auth_module.py::TestJWTManager::test_verify_token_type\ntests/test_auth_module.py::TestJWTManager::test_create_token_pair\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/jwt_auth.py:48: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    expire = datetime.utcnow() + timedelta(days=security_settings.JWT_REFRESH_TOKEN_EXPIRE_DAYS)\n\ntests/test_auth_module.py::TestJWTManager::test_create_refresh_token\ntests/test_auth_module.py::TestJWTManager::test_verify_token_type\ntests/test_auth_module.py::TestJWTManager::test_create_token_pair\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/jwt_auth.py:52: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"iat\": datetime.utcnow(),\n\ntests/test_auth_module.py: 3 warnings\ntests/test_jwt_timezone.py: 8 warnings\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/jose/jwt.py:311: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    now = timegm(datetime.utcnow().utctimetuple())\n\ntests/test_auth_module.py::TestAuditLogger::test_log_event\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/audit_logger.py:43: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"timestamp\": datetime.utcnow(),\n\ntests/test_auth_module.py::TestPasswordPolicyIntegration::test_password_expiry_workflow\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_auth_module.py:383: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    changed_at = datetime.utcnow()\n\ntests/test_auth_module.py::TestPasswordPolicyIntegration::test_password_expiry_workflow\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/password_utils.py:47: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    delta = expires_at - datetime.utcnow()\n\ntests/test_auth_module.py::TestPasswordPolicyIntegration::test_password_history_workflow\ntests/test_auth_module.py::TestPasswordPolicyIntegration::test_password_history_workflow\ntests/test_auth_module.py::TestPasswordPolicyIntegration::test_password_history_workflow\ntests/test_auth_module.py::TestPasswordPolicyIntegration::test_password_history_workflow\ntests/test_auth_module.py::TestPasswordPolicyIntegration::test_password_history_workflow\ntests/test_auth_module.py::TestPasswordPolicyIntegration::test_password_history_workflow\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/auth/password_utils.py:108: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"changed_at\": datetime.utcnow()\n\ntests/test_database.py::TestCloseMongoConnection::test_close_mongo_connection_with_client\ntests/test_database.py::TestCloseMongoConnection::test_close_mongo_connection_client_close_exception\ntests/test_database.py::TestDatabaseIntegration::test_full_connection_lifecycle\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/database.py:29: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited\n    client.close()\n  Enable tracemalloc to get traceback where the object was allocated.\n  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.\n\ntests/test_e2e_api.py::test_api_error_scenarios\ntests/test_routes_integration.py::TestErrorHandling::test_invalid_json_payload\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/httpx/_content.py:204: DeprecationWarning: Use 'content=<...>' to upload raw bytes/text content.\n    warnings.warn(message, DeprecationWarning)\n\ntests/test_messages.py::TestMessagePrivacy::test_send_message_to_blocked_user_marked_invisible\ntests/test_messages.py::TestMessagePrivacy::test_send_message_from_blocked_user_marked_invisible\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py:148: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow()\n\ntests/test_messages.py::TestGetConversation::test_get_conversation_success\ntests/test_messages.py::TestGetConversation::test_get_conversation_sorted_chronologically\ntests/test_messages.py::TestGetConversation::test_get_conversation_marks_messages_as_read\ntests/test_messages.py::TestGetConversation::test_get_conversation_includes_other_user_profile\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py:195: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow() - timedelta(minutes=5)\n\ntests/test_messages.py::TestGetConversation::test_get_conversation_success\ntests/test_messages.py::TestGetConversation::test_get_conversation_sorted_chronologically\ntests/test_messages.py::TestGetConversation::test_get_conversation_marks_messages_as_read\ntests/test_messages.py::TestGetConversation::test_get_conversation_includes_other_user_profile\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py:203: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow() - timedelta(minutes=3)\n\ntests/test_messages.py::TestGetConversation::test_get_conversation_success\ntests/test_messages.py::TestGetConversation::test_get_conversation_sorted_chronologically\ntests/test_messages.py::TestGetConversation::test_get_conversation_marks_messages_as_read\ntests/test_messages.py::TestGetConversation::test_get_conversation_includes_other_user_profile\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py:211: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow()\n\ntests/test_messages.py::TestGetConversations::test_get_conversations_success\ntests/test_messages.py::TestGetConversations::test_get_conversations_sorted_by_recent\ntests/test_messages.py::TestGetConversations::test_get_conversations_includes_unread_count\ntests/test_messages.py::TestGetConversations::test_get_conversations_includes_last_message\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py:284: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow() - timedelta(hours=1)\n\ntests/test_messages.py::TestGetConversations::test_get_conversations_success\ntests/test_messages.py::TestGetConversations::test_get_conversations_sorted_by_recent\ntests/test_messages.py::TestGetConversations::test_get_conversations_includes_unread_count\ntests/test_messages.py::TestGetConversations::test_get_conversations_includes_last_message\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py:292: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow() - timedelta(minutes=30)\n\ntests/test_messages.py::TestGetConversations::test_get_conversations_success\ntests/test_messages.py::TestGetConversations::test_get_conversations_sorted_by_recent\ntests/test_messages.py::TestGetConversations::test_get_conversations_includes_unread_count\ntests/test_messages.py::TestGetConversations::test_get_conversations_includes_last_message\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py:300: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow()\n\ntests/test_messages.py::TestAdminOverride::test_admin_can_see_blocked_messages\ntests/test_messages.py::TestAdminOverride::test_regular_user_cannot_see_blocked_messages\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py:368: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow()\n\ntests/test_messages.py::TestAdminOverride::test_admin_can_see_blocked_messages\ntests/test_messages.py::TestAdminOverride::test_regular_user_cannot_see_blocked_messages\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_messages.py:379: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow()\n\ntests/test_models.py::TestUserInDB::test_valid_user_in_db\ntests/test_models.py::TestUserInDB::test_valid_user_in_db\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/pydantic/main.py:164: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    __pydantic_self__.__pydantic_validator__.validate_python(data, self_instance=__pydantic_self__)\n\ntests/test_models.py::TestUserResponse::test_valid_user_response\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_models.py:135: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow(),\n\ntests/test_models.py::TestUserResponse::test_valid_user_response\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_models.py:136: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"updatedAt\": datetime.utcnow()\n\ntests/test_pii_security.py::TestCheckAccessGranted::test_check_access_granted_admin\ntests/test_pii_security.py::TestCheckAccessGranted::test_check_access_granted_approved_request\ntests/test_pii_security.py::TestCheckAccessGranted::test_check_access_granted_denied_request\ntests/test_pii_security.py::TestCheckAccessGranted::test_check_access_granted_no_request\ntests/test_pii_security.py::TestCheckAccessGranted::test_check_access_granted_db_error\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py:145: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited\n    if requester.get('role_name') == 'admin' or requester_id == 'admin':\n  Enable tracemalloc to get traceback where the object was allocated.\n  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.\n\ntests/test_pii_security.py::TestCreateAccessRequest::test_create_access_request_new\ntests/test_pii_security.py::TestCreateAccessRequest::test_create_access_request_existing_denied\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py:192: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    'requestDate': datetime.utcnow().isoformat(),\n\ntests/test_pii_security.py::TestRespondToAccessRequest::test_respond_to_access_request_approve\ntests/test_pii_security.py::TestRespondToAccessRequest::test_respond_to_access_request_deny\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/pii_security.py:230: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    'responseDate': datetime.utcnow().isoformat()\n\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_success\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_includes_viewer_details\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_sorted_by_recent\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_with_limit\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_profile_views.py:173: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"viewedAt\": datetime.utcnow(),\n\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_success\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_includes_viewer_details\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_sorted_by_recent\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_with_limit\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_profile_views.py:174: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow()\n\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_success\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_includes_viewer_details\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_sorted_by_recent\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_with_limit\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_profile_views.py:179: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"viewedAt\": datetime.utcnow() - timedelta(hours=2),\n\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_success\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_includes_viewer_details\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_sorted_by_recent\ntests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_with_limit\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_profile_views.py:180: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow() - timedelta(hours=2)\n\ntests/test_profile_views.py::TestProfileViewCount::test_get_view_count_success\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_profile_views.py:252: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"viewedAt\": datetime.utcnow(),\n\ntests/test_profile_views.py::TestProfileViewCount::test_get_view_count_success\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_profile_views.py:253: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow()\n\ntests/test_profile_views.py::TestProfileViewCount::test_get_view_count_success\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_profile_views.py:258: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"viewedAt\": datetime.utcnow() - timedelta(days=2),\n\ntests/test_profile_views.py::TestProfileViewCount::test_get_view_count_success\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_profile_views.py:259: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow() - timedelta(days=2)\n\ntests/test_profile_views.py::TestProfileViewCount::test_get_view_count_success\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_profile_views.py:264: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"viewedAt\": datetime.utcnow(),\n\ntests/test_profile_views.py::TestProfileViewCount::test_get_view_count_success\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_profile_views.py:265: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow()\n\ntests/test_user_interactions.py::TestGetTheirFavorites::test_get_their_favorites\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py:253: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow()\n\ntests/test_user_interactions.py::TestGetTheirFavorites::test_get_their_favorites\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py:258: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow()\n\ntests/test_user_interactions.py::TestGetTheirShortlists::test_get_their_shortlists\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_interactions.py:289: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"createdAt\": datetime.utcnow()\n\ntests/test_user_status.py::TestUserStatusField::test_status_field_structure\ntests/test_user_status.py::TestUserActivation::test_admin_can_activate_pending_user\ntests/test_user_status.py::TestMenuAccessControl::test_pending_user_login_returns_status\ntests/test_user_status.py::TestMenuAccessControl::test_pending_user_limited_access\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_status.py:45: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"updatedAt\": datetime.utcnow().isoformat(),\n\ntests/test_user_status.py::TestMenuAccessControl::test_active_user_has_full_access\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/tests/test_user_status.py:62: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n    \"updatedAt\": datetime.utcnow().isoformat(),\n\ntests/test_utils.py::TestSaveUploadFile::test_save_upload_file_success\ntests/test_utils.py::TestSaveUploadFile::test_save_upload_file_no_extension\ntests/test_utils.py::TestSaveUploadFile::test_save_upload_file_creates_directory\ntests/test_utils.py::TestSaveUploadFile::test_save_upload_file_exception_handling\ntests/test_utils.py::TestSaveMultipleFiles::test_save_multiple_files_success\ntests/test_utils.py::TestSaveMultipleFiles::test_save_multiple_files_mixed_types\ntests/test_utils.py::TestSaveMultipleFiles::test_save_multiple_files_size_limit\ntests/test_utils.py::TestSaveMultipleFiles::test_save_multiple_files_partial_failure\ntests/test_utils.py::TestSaveMultipleFiles::test_save_multiple_files_empty_list\n  /Users/rajsiripuram02/opt/appsrc/profiledata/fastapi_backend/venv/lib/python3.12/site-packages/_pytest/python.py:182: PytestUnhandledCoroutineWarning: async def functions are not natively supported and have been skipped.\n  You need to install a suitable plugin for your async framework, for example:\n    - anyio\n    - pytest-asyncio\n    - pytest-tornasync\n    - pytest-trio\n    - pytest-twisted\n    warnings.warn(PytestUnhandledCoroutineWarning(msg.format(nodeid)))\n\n-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html\n=========================== short test summary info ============================\nFAILED tests/test_auth.py::TestJWTTokenFunctions::test_create_access_token_with_custom_settings\nFAILED tests/test_auth.py::TestGetCurrentUser::test_get_current_user_valid_token\nFAILED tests/test_auth.py::TestGetCurrentUser::test_get_current_user_invalid_token\nFAILED tests/test_auth.py::TestGetCurrentUser::test_get_current_user_expired_token\nFAILED tests/test_auth.py::TestGetCurrentUser::test_get_current_user_no_sub\nFAILED tests/test_auth.py::TestGetCurrentUser::test_get_current_user_wrong_secret\nFAILED tests/test_auth.py::TestIntegrationScenarios::test_full_authentication_flow\nFAILED tests/test_auth.py::TestIntegrationScenarios::test_password_security_edge_cases\nFAILED tests/test_auth_module.py::TestPasswordPolicyIntegration::test_password_expiry_workflow\nFAILED tests/test_e2e_api.py::test_full_user_lifecycle - assert 422 == 201\nFAILED tests/test_e2e_api.py::test_pii_masking_workflow - RuntimeError: Task ...\nFAILED tests/test_e2e_api.py::test_search_and_filtering - assert 500 == 200\nFAILED tests/test_e2e_api.py::test_concurrent_requests - RuntimeError: Task <...\nFAILED tests/test_e2e_api.py::test_cors_headers - assert 405 == 200\nFAILED tests/test_jwt_timezone.py::TestTokenRefresh::test_refresh_token_extends_expiry\nFAILED tests/test_messages.py::TestSendMessage::test_send_message_success - R...\nFAILED tests/test_messages.py::TestSendMessage::test_send_message_to_nonexistent_user\nFAILED tests/test_messages.py::TestSendMessage::test_send_message_trims_whitespace\nFAILED tests/test_messages.py::TestMessagePrivacy::test_send_message_to_blocked_user_marked_invisible\nFAILED tests/test_messages.py::TestMessagePrivacy::test_send_message_from_blocked_user_marked_invisible\nFAILED tests/test_messages.py::TestGetConversation::test_get_conversation_success\nFAILED tests/test_messages.py::TestGetConversation::test_get_conversation_sorted_chronologically\nFAILED tests/test_messages.py::TestGetConversation::test_get_conversation_marks_messages_as_read\nFAILED tests/test_messages.py::TestGetConversation::test_get_conversation_includes_other_user_profile\nFAILED tests/test_messages.py::TestGetConversation::test_get_conversation_empty\nFAILED tests/test_messages.py::TestGetConversations::test_get_conversations_success\nFAILED tests/test_messages.py::TestGetConversations::test_get_conversations_sorted_by_recent\nFAILED tests/test_messages.py::TestGetConversations::test_get_conversations_includes_unread_count\nFAILED tests/test_messages.py::TestGetConversations::test_get_conversations_includes_last_message\nFAILED tests/test_messages.py::TestGetConversations::test_get_conversations_empty\nFAILED tests/test_messages.py::TestAdminOverride::test_admin_can_see_blocked_messages\nFAILED tests/test_messages.py::TestAdminOverride::test_regular_user_cannot_see_blocked_messages\nFAILED tests/test_messages.py::TestMessageEdgeCases::test_send_message_special_characters\nFAILED tests/test_messages.py::TestMessageEdgeCases::test_get_conversation_nonexistent_user\nFAILED tests/test_messages.py::TestMessageIntegration::test_full_conversation_workflow\nFAILED tests/test_messages.py::TestMessageIntegration::test_block_user_hides_messages\nFAILED tests/test_models.py::TestUserBase::test_valid_user_base_creation - py...\nFAILED tests/test_models.py::TestUserBase::test_sex_validation - pydantic_cor...\nFAILED tests/test_models.py::TestUserBase::test_eating_preference_validation\nFAILED tests/test_models.py::TestUserBase::test_citizenship_status_validation\nFAILED tests/test_models.py::TestUserCreate::test_valid_user_create - pydanti...\nFAILED tests/test_models.py::TestUserInDB::test_valid_user_in_db - pydantic_c...\nFAILED tests/test_models.py::TestUserResponse::test_valid_user_response - pyd...\nFAILED tests/test_profile_views.py::TestProfileViewTracking::test_track_profile_view_success\nFAILED tests/test_profile_views.py::TestProfileViewTracking::test_track_self_view_ignored\nFAILED tests/test_profile_views.py::TestProfileViewTracking::test_track_view_nonexistent_profile\nFAILED tests/test_profile_views.py::TestProfileViewTracking::test_track_view_nonexistent_viewer\nFAILED tests/test_profile_views.py::TestProfileViewTracking::test_duplicate_view_within_24h_updates_timestamp\nFAILED tests/test_profile_views.py::TestProfileViewTracking::test_multiple_viewers_tracked_separately\nFAILED tests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_success\nFAILED tests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_includes_viewer_details\nFAILED tests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_sorted_by_recent\nFAILED tests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_with_limit\nFAILED tests/test_profile_views.py::TestGetProfileViews::test_get_profile_views_empty\nFAILED tests/test_profile_views.py::TestProfileViewCount::test_get_view_count_success\nFAILED tests/test_profile_views.py::TestProfileViewCount::test_get_view_count_no_views\nFAILED tests/test_profile_views.py::TestProfileViewIntegration::test_full_profile_view_workflow\nFAILED tests/test_profile_views.py::TestProfileViewIntegration::test_multiple_profiles_isolated\nFAILED tests/test_profile_views.py::TestProfileViewEdgeCases::test_invalid_username_format\nFAILED tests/test_profile_views.py::TestProfileViewEdgeCases::test_missing_required_fields\nFAILED tests/test_profile_views.py::TestProfileViewEdgeCases::test_get_views_invalid_limit\nFAILED tests/test_profile_views.py::TestProfileViewEdgeCases::test_get_views_excessive_limit\nFAILED tests/test_routes_integration.py::TestUserRegistration::test_register_user_success\nFAILED tests/test_routes_integration.py::TestUserRegistration::test_register_user_duplicate_username\nFAILED tests/test_routes_integration.py::TestUserRegistration::test_register_user_duplicate_email\nFAILED tests/test_routes_integration.py::TestUserRegistration::test_register_user_too_many_images\nFAILED tests/test_routes_integration.py::TestUserLogin::test_login_success - ...\nFAILED tests/test_routes_integration.py::TestUserLogin::test_login_invalid_credentials\nFAILED tests/test_routes_integration.py::TestUserLogin::test_login_admin_success\nFAILED tests/test_routes_integration.py::TestUserProfile::test_get_user_profile_own\nFAILED tests/test_routes_integration.py::TestUserProfile::test_get_user_profile_other_user\nFAILED tests/test_routes_integration.py::TestUserProfile::test_get_user_profile_not_found\nFAILED tests/test_routes_integration.py::TestUserProfile::test_update_user_profile\nFAILED tests/test_routes_integration.py::TestSearch::test_search_users_basic\nFAILED tests/test_routes_integration.py::TestSearch::test_search_users_with_filters\nFAILED tests/test_routes_integration.py::TestSearch::test_search_users_pagination\nFAILED tests/test_routes_integration.py::TestAdminEndpoints::test_get_all_users_admin\nFAILED tests/test_routes_integration.py::TestAccessRequests::test_create_access_request\nFAILED tests/test_routes_integration.py::TestAccessRequests::test_create_duplicate_access_request\nFAILED tests/test_routes_integration.py::TestAccessRequests::test_get_access_requests\nFAILED tests/test_routes_integration.py::TestFavorites::test_add_to_favorites\nFAILED tests/test_routes_integration.py::TestFavorites::test_add_duplicate_to_favorites\nFAILED tests/test_routes_integration.py::TestFavorites::test_get_favorites - ...\nFAILED tests/test_routes_integration.py::TestMessaging::test_send_message - R...\nFAILED tests/test_routes_integration.py::TestMessaging::test_get_messages - R...\nFAILED tests/test_search.py::TestKeywordSearch::test_search_by_first_name - N...\nFAILED tests/test_search.py::TestKeywordSearch::test_search_by_last_name - Na...\nFAILED tests/test_search.py::TestKeywordSearch::test_search_by_location - Nam...\nFAILED tests/test_search.py::TestKeywordSearch::test_search_case_insensitive\nFAILED tests/test_search.py::TestKeywordSearch::test_search_partial_match - N...\nFAILED tests/test_search.py::TestAgeRangeSearch::test_search_by_age_range - N...\nFAILED tests/test_search.py::TestAgeRangeSearch::test_search_by_min_age_only\nFAILED tests/test_search.py::TestAgeRangeSearch::test_search_by_max_age_only\nFAILED tests/test_search.py::TestAgeRangeSearch::test_search_invalid_age_range\nFAILED tests/test_search.py::TestHeightRangeSearch::test_search_by_height_range\nFAILED tests/test_search.py::TestHeightRangeSearch::test_search_by_min_height_only\nFAILED tests/test_search.py::TestHeightRangeSearch::test_search_by_max_height_only\nFAILED tests/test_search.py::TestGenderSearch::test_search_by_gender_male - N...\nFAILED tests/test_search.py::TestGenderSearch::test_search_by_gender_female\nFAILED tests/test_search.py::TestLocationSearch::test_search_by_exact_location\nFAILED tests/test_search.py::TestLocationSearch::test_search_by_city_only - N...\nFAILED tests/test_search.py::TestEducationOccupationSearch::test_search_by_education\nFAILED tests/test_search.py::TestEducationOccupationSearch::test_search_by_occupation\nFAILED tests/test_search.py::TestReligionEatingPreference::test_search_by_religion\nFAILED tests/test_search.py::TestReligionEatingPreference::test_search_by_eating_preference\nFAILED tests/test_search.py::TestMultipleFilters::test_search_with_multiple_filters\nFAILED tests/test_search.py::TestMultipleFilters::test_search_keyword_with_filters\nFAILED tests/test_search.py::TestMultipleFilters::test_search_all_filters_combined\nFAILED tests/test_search.py::TestPagination::test_search_with_pagination - Na...\nFAILED tests/test_search.py::TestPagination::test_search_page_2 - NameError: ...\nFAILED tests/test_search.py::TestPagination::test_search_different_page_sizes\nFAILED tests/test_search.py::TestPagination::test_search_invalid_page_number\nFAILED tests/test_search.py::TestEmptyResults::test_search_no_matches - NameE...\nFAILED tests/test_search.py::TestEmptyResults::test_search_impossible_filters\nFAILED tests/test_search.py::TestSearchPerformance::test_search_with_many_results\nFAILED tests/test_search.py::TestSearchPerformance::test_complex_search_performance\nFAILED tests/test_search.py::TestSearchEdgeCases::test_search_with_special_characters\nFAILED tests/test_search.py::TestSearchEdgeCases::test_search_with_very_long_keyword\nFAILED tests/test_search.py::TestSearchEdgeCases::test_search_with_sql_injection_attempt\nFAILED tests/test_search.py::TestSearchEdgeCases::test_search_with_empty_parameters\nFAILED tests/test_search.py::TestSearchIntegration::test_search_to_profile_view_workflow\nFAILED tests/test_user_interactions.py::TestFavorites::test_add_to_favorites_success\nFAILED tests/test_user_interactions.py::TestFavorites::test_add_to_favorites_nonexistent_user\nFAILED tests/test_user_interactions.py::TestFavorites::test_add_self_to_favorites\nFAILED tests/test_user_interactions.py::TestFavorites::test_duplicate_favorite\nFAILED tests/test_user_interactions.py::TestFavorites::test_remove_from_favorites_success\nFAILED tests/test_user_interactions.py::TestFavorites::test_remove_nonexistent_favorite\nFAILED tests/test_user_interactions.py::TestFavorites::test_get_favorites_list\nFAILED tests/test_user_interactions.py::TestShortlist::test_add_to_shortlist_success\nFAILED tests/test_user_interactions.py::TestShortlist::test_remove_from_shortlist_success\nFAILED tests/test_user_interactions.py::TestShortlist::test_get_shortlist - R...\nFAILED tests/test_user_interactions.py::TestShortlist::test_duplicate_shortlist\nFAILED tests/test_user_interactions.py::TestExclusions::test_add_to_exclusions_success\nFAILED tests/test_user_interactions.py::TestExclusions::test_remove_from_exclusions_success\nFAILED tests/test_user_interactions.py::TestExclusions::test_get_exclusions_list\nFAILED tests/test_user_interactions.py::TestExclusions::test_exclusion_affects_search_results\nFAILED tests/test_user_interactions.py::TestGetTheirFavorites::test_get_their_favorites\nFAILED tests/test_user_interactions.py::TestGetTheirShortlists::test_get_their_shortlists\nFAILED tests/test_user_interactions.py::TestCrossFeatureInteractions::test_favorite_and_shortlist_same_user\nFAILED tests/test_user_interactions.py::TestCrossFeatureInteractions::test_favorite_then_exclude\nFAILED tests/test_user_interactions.py::TestCrossFeatureInteractions::test_exclude_removes_from_search\nFAILED tests/test_user_interactions.py::TestInteractionEdgeCases::test_multiple_users_favorite_same_profile\nFAILED tests/test_user_interactions.py::TestInteractionEdgeCases::test_bidirectional_favorites\nFAILED tests/test_user_interactions.py::TestInteractionEdgeCases::test_remove_all_interactions\nFAILED tests/test_user_status.py::TestUserActivation::test_admin_can_activate_pending_user\nFAILED tests/test_user_status.py::TestMenuAccessControl::test_pending_user_login_returns_status\n146 failed, 256 passed, 9 skipped, 426 warnings in 43.32s\n",
  "error": ""
}